---
title: "DVEP Data Analysis"
project: "Effect of Eclipta prostrata (L.) L. (Asteraceae) on bioelectrical impedance phase angle in adults with grade I obesity (DVEP)"
PID: "REDCap 1958"
author: "Gustavo Santos Paiva Laender Moura"
date: "2025-01-05"
output: html_document
---

# Data wrangling

## Getting started with R

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 1. Getting started with R
## Clear existing data and graphics
rm(list = ls())
graphics.off()
cat("\014")  # Clear any pending RStudio sessions or temporary files

## Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(purrr)


## Set working directory
setwd("/Users/gustavosplmoura/Library/Mobile Documents/com~apple~CloudDocs/Medicina/Biblioteca/Research/Data Science/Data Science/PROJECTS/DVEP")
```

## Read CSV data files (Tidyverse)

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 2. Read CSV data files (Tidyverse)
data_codebook <- read_excel(
        "data_codebook.xlsx",
        col_names = TRUE,
        col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) |>
    arrange(index)

data_bia_codebook <- read_excel(
    "data_bia_codebook.xlsx",
    col_names = TRUE,
    col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) |>
    arrange(index)

data_structure  <- read_csv(
  "data_structure.csv",
  col_names = TRUE) |> 
    select(
        form_name_en:V3
    )

data_NCIT  <- read_csv(
  "data_NCIT.csv",
  col_names = TRUE)

data  <- read_csv(
  "data_dvep.csv",
  col_names = TRUE,
  col_types = NULL,
  col_select = NULL,
  id = NULL,
  locale = default_locale(),
  na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
  quote = "\"",
  comment = "",
  trim_ws = TRUE,
  skip = 0, # Number of lines to skip before reading data
  n_max = Inf, # Maximum number of lines to read.
  guess_max = 1000,
  name_repair = "unique",
  num_threads = readr_threads(),
  progress = show_progress(),
  show_col_types = TRUE,
  skip_empty_rows = TRUE,
  lazy = should_read_lazy()
)

data_bia_D3 <- read_csv(
    "data_bia_D3.csv",
    col_names = TRUE)

data_bia_D1 <- read_csv(
    "data_bia_D1.csv",
    col_names = TRUE)
```

## Remove identifying data from record_id

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 3. Remove identifying data from record_id
data$record_id <- substr(data$record_id,1,2)
data_bia_D3 $File <- substr(data_bia_D3 $File,1,2)
data_bia_D1$File <- substr(data_bia_D1$File,1,2)
```

## Renaming variables

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 4. Renaming variables
# 4.1 data
rename_data <- setNames(object = colnames(data), data_codebook$variable)
data <- data |>
    rename(!!!rename_data)

rm(rename_data)

# 4.2 bia
rename_bia <- setNames(object = colnames(data_bia_D3 ), data_bia_codebook$variable)

data_bia_D3 <- data_bia_D3 |>
    rename(!!!rename_bia)

data_bia_D1 <- data_bia_D1 |>
    rename(!!!rename_bia)

rm(rename_bia)
```

## record_id as.integer

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 5. record_id as.integer
data$record_id <- as.integer(data$record_id)
data_bia_D3 $record_id <- as.integer(data_bia_D3 $record_id)
data_bia_D1$record_id <- as.integer(data_bia_D1$record_id)
```

## Assign labels to variables

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 6. Assign labels to variables with base R attr()
data <- data |> 
  mutate(across(
    all_of(data_codebook$variable),
    ~ {
      attr(., "label") <- data_codebook$label_pt[data_codebook$variable == cur_column()]
      .
    }
  ))

data_bia_D3 <- data_bia_D3 |> 
  mutate(across(
    all_of(data_bia_codebook$variable),
    ~ {
      attr(., "label") <- data_bia_codebook$label_pt[data_bia_codebook$variable == cur_column()]
      .
    }
  ))
```

## Creating functions

### filter_variables()

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 7.1 filter_variables() based on visit, repeating instrument and form
filter_variables <- function(visit = c("eleg", "V1", "V2", "V3"), include_repeating = NULL, form_name = NULL) {
  
  # Ensure the visit input is valid
  if (!all(visit %in% c("eleg", "V1", "V2", "V3"))) {
    stop("Invalid visit name. Choose from 'eleg', 'V1', 'V2', or 'V3'.")
  }
  
  # Ensure the form_name input is valid
  valid_form_names <- c("eleg", "demographic", "whoqol", "dass", "ecap", "measures", "bp_limb", "bp", 
                        "bia", "handgrip", "eliminations", "evs", "alcohol", "tobacco", "diet_recall", 
                        "intake", "dates", "allocation", "conditions", "drugs", "old.drugs", "history", "symptoms", 
                        "phy.exam", "labs", "ecg", "compliance", "events", "medical", "followup", "conclusion")
  if (!is.null(form_name) && !all(form_name %in% valid_form_names)) {
    stop("Invalid form_name. Choose from: ", paste(valid_form_names, collapse = ", "))
  }
  
  # Filter codebook for included variables, by visit, form, and repeating instrument status if specified
  filtered_codebook <- data_codebook %>% 
    filter(
      included == 1, 
      rowSums(select(., all_of(visit))) > 0,  # At least one of the selected visits should have a 1
      if (!is.null(include_repeating)) repeating_instrument == include_repeating else TRUE,
      if (!is.null(form_name)) form_name_en == form_name else TRUE
    )
  
  # Return the filtered variable names
  filtered_vars <- filtered_codebook$variable
  
  return(filtered_vars)
}
```

### filter_data()

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 7.2 filter_data() based on visit, repeating instrument and form
filter_data <- function(visit = c("eleg", "V1", "V2", "V3"), include_repeating = NULL, form_name = NULL) {
  
  # Map visit names to actual event_name values
  mapped_visits <- case_when(
    visit == "eleg" ~ "eleg_arm_1",
    visit == "V1" ~ "1visit_arm_1",
    visit == "V2" ~ "2visit_arm_1",
    visit == "V3" ~ "3visit_arm_1",
    TRUE ~ visit
  )
  
  # Map form_name to repeat_instrument values using a case_when structure
  mapped_form_name <- if (!is.null(form_name)) {
    case_when(
      form_name == "eleg" ~ "elegibilidade",
      form_name == "demographic" ~ "dados_demogrficos",
      form_name == "whoqol" ~ "questionrio_qualidade_de_vida",
      form_name == "dass" ~ "escore_de_depresso_ansiedade_e_estresse",
      form_name == "ecap" ~ "escala_de_compulso_alimentar",
      form_name == "measures" ~ "antropometria",
      form_name == "bp_limb" ~ "presso_arterial_determinao_do_membro_de_referncia",
      form_name == "bp" ~ "presso_arterial",
      form_name == "bia" ~ "impedncia_bioeltrica_corporal",
      form_name == "handgrip" ~ "fora_de_preenso_palmar",
      form_name == "eliminations" ~ "avaliao_nutricional",
      # form_name == "allergies" ~ "alergia_alimentar",
      form_name == "evs" ~ "exercise_vital_sign",
      form_name == "alcohol" ~ "consumo_alcool",
      form_name == "tobacco" ~ "consumo_tabaco",
      form_name == "diet_recall" ~ "recordatrio_alimentar",
      form_name == "intake" ~ "avaliao_da_ingesto_alimentar",
      form_name == "dates" ~ "datas_importantes",
      form_name == "allocation" ~ "nmero_do_participante",
      form_name == "conditions" ~ "comorbidades",
      form_name == "drugs" ~ "medicamentos_de_uso_habitual",
      form_name == "old.drugs" ~ "medicamentos_prvios",
      form_name == "history" ~ "antecedentes_pessoais",
      form_name == "symptoms" ~ "sintomas",
      form_name == "phy.exam" ~ "exame_fsico",
      form_name == "labs" ~ "exames_laboratoriais",
      form_name == "ecg" ~ "eletrocardiograma",
      form_name == "compliance" ~ "adeso",
      form_name == "events" ~ "eventos_adversos",
      form_name == "medical" ~ "avaliao_mdica",
      form_name == "followup" ~ "contato_semanal",
      form_name == "conclusion" ~ "concluso",
      # form_name == "annex" ~ "anexos",
      TRUE ~ form_name
    )
  } else {
    NULL
  }
  
  # Get the filtered variable names using the filter_variables function
  filtered_vars <- filter_variables(visit, include_repeating, form_name)
  
  # Filter the raw data to only include these columns and match event_name and form_name
  filtered_data <- data %>% 
    filter(event_name %in% mapped_visits) %>%
    filter(if (!is.null(include_repeating) && include_repeating == 0) is.na(repeat_instrument) | repeat_instrument == "" else TRUE) %>%
    filter(if (!is.null(include_repeating) && include_repeating == 1) !is.na(repeat_instrument) & repeat_instrument != "" else TRUE) %>%
    filter(if (!is.null(mapped_form_name)) repeat_instrument == mapped_form_name else TRUE) %>%
    select(record_id, event_name, repeat_instrument, repeat_instance, all_of(filtered_vars)) %>%
    mutate(
      repeat_instrument = ifelse(is.na(repeat_instrument), "", repeat_instrument),
      repeat_instance = ifelse(repeat_instrument == "", NA, repeat_instance)
    )
  
  return(filtered_data)
}
```

### filter_codebook()

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 7.3 filter_codebook()
filter_codebook <- function(form_name = c(
    "eleg", "demographic", "whoqol", "dass", "ecap", "measures", "bp_limb", "bp", "bia", "handgrip", "eliminations", "evs", "alcohol", "tobacco", "diet_recall", "intake", "dates", "allocation", "conditions", "drugs", "old.drugs", "history", "symptoms", "phy.exam", "labs", "ecg", "compliance", "events", "medical", "followup", "conclusion", "annex"), included = 1) {
    
    # Ensure input is valid
    if (!all(form_name %in% c("eleg", "demographic", "whoqol", "dass", "ecap", "measures", "bp_limb", "bp", "bia", "handgrip", "eliminations", "evs", "alcohol", "tobacco", "diet_recall", "intake", "dates", "allocation", "conditions", "drugs", "old.drugs", "history", "symptoms", "phy.exam", "labs", "ecg", "compliance", "events", "medical", "followup", "conclusion", "annex"))) {
      stop("Invalid form name. Choose from 'eleg', 'demographic', 'whoqol', 'dass', 'ecap', 'measures', 'bp_limb', 'bp', 'bia', 'handgrip', 'eliminations', 'evs', 'alcohol', 'tobacco', 'diet_recall', 'intake', 'dates', 'allocation', 'conditions', 'drugs', 'old.drugs', 'history', 'symptoms', 'phy.exam', 'labs', 'ecg', 'compliance', 'events', 'medical', 'followup', 'conclusion', 'annex'.")
    
    }
    # Filter codebook
    ## codebook_form <- data_codebook |>
    ## filter(form_name_en %in% form_name)
    if (included == 1) {
        codebook_form <- data_codebook |> 
        filter(form_name_en %in% form_name & included == 1)
    } else {
        codebook_form <- data_codebook |> 
        filter(form_name_en %in% form_name)
    }

    view(codebook_form)
}
```

### convert_col_type() and apply to data

-   as.factor(): categorical data where the label (e.g., "6 cápsulas ao dia") is more meaningful than numeric code.
-   binary data (0, Não \| 1, Sim):
    -   Use as.factor() if the "label" (Não or Sim) is important.
    -   Use as.numeric(as.character()) if you're performing mathematical operations (e.g., calculating proportions, averages).
-   For ordinal data (1, Ruim \| 2, Regular \| 3, Boa \| 4, Excelente): use as.factor() with ordered levels (ordered()) if you need to preserve the ranking.

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 7.4 convert_col_type()
convert_col_type <- function(data, codebook = data_codebook) {
    # Nested function to convert a single column
    convert_column <- function(column, type) {
        switch(type,
           f = as.factor(column),                      # Factor
           o = as.factor(column),                      # Factor
           c = as.character(column),                   # Character
           d = as.numeric(column),                     # Numeric
           i = as.integer(column),                     # Integer
           k = lubridate::ymd(column),                 # Date (YYYY-MM-DD)
           t = lubridate::ymd_hms(column),             # Date-Time (YYYY-MM-DD HH:MM:SS)
           h = lubridate::hms(column),                 # Time only (HH:MM:SS)
           n = as.numeric(as.character(column)),       # Coerce to Numeric
           l = as.logical(column),                     # Logical
           D = as.Date(column, format = "%Y-%m-%d"),   # Date with specified format
           T = as.POSIXct(column, format = "%Y-%m-%d %H:%M:%S"),  # Date-Time
           column  # Default (no change)
    )
    }
    # Apply conversion
    data <- data |>
        mutate(
            across(
                .cols = all_of(intersect(colnames(data), codebook$variable)), # Ensures only common variables are processed
                .fns = ~ convert_column(.x, codebook$col_types[which(codebook$variable == cur_column())])
            )
        )
    glimpse(data)
}

convert_col_type(data)
```

### label_variables()

```{r, results = 'hide', message = FALSE, warning = FALSE}
label_variables <- function(data, codebook, language = "pt") {
  # Determine the label column based on the language argument
  label_column <- ifelse(language == "en", "label_en", "label_pt")

  # Ensure column names are consistent
  codebook_vars <- codebook$variable
  codebook_labels <- codebook[[label_column]]

  # Identify common variables in both data and codebook
  common_vars <- intersect(names(data), codebook_vars)

  # Loop through the common variables and assign labels
  for (var in common_vars) {
    label <- codebook_labels[codebook_vars == var]
    attr(data[[var]], "label") <- label
  }

  return(data)
}
```

### label_choices()

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 7.5 label_choices()
label_choices <- function(data, codebook = data_codebook) {
  # Ensure required libraries are loaded
  if (!requireNamespace("dplyr") || !requireNamespace("tidyr") ||
      !requireNamespace("stringr") || !requireNamespace("purrr")) {
    stop("Required libraries: dplyr, tidyr, stringr, purrr")
  }
  
  # 1. Filter codebook for relevant variables with col_types in "f" or "o"
  selected_codebook <- codebook |> 
    filter(
      variable %in% colnames(data) &  # Variables present in data
      col_types %in% c("f", "o")     # col_types in "f" or "o"
    )
  
  # 2. Parse the `choices` column
  parsed_choices <- selected_codebook |>
    rowwise() |> 
    mutate(
      parsed = list(
        str_split(choices, " \\| ") |>   # Split choices by "|"
          unlist() |>
          map(~ str_split_fixed(.x, ", ", 2) |>  # Split by ", " into two columns
            as_tibble(.name_repair = "unique") |>  # Ensure unique column names
            setNames(c("raw_value", "label"))    # Name columns
          ) |>
          bind_rows()  # Combine into a tibble
      )
    ) |>
    select(variable, parsed) |>
    unnest(parsed)  # Expand parsed choices into rows
  
  # 3. Create lookup tables for selected variables
  lookup_tables <- parsed_choices |>
    group_by(variable) |>
    summarize(
      lookup = list(setNames(label, raw_value)), .groups = "drop"
    ) |>
    deframe()
  
  # 4. Replace raw values with labels in data, using "Unmatched" for unmatched values
  for (column_name in names(lookup_tables)) {
    if (column_name %in% colnames(data)) {  # Ensure column exists in data
      data[[column_name]] <- recode(        # Apply recode using the lookup table
        data[[column_name]],
        !!!lookup_tables[[column_name]],
        .default = "Unmatched"             # Set "Unmatched" as the placeholder for unmatched values
      )
    }
  }
  
  # Explicitly return the modified data
  return(data)
}
```

## Bioimpedance data

### D3 DATA

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 8. Wrangling Bioimpedance data
## 8.1 D3 DATA (contains data from first and third visits for participants who completed the intervention)
### Filter lines for which phaseangle is <> ""
data_bia_D3_filtered <- data_bia_D3 |> 
    filter(!is.na(phaseangle)) |> 
    mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) |> 
    select(all_of(data_bia_codebook$variable)[data_bia_codebook$included == 1], date, time) |> 
    relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) |> 
    arrange(record_id, date, time)

### Group by record_id and date and obtain mean of multiple measurements from the same day
data_bia_D3_filtered <- data_bia_D3_filtered |> 
    group_by(record_id, date) |>
    summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) |>
    group_by(record_id) |> # Add coding for visit number
    mutate(
        visit = case_when(
            date == min(date) ~ 1,  # Assign 1 to the earliest date
            date == max(date) ~ 3,  # Assign 3 to the latest date
            TRUE ~ NA_real_         # Default to NA for unexpected cases
        ),
        .after = record_id
    )
```

### D1 DATA

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 8.2 D1 DATA (data from the first visit for participants who did not complete the intervention)
## Filter lines for which phaseangle is <> ""
data_bia_D1_filtered <- data_bia_D1 |> 
    filter(!is.na(phaseangle)) |> 
    mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) |> 
    select(all_of(data_bia_codebook$variable)[data_bia_codebook$included == 1], date, time) |> 
    relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) |> 
    arrange(record_id, date, time)

### Group by record_id and date and obtain mean of multiple measurements from the same day
data_bia_D1_filtered <- data_bia_D1_filtered |> 
    group_by(record_id, date) |>
    summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) |>
    group_by(record_id) |> # Add coding for visit number
    mutate(
        visit = case_when(
            date == min(date) ~ 1,  # Assign 1 to the earliest date
            date == max(date) ~ 3,  # Assign 3 to the latest date
            TRUE ~ NA_real_         # Default to NA for unexpected cases
        ),
        .after = record_id
    )
### Selecting BIA data from D1 not present in D3
data_bia_D1_filtered <- data_bia_D1_filtered |> 
    filter(
     record_id %in% setdiff(1:75, data_bia_D3_filtered$record_id)   
    )
```

### Merging to single tibble

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 8.3 MERGE D1/D3 BIA data into a single tibble
data_bia <- bind_rows(
    data_bia_D1_filtered, data_bia_D3_filtered
) |> 
    mutate(
        visit = as.integer(visit)
    ) |> 
    arrange(
        record_id, visit
    )

### label_variables
data_bia <- label_variables(data_bia, data_bia_codebook)
```

### Drop intermediate tibbles

```{r, results = 'hide', message = FALSE, warning = FALSE}
# 8.4. DROP intermediate tibbles
rm(data_bia_D1)
rm(data_bia_D1_filtered)
rm(data_bia_D3)
rm(data_bia_D3_filtered)
```

## Wrangling DVEP REDCap data

### Adding NCIT labels

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.2 Repeating instruments
### 9.2.1. Concatenating NCIT labels (from data_NCIT) to NCIT codes
#### Conditions (commorbidities)
I21_conditions_R  <- filter_data("eleg",1,"conditions")  |> 
    left_join(
        data_NCIT |> select(ncit_code, descriptive),
        # by = c("common_comorbidities" = "ncit_code")
        join_by(common_comorbidities == ncit_code)
    ) |>
    relocate(
        descriptive, .after = common_comorbidities
    )

I21_conditions_R <- label_variables(I21_conditions_R, data_codebook)

#### Drugs in regular use
I22_drugs_R  <- filter_data("eleg",1,"drugs")  |> 
    left_join(
        data_NCIT |> select(ncit_code, descriptive),
        join_by(drugs_sql == ncit_code)
    ) |>
    relocate(
        descriptive, .after = drugs_sql
    )

I22_drugs_R <- label_variables(I22_drugs_R, data_codebook)

# # 1.3 Previous drugs
# I23_old_drugs_R <- filter_data("eleg",1,"old.drugs") |> 
#     left_join(
#         data_NCIT |> select(ncit_code, descriptive),
#         join_by(common_previous_medications == ncit_code)
#     )|>
#     relocate(
#         descriptive, .after = common_previous_medications
#     )
# 
# # 1.4 Past medical conditions
# I24_old_conditions_R <- filter_data("eleg",1,"history") |> 
#     left_join(
#         data_NCIT |> select(ncit_code, descriptive),
#         join_by(common_medical_history == ncit_code)
#     )|>
#     relocate(
#         descriptive, .after = common_medical_history
#     )


# Most common comorbidities
# I21_conditions_R |> 
#     group_by(common_comorbidities, descriptive) |> 
#     count(common_comorbidities, sort = TRUE, name = "frequency") |> 
#     mutate(percentage = round((frequency/75 * 100),1)) |> 
#     view()

# NCIT    Condition   
# C3117	Hipertensão	                18	24         *1
# C26696	Ansiedade	                16	21.3        
# C37967	Hipercolesterolemia         16	21.3       *2
# C37971	Hipertrigliceridemia        13	17.3       *2
# C113101	Resistência à insulina      11	14.7       *3
# C26800	Hipotireoidismo             9	12         
# C89715	Enxaqueca	                8	10.7
# C114667	SOP                     	7	9.3
# C26747	DM2                     	7	9.3        *3
 
# Most common drugs
# ```{r, eval = FALSE}
# I22_drugs_R |> 
#     group_by(drugs_sql, descriptive) |> 
#     count(drugs_sql, sort = TRUE, name = "frequency") |> 
#     mutate(percentage = round((frequency/75 * 100),1)) |> 
#     view()
```

### Eclusive variables from Eleg/D1 `d1_exclusive`

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.1 Eclusive variables from Eleg/D1 (`d1_exclusive`) to be replicated to d2 and d3
eleg_exclusive <- filter_data("eleg",0) |> 
    mutate(
        intervention_duration = as.numeric(conclusion_date - intervention_start_date)
        )|> 
    select(record_id, allocation_group, completed_intervention, intervention_duration, age, sex)

visit_1_exclusive <- filter_data("V1",0) |> 
    select(
        record_id,
        race:income_level
    )

d1_exclusive <- eleg_exclusive |> 
    left_join(
        visit_1_exclusive,
        by = join_by(record_id)
)
rm(eleg_exclusive)
rm(visit_1_exclusive)
```

### REPEATING INSTRUMENTS

#### Creating relevant binary variables\*

##### Hypertension

```{r, results = 'hide', message = FALSE, warning = FALSE}
### 9.3.1 HYPERTENSION
#### Extract record IDs associated with hypertension diagnosis
hypertension_conditions <- I21_conditions_R |> 
    filter(str_detect(common_comorbidities, "C3117")) |> 
    pull(record_id)

#### Extract record IDs associated with antihypertensive drugs
hypertension_drugs <- I22_drugs_R |> 
    filter(str_detect(drugs_sql, 
        "C66869|C29098|C61635|C47640_2|C28836|C29254|C62027|C62027_2"
        )
        ) |> 
    pull(record_id)

#### Assign hypertension based on conditions or drugs
d1_exclusive <- d1_exclusive |> 
    mutate(hypertension = if_else(
        record_id %in% hypertension_conditions, 
        1, 
        if_else(
            record_id %in% hypertension_drugs, 
            1, 
            0
        )
    ))

rm(hypertension_conditions)
rm(hypertension_drugs)
```

##### Dyslipidemia

```{r, results = 'hide', message = FALSE, warning = FALSE}
### 9.3.2 DYSLIPIDEMIA
#### Extract record IDs associated with dyslipidemia conditions
dyslipidemia_conditions <- I21_conditions_R |> 
    filter(str_detect(common_comorbidities, "C37967|C37971")) |>
    pull(record_id)

#### Extract record IDs associated with antihypertensive drugs
dyslipidemia_drugs <- I22_drugs_R |> 
    filter(str_detect(drugs_sql, 
        "C29454|C66523_2|C47529|C61527|C87471"
        )
        ) |> 
    pull(record_id)

#### Assign dyslipidemia based on conditions or drugs
d1_exclusive <- d1_exclusive |> 
    mutate(dyslipidemia = if_else(
        record_id %in% dyslipidemia_conditions, 
        1, 
        if_else(
            record_id %in% dyslipidemia_drugs, 
            1, 
            0
        )
    ))

rm(dyslipidemia_conditions)
rm(dyslipidemia_drugs)
```

##### Insulin resistance

```{r, results = 'hide', message = FALSE, warning = FALSE}
### 9.3.3 INSULIN RESISTANCE
#### Extract record IDs associated with insulin resistance or diabetes
insulin_conditions <- I21_conditions_R |> 
    filter(str_detect(common_comorbidities, "C113101|C26747")) |>
    pull(record_id)

#### Extract record IDs associated with anti-hyperglycemic / hypoglycemic drugs
insulin_drugs <- I22_drugs_R |> 
    filter(str_detect(drugs_sql, 
        "C61612|C61612_2|C87618|C180533"
        )
        ) |> 
    pull(record_id)

#### Assign dyslipidemia based on conditions or drugs
d1_exclusive <- d1_exclusive |> 
    mutate(insulin = if_else(
        record_id %in% insulin_conditions, 
        1, 
        if_else(
            record_id %in% insulin_drugs, 
            1, 
            0
        )
    ))

rm(insulin_conditions)
rm(insulin_drugs)
```

##### Drugs that might induce weight loss

```{r, results = 'hide', message = FALSE, warning = FALSE}
### 9.3.4 DRUGS THAT MIGHT INDUCE WEIGHT LOSS
#### Extract record IDs
drugs_w_loss <- I22_drugs_R |> 
    filter(str_detect(drugs_sql, 
        "C61939|C62012|C506_1|C1278_2|C1278_1|C1278_3|C47764_1|C47764_2|C61680"
        )
        ) |> 
    pull(record_id)

#### Assign drugs_w_loss based on drugs
d1_exclusive <- d1_exclusive |> 
    mutate(drugs_w_loss = if_else(
        record_id %in% drugs_w_loss, 1, 0)
    )

rm(drugs_w_loss)
```

##### Drugs that might induce weight gain

```{r, results = 'hide', message = FALSE, warning = FALSE}
### 9.3.5 DRUGS THAT MIGHT INDUCE WEIGHT GAIN
#### Extract record IDs
drugs_w_gain <- I22_drugs_R |> 
    filter(str_detect(drugs_sql, 
        "C61879|C62005|C61917_2|C29416|C29536_2"
        )
        ) |> 
    pull(record_id)

#### Assign drugs_w_loss based on drugs
d1_exclusive <- d1_exclusive |> 
    mutate(drugs_w_gain = if_else(
        record_id %in% drugs_w_gain, 1, 0)
    )

rm(drugs_w_gain)

```

##### Wrapping up `d1_exclusive`

```{r, results = 'hide', message = FALSE, warning = FALSE}

d1_exclusive <- label_choices(d1_exclusive, data_codebook)
d1_exclusive <- convert_col_type(d1_exclusive, data_codebook)
d1_exclusive <- d1_exclusive |> 
    mutate(
        hypertension = as.factor(hypertension),
        dyslipidemia = as.factor(dyslipidemia),
        insulin = as.factor(insulin),
        drugs_w_loss = as.factor(drugs_w_loss),
        drugs_w_gain = as.factor(drugs_w_gain)
    )

```

#### Lab exames

```{r, results = 'hide', message = FALSE, warning = FALSE}
I27_labs_R <- filter_data(c("V1","V2","V3"),1,"labs") |> 
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )|> 
    select(-event_name, -repeat_instrument, -repeat_instance, -labs_checked_results_yn)

```

#### Compliance

```{r, results = 'hide', message = FALSE, warning = FALSE}
compliance_V2 <- data |> 
    select(
        record_id, event_name,
        filter_variables("V2",1,"compliance")
        ) |> 
    filter(event_name == "2visit_arm_1" & cp_compliance_complete == 2) |> 
    left_join(data |>
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) |> 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) |> 
    left_join(data |>
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) |> 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) |> 
    rename(evaluation_date_2 = evaluation_date)

compliance_V3 <- data |> 
    select(
        record_id, event_name,
        filter_variables("V3",,"compliance")
        ) |> 
    filter(event_name == "3visit_arm_1" & cp_compliance_complete == 2) |> 
    left_join(data |>
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) |> 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) |> 
    left_join(data |>
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) |> 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) |> 
    rename(evaluation_date_2 = evaluation_date)

I29_compliance <- bind_rows(
    compliance_V2,compliance_V3
) |> 
    mutate(
        record_id = as.integer(record_id)
    ) |> 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
    ) |> 
    arrange(record_id,visit) |> 
    select(record_id, visit, intervention_start_date, evaluation_date_2, conclusion_date, cp_taking_as_directed_yn, cp_schedule, cp_schedule_other, cp_missed_dose_yn, cp_missed_dose_count, cp_discontinued_yn, cp_discontinued_n_days, cp_discontinued_reason_other, cp_ran_out_of_drug_yn, cp_ran_out_reason, cp_perceived_improvement_yn, cp_perceived_improvement, cp_medication_confidence_scale, cp_self_reported_compliance_rate)  |> 
    convert_col_type()

rm(compliance_V2)
rm(compliance_V3)

I29_compliance <- label_variables(I29_compliance, data_codebook)
I29_compliance <- label_choices(I29_compliance, data_codebook)

```

#### Adverse events

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.9 Adverse events
I30_events_R <- filter_data(,1,"events") |> 
    filter(
        cp_adverse_event_this_cycle_yn == 1
    ) |>
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )|> 
    select(-event_name, -repeat_instrument, -cp_additional_adverse_events_yn,  -cp_adverse_event_this_cycle_yn)

I30_events_R <- label_variables(I30_events_R, data_codebook)
I30_events_R <- label_choices(I30_events_R, data_codebook) 
```

### NON-REPEATING INSTRUMENTS

#### Data common to V1 and V3 (`d1d3`)

```{r, results = 'hide', message = FALSE, warning = FALSE}

### Non-repeating data common to V1 and V3 (`d1d3`)
# calculate mean of handgrip strenght
# select relevant variables
d1d3 <- filter_data(c("V1","V3"),0) |> 
    mutate(
        handgrip = if_else(
            is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
            NA_real_,  # Leave blank (NA) if both are missing
            if_else(
                !is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
                handgrip_right_mean,  # Use the right hand value if left is missing
                if_else(
                    is.na(handgrip_right_mean) & !is.na(handgrip_left_mean),
                    handgrip_left_mean,  # Use the left hand value if right is missing
                    rowMeans(cbind(handgrip_right_mean, handgrip_left_mean), na.rm = TRUE)  # Calculate mean if both are present
                    )
                )
            )
        ) |> 
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "3visit_arm_1"    ~ 3
        )
    ) |> 
    select(
        record_id, visit,
        whoqol_score_overall, # 4. whoqol
        dass_score_depression:ecap_score, # 5. dass, 6. ecap
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        time_fasted_food, time_fasted_liquid, resistance, reactance, phase_angle, # 10. bia
        handgrip, # 11. handgrip
        # 12. eliminations
        evs_score, # 14. evs
        alcohol_dose, alcohol_significant, # 15. alcohol
        smoke_history, pack_years,  # 16. tobacco
        carbs_kcal, protein_kcal, fat_kcal, # 18. intake
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered # 31. medical
        )
```

#### Data from the second visit (`d2`)

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.5 Non-repeating data from the second visit (`d2`)
d2 <- filter_data("V2",0) |> 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2
        )
    ) |> 
    select(
        record_id, visit,
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        # 12. eliminations
        evs_score, # 14. evs
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered # 31. medical
        )
```

### JOINING

#### Bind rows from `d1d3` and `d2`: `all_data`

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.6 Bind rows for non-repeating variables from D1/D2/D3
all_data <- bind_rows(
    d1d3,d2
) |> 
    mutate(
        record_id = as.integer(record_id),
        visit = as.integer(visit)
) |> 
    arrange(
        record_id, visit
    ) |> 
    convert_col_type()

rm(d1d3)
rm(d2)
```

#### Left_joins

##### BIA data to `all_data`

```{r, results = 'hide', message = FALSE, warning = FALSE}
## 9.7. Left_join BIA data to `all_data`
all_data <- all_data |> 
    left_join(
        data_bia |> 
            select(
                record_id, visit,
                phaseangle, raverage, xcaverage, 
                weight, height, waist, pal, bmi, 
                fmi, ffmi, vat,
                w_tbw, w_ecw
            ),
        by = join_by(record_id, visit)
    )

```

##### Compliance data to `all_data`

```{r, results = 'hide', message = FALSE, warning = FALSE}
all_data <- all_data |> 
    left_join(
        I29_compliance,
        by = join_by(record_id, visit)
    )

```

##### d1_exclusive to `all data`

```{r}
final_data <- d1_exclusive |> 
    right_join(
        all_data,
        by = join_by(record_id)
    ) |> 
    relocate(
        visit,
        .after = record_id
    )

```

##### Labs to `all_data`

```{r}
final_data <- final_data |> 
    left_join(I27_labs_R,
              by = join_by(record_id, visit)
    )

final_data <- label_variables(final_data, data_codebook)
final_data <- label_variables(final_data, data_bia_codebook)
final_data <- final_data |> 
    mutate(
        visit = as.integer(visit)
    )

write_csv(final_data,"final_data.csv")
```

# Analysis


```{r}
library(tidyverse)

# Function to create a summary table
create_summary_table <- function(data, variables = NULL) {
  # If no variables specified, use all numeric columns
  if (is.null(variables)) {
    variables <- names(data)[sapply(data, is.numeric)]
  }
  
  # Check if specified variables exist in the dataframe
  valid_variables <- intersect(variables, colnames(data))
  
  # If no valid variables are found, return an error
  if (length(valid_variables) == 0) {
    stop("No valid numeric variables found in the provided dataframe.")
  }
  
  # Create the summary table
  summary_table <- data %>%
    summarise(across(
      all_of(valid_variables),
      list(
        mean = ~ mean(.x, na.rm = TRUE),
        sd = ~ sd(.x, na.rm = TRUE),
        median = ~ median(.x, na.rm = TRUE),
        iqr = ~ IQR(.x, na.rm = TRUE),
        min = ~ min(.x, na.rm = TRUE),
        max = ~ max(.x, na.rm = TRUE),
        missing = ~ sum(is.na(.x))
      )
    )) %>%
    pivot_longer(
      cols = everything(),
      names_to = c("variable", "statistic"),
      names_sep = "_",
      values_to = "value"
    ) %>%
    pivot_wider(
      names_from = statistic,
      values_from = value
    )
  
  return(summary_table)
}

```

```{r}
library(lme4)

glmm_model <- lme4::lmer(
  phaseangle ~ visit + allocation_group + age + sex + labs_homa_ir + labs_leukocytes +
    (1 | record_id),  # Random effect for patients
  data = final_data,
  REML = FALSE        # Use maximum likelihood for comparison between models
)

# View the model summary
summary(glmm_model)


glmm_model_interaction <- lmer(
  phaseangle ~ visit * allocation_group + age + sex + labs_homa_ir + labs_leukocytes +
    (1 | record_id),
  data = final_data
)
summary(glmm_model_interaction)


```

```{r}
# Fit the linear mixed-effects model for CRP
crp_model <- lmer(
  labs_crp ~ visit * allocation_group + age + sex + labs_homa_ir + labs_leukocytes +
    (1 | record_id),  # Random intercept for repeated measures
  data = final_data
)

# View the summary
summary(crp_model)

```


# Help
## Count()
Used for categorical data
```{r, eval=FALSE}
# Count Unique Values in a Single Column
d1_exclusive |> 
  count(allocation_group)

# Count Unique Combinations of Two or More Variables
d1_exclusive |> 
  count(allocation_group, visit)

#  Add Proportions Using count()
d1_exclusive |> 
  count(allocation_group, name = "count") |> 
  mutate(proportion = count / sum(count))

# Sort the Results
d1_exclusive |> 
  count(allocation_group, sort = TRUE)

# Filter for Specific Counts
d1_exclusive |> 
  count(allocation_group) |> 
  filter(n > 20)

# Rename the Count Column
d1_exclusive |> 
  count(allocation_group, name = "total")

# Weight Counts
You can apply weights to the counts (e.g., if certain rows represent different weights)

d1_exclusive |> 
  count(allocation_group, wt = weight_column)

## Here, weight_column provides the weights to adjust the counts. If weight_column = c(2, 1, 1, ...), the count for Grupo A might become 37 × 2.

# Use count() in Pipelines
d1_exclusive |> 
  group_by(sex) |> 
  count(allocation_group) |> 
  arrange(desc(n))

# Visualize the Counts
d1_exclusive |> 
  count(allocation_group) |> 
  ggplot(aes(x = allocation_group, y = n, fill = allocation_group)) +
  geom_bar(stat = "identity") +
  labs(title = "Participant Count by Group", x = "Group", y = "Count") +
  theme_minimal()



```

# Jamovi
## jmv::descriptives

Defaults
```{r}
library(jmv)
#Default
# N, missing, mean, median, SD, Min, Max
jmv::descriptives(
    data = data, # select dataframe
    vars = vars() #insert variables without ""
    ) 
```

To remove defaults
```{r}
jmv::descriptives(
    data = data,
    vars = vars(),
    n = FALSE,
    missing = FALSE,
    mean = FALSE,
    median = FALSE,
    sd = FALSE,
    min = FALSE,
    max = FALSE
    )
```

Additional statistics
```{r}

```


jmv::descriptives(
    data = data,
    vars = vars(),
    pcEqGr = TRUE,
    pcNEqGr = 5,
    pc = TRUE)

jmv::descriptives(
    data = data,
    vars = vars(age, abdomen, bmi.x),
    freq = TRUE,
    desc = "rows",
    boxLabelOutliers = FALSE,
    mode = TRUE,
    sum = TRUE,
    variance = TRUE,
    range = TRUE,
    se = TRUE,
    ci = TRUE,
    iqr = TRUE,
    skew = TRUE,
    kurt = TRUE,
    sw = TRUE,
    pcEqGr = TRUE,
    pc = TRUE,
    extreme = TRUE)
    
    
    
```{r}    

# Extract vector of double variables
dbl_vars <- final_data %>%
  select(where(is.double)) %>%
  colnames()

# View the result
print(dbl_vars)

jmv::descriptives(
    data = final_data,
    vars = !!rlang::syms(dbl_vars),
    splitBy = NULL,
    freq = FALSE, #frequency tables (nominal, ordinal variables only)
    desc = "columns", # 'rows' or 'columns' to display variables
    hist = FALSE, # histograms (continuous variables only)
    dens = FALSE, # density plots (continuous variables only)
    bar = FALSE, # bar plots (nominal, ordinal variables only)
    barCounts = FALSE, # add counts to the bar plots
    box = FALSE, # box plots (continuous variables only)
    violin = FALSE, # violin plots (continuous variables only)
    dot = FALSE, # dot plots (continuous variables only)
    dotType = "jitter",
    boxMean = FALSE, # add mean to box plot
    boxLabelOutliers = TRUE, # labels outliers with the row
    qq = FALSE, # (continuous variables only)
    n = TRUE, # sample size
    missing = TRUE, # number of missing values
    mean = TRUE,
    median = TRUE,
    mode = FALSE,
    sum = FALSE,
    sd = TRUE,
    variance = FALSE,
    range = FALSE,
    min = TRUE,
    max = TRUE,
    se = FALSE, # standard error of the mean
    ci = FALSE, # confidence intervals for the mean
    ciWidth = 95, # width of confidence intervals (50-99.9)
    iqr = FALSE,
    skew = FALSE,
    kurt = FALSE,
    sw = FALSE, # Shapiro-Wilk p-value
    pcEqGr = FALSE, # provide quantiles (default: 4)
    pcNEqGr = 4, # an integer specifying the number of equal groups
    pc = FALSE, # provide percentiles
    pcValues = "25,50,75", #specify the percentiles
    extreme = FALSE, # provide N most extreme (highest/lowest) values
    extremeN = 5, # specify the number of extreme values
    )
```


