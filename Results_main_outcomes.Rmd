---
title: "Results_main_outcomes"
output: html_document
---

```{r}
rm(list = ls())
graphics.off()
cat("\014")  # Clear any pending RStudio sessions or temporary files

# Load functions from external script
source("helper_functions.R")

## Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(purrr)
library(here)
library(lme4)
library(lmerTest)
library(skimr)

# Read Files ----
## Codebooks
codebook_dvep <- read_excel(
    "Codebooks/codebook_dvep.xlsx",
    col_names = TRUE,
    col_types = NULL,
    na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
    trim_ws = TRUE,
    skip = 0, # Number of lines to skip before reading data
    n_max = Inf, # Maximum number of lines to read.
    guess_max = 1000
) %>%
    arrange(index)

codebook_structure  <- read_csv(
    "Codebooks/codebook_structure.csv",
    col_names = TRUE)

codebook_ncit  <- read_csv(
    "Codebooks/codebook_ncit.csv",
    col_names = TRUE)

codebook_bia <- read_excel(
    "Codebooks/codebook_bia.xlsx",
    col_names = TRUE,
    col_types = NULL,
    na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
    trim_ws = TRUE,
    skip = 0, # Number of lines to skip before reading data
    n_max = Inf, # Maximum number of lines to read.
    guess_max = 1000
) %>%
    arrange(index)

## Data
data <- readRDS("Data_processed/data.rds")
data_bia <- readRDS("Data_processed/data_bia.rds")
data_bia_D1 <- readRDS("Data_processed/data_bia_D1.rds")
data_bia_D1_mean <- readRDS("Data_processed/data_bia_D1_mean.rds")
data_bia_D1_raw <- readRDS("Data_processed/data_bia_D1_raw.rds")
data_bia_D3 <- readRDS("Data_processed/data_bia_D3.rds")
data_bia_D3_mean <- readRDS("Data_processed/data_bia_D3_mean.rds")
data_bia_D3_raw <- readRDS("Data_processed/data_bia_D3_raw.rds")
data_bia_mean <- readRDS("Data_processed/data_bia_mean.rds")
data_d1_exclusive <- readRDS("Data_processed/data_d1_exclusive.rds")
data_filtered <- readRDS("Data_processed/data_filtered.rds")
data_filtered_seca <- readRDS("Data_processed/data_filtered_seca.rds")
I21_conditions_R <- readRDS("Data_processed/I21_conditions_R.rds")
I22_drugs_R <- readRDS("Data_processed/I22_drugs_R.rds")
I27_labs_R <- readRDS("Data_processed/I27_labs_R.rds")
I29_compliance <- readRDS("Data_processed/I29_compliance.rds")
I30_events_R <- readRDS("Data_processed/I30_events_R.rds")

## SUPERTIBBLE
data_instruments <- readRDS("Data_instruments/data_instruments.rds")
```

# Variáveis de interesse

(1 \| record_id) + visit + allocation_group + age + sex + race + education +

```         
# Comorbidities #
```

hypertension + hypercholesterolemia + hypertrigliceridemia + insulin + drugs_w_loss + drugs_w_gain +

```         
# Anthro
```

abdomen + bmi + mean_bp_mean

```         
# Questionnaires #
```

whoqol_score_overall + ecap_score + evs_score + dass_score_stress + dass_score_anxiety + dass_score_depression + alcohol_significant + smoke_history + carbs_kcal + protein_kcal + fat_kcal + drugs_dose_change_yn +

```         
# Adesão #
```

completed_intervention, intervention_duration, education_years? cp_taking_as_directed_yn, cp_missed_dose_yn, cp_missed_dose_count, cp_discontinued_yn, cp_discontinued_n_days, cp_ran_out_of_drug_yn, cp_medication_confidence_sca

# Adesão

These variables are related to the compliance to the drug intervention.

| variable | label | field type | options |
|------------------|------------------|------------------|------------------|
| cp_taking_as_directed_yn | Está tomando conforme orientado? | radio | 0, Não ; 1, Sim |
| cp_schedule | Cronograma de medicação | dropdown | 1, conforme orientado ; 2, 6 cp/d, em outros horários ; 3, 3 cápsulas ao dia (1 cápsula com café da manhã, 1 com almoço e 1 com o jantar) ; 4, 3 cápsulas ao dia, em outros horários ; 5, Outros (especifique) |
| cp_schedule_other | Outra forma de tomar (especifique) | text |  |
| cp_reminder | Método de lembrete para medicamento | dropdown | 1, Alarme no celular ; 2, Caixa de remédios com divisórias para cada horário ; 3, Lembrete escrito em um calendário ; 4, Outro (especificar) |
| cp_reminder_other | Outro lembrete (especifique) | text |  |
| cp_missed_dose_yn | Perdeu alguma dose? | radio | 0, Não ; 1, Sim |
| cp_missed_dose_count | Quantas doses perdidas? | dropdown | 1, 1 vez ; 2, 2 vezes ; 3, 3 a 5 vezes ; 4, 5 a 10 vezes ; 5, mais de 10 vezes |
| cp_missed_dose_timing | Momentos de doses perdidas | dropdown | 1, Com o café da manhã ; 2, Com o almoço ; 3, Com o jantar ; 4, Outro (especificar) |
| cp_missed_dose_timing_other | Outros momentos de doses perdidas | text |  |
| cp_discontinued_yn | Parou de tomar o medicamento? | radio | 0, Não ; 1, Sim |
| cp_discontinued_n_days | Dias de interrupção | dropdown | 1, 1 dia ; 2, 2 dias ; 3, 3 a 5 dias ; 4, 5 a 10 dias ; 5, mais de 10 dias |
| cp_discontinued_reason | Motivo da interrupção | dropdown | 1, Efeito colateral ; 2, Esquecimento ; 3, Dificuldade em seguir horários ; 4, Outro (especificar) |
| cp_discontinued_reason_other | Outra razão (especificar) | notes |  |
| cp_ran_out_of_drug_yn | Ficou sem medicamento? | radio | 0, Não ; 1, Sim |
| cp_ran_out_reason | Motivo de falta de medicamento | notes |  |
| cp_daily_routine_change_medication_adherence_yn | Mudança de rotina afeta adesão ao medicamento? | radio | 0, Não ; 1, Sim |
| cp_daily_routine_change_specify | Especificar mudança na rotina | notes |  |
| cp_perceived_improvement_yn | Percebeu melhorias? | radio | 0, Não ; 1, Sim |
| cp_perceived_improvement | Melhorias relatadas | notes |  |
| cp_challenges_taking_yn | Dificuldades com medicação? | radio | 0, Não ; 1, Sim |
| cp_challenges_taking | Desafios na adesão ao medicamento | notes |  |
| cp_medication_confidence_scale | Confiança no cronograma (1-10) | slider | Nada confiante ; Neutro ; Totalmente confiante |
| cp_self_reported_compliance_rate | Adesão ao medicamento | radio | 1, Ruim ; 2, Regular ; 3, Boa ; 4, Excelente |

# Correcting values

```{r}

# Correcting values --------
I29_compliance_new <- I29_compliance %>%
    select(
        record_id, visit, cp_taking_as_directed_yn:cp_self_reported_compliance_rate
    ) %>% 
    left_join(
        data_filtered %>% 
            select(record_id, visit, completed_intervention, intervention_duration),
        by = c("record_id", "visit")
    )

#I29_compliance_new %>% glimpse()
#I29_compliance_new %>% skimr::skim()


I29_compliance_new <- I29_compliance_new %>%
  mutate(
    cp_taking_as_directed_yn = case_when(
      record_id == 12 & visit == 3 ~ "Não",
      record_id == 22 & visit == 3 ~ "Não",
      record_id == 27 & visit == 2 ~ "Não",
      record_id == 36 & visit == 2 ~ "Não",
      record_id == 56 & visit == 2 ~ "Não",
      record_id == 67 & visit == 2 ~ "Não",
      TRUE                        ~ cp_taking_as_directed_yn
    ),
    cp_schedule = case_when(
      record_id == 72 & visit == 2 ~ "3 cápsulas uma vez ao dia",
      record_id == 67 & visit == 2 ~ "6 cp/d, em outros horários",
      TRUE                        ~ cp_schedule
    ),
    cp_missed_dose_yn = case_when(
      record_id == 56 & visit == 2 ~ "Não",
      TRUE                        ~ cp_missed_dose_yn
    ),
    cp_discontinued_n_days = case_when(
      record_id == 23 & visit == 3 ~ "5 a 10 dias",
      record_id == 31 & visit == 2 ~ "3 a 5 dias",
      record_id == 38 & visit == 3 ~ "5 a 10 dias",
      record_id == 41 & visit == 2 ~ "5 a 10 dias",
      record_id == 50 & visit == 2 ~ "3 a 5 dias",
      record_id == 54 & visit == 3 ~ "5 a 10 dias",
      record_id == 56 & visit == 2 ~ "mais de 10 dias",
      record_id == 72 & visit == 3 ~ "mais de 10 dias", 
      TRUE                        ~ cp_discontinued_n_days
    )
  )
```

# Simplifying tibble

```{r}
I29_compliance_new <- I29_compliance_new %>%
  mutate(
    cp_missed_dose_count = if_else(is.na(cp_missed_dose_count), "Não", cp_missed_dose_count),
    cp_discontinued_n_days = if_else(is.na(cp_discontinued_n_days), "Não", cp_discontinued_n_days),
  ) %>% 
    select(
        record_id, visit, completed_intervention, intervention_duration, 
        cp_schedule, cp_missed_dose_count, cp_discontinued_n_days,
        cp_ran_out_of_drug_yn,
        cp_medication_confidence_scale, cp_self_reported_compliance_rate)
```

# Escore composto de adesão (`compliance_score_visit`)

```{r}
# mapeamentos em vetores nomeados
schedule_scale <- c(
  "conforme orientado"                                       = 1,
  "6 cp/d, em outros horários"                               = 0.75,
  "3 cápsulas ao dia (1 cápsula com café da manhã, 1 com almoço e 1 com o jantar)" = 0.5,
  "3 cápsulas ao dia, em outros horários"                    = 0.50,
  "Outros (especifique)"                                     = 0        # zera o escore
)

missed_scale <- c(
  "Não"                 = 1,
  "1 vez"               = 0.80,
  "2 vezes"             = 0.60,
  "3 a 5 vezes"         = 0.40,
  "5 a 10 vezes"        = 0.20,
  "mais de 10 vezes"    = 0
)

discont_scale <- c(
  "Não"                 = 1,
  "1 dia"               = 0.80,
  "2 dias"              = 0.60,
  "3 a 5 dias"          = 0.40,
  "5 a 10 dias"         = 0.20,
  "mais de 10 dias"     = 0
)

rate_scale <- c(
  "Excelente" = 1,
  "Boa"       = 0.75,
  "Regular"   = 0.50,
  "Ruim"      = 0.25
)

I29_compliance_new <- I29_compliance_new %>% 
  mutate(
    # Cronograma
    pts_schedule = schedule_scale[cp_schedule] %>% unname(),
    
    # Perda de doses
    pts_missed   = missed_scale[cp_missed_dose_count] %>% unname(),
    
    # Interrupção
    pts_discont  = discont_scale[cp_discontinued_n_days] %>% unname(),
    
    # Ficou sem medicamento
    pts_ranout   = case_when(
      cp_ran_out_of_drug_yn == "Não" ~ 1,
      cp_ran_out_of_drug_yn == "Sim" ~ 0,
      TRUE                           ~ NA_real_
    ),
    
    # Confiança (somente visita 2)
    pts_conf     = cp_medication_confidence_scale / 10,
    
    # Autoavaliação
    pts_selfrate = rate_scale[cp_self_reported_compliance_rate] %>% unname()
  ) %>% 
  
    
    # Soma por visita com atribuição de peso
  rowwise() %>% 
  mutate(
    total_pts   = sum(c_across(starts_with("pts_")), na.rm = TRUE),
    domains_ok  = sum(!is.na(c_across(starts_with("pts_")))),
    compliance_score_visit = total_pts / domains_ok
  ) %>% 
  ungroup()

### If cp_schedule == Outros (especifique), the final score for that visit should be zero

I29_compliance_new <- I29_compliance_new %>% 
mutate(
    compliance_score_visit = if_else(
      cp_schedule == "Outros (especifique)",
      0,
      compliance_score_visit
    )
  )

# (opcional) média de adesão por participante
#compliance_by_id <- I29_compliance_new %>% 
#  group_by(record_id) %>% 
#  summarise(compliance_score_mean = mean(compliance_score_visit, na.rm = TRUE))
```

Converte cada variável em pontos padronizados (0 – 1), soma os pontos obtidos na visita e divide pelo número de domínios válidos.\
O resultado é um escore contínuo de 0 (pior adesão) a 1 (melhor adesão).

**Regras de pontuação**

| Domínio | Variável | Regra → Pontos |
|-------------------|---------------------|--------------------------------|
| **Cronograma** | `cp_schedule` | “conforme orientado” → 1<br>“6 cp/d, em outros horários” → 0.75<br>“3 cápsulas / horário orientado” → 0.75<br>“3 cápsulas / outros horários” → 0.50<br>“Outros (especifique)” → 0 |
| **Perda de doses – YN** | `cp_missed_dose_count`<br>(valor “Não”) | “Não” → 1 |
| **Perda de doses – quantas** | `cp_missed_dose_count` | “1 vez” → 0.80<br>“2 vezes” → 0.60<br>“3 a 5 vezes” → 0.40<br>“5 a 10 vezes” → 0.20<br>“mais de 10 vezes” → 0 |
| **Interrupção – YN** | `cp_discontinued_n_days`<br>(valor “Não”) | “Não” → 1 |
| **Interrupção – dias** | `cp_discontinued_n_days` | “1 dia” → 0.80<br>“2 dias” → 0.60<br>“3 a 5 dias” → 0.40<br>“5 a 10 dias” → 0.20<br>“mais de 10 dias” → 0 |
| **Ficou sem medicamento** | `cp_ran_out_of_drug_yn` | Não → 1 · Sim → 0 |
| **Confiança (1-10)** | `cp_medication_confidence_scale` | escala ÷ 10 (8 → 0.8) |
| **Autoavaliada** | `cp_self_reported_compliance_rate` | Excelente → 1 · Boa → 0.75 · Regular → 0.50 · Ruim → 0.25 |

*Se o valor for **NA**, o domínio não entra no denominador (não penaliza).*

# Intervention_duration

```{r}
I29_compliance_new <- I29_compliance_new %>% 
    mutate(
        duration_deviation = intervention_duration - 90, # diferença bruta (neg = menos dias)
        duration_difference = abs(duration_deviation) # desvio absoluto (pior quanto maior)
        )
```

# Incorporate compliance into data_filtered

```{r}
data_filtered <- data_filtered %>% 
    left_join(
        I29_compliance_new %>% 
            select(record_id, visit, compliance_score_visit, duration_difference),
        by = c("record_id", "visit")
    ) %>% 
    
    group_by(record_id) %>% # Set baseline compliance to 1
    mutate(compliance_score_visit = if_else(visit == 1, 1, compliance_score_visit)) %>%
    ungroup() %>%
    
    select(
     record_id, visit, allocation_group, 
     completed_intervention, compliance_score_visit, duration_difference,
     age:light_clothes_yn,
     dplyr::starts_with("labs_")
    )
```

# Set duration_difference to 0 for visit 1

```{r}
data_filtered <- data_filtered %>% 
    mutate(
        duration_difference = if_else(visit == 1, 0, duration_difference)
    )
```

# Replace NAs for visit 2 with data from visit 1

```{r, eval=FALSE}}
vars_to_fill <- c("alcohol_significant", "alcohol_dose", "smoke_history", "pack_years", "whoqol_score_overall", "ecap_score", "alcohol_significant", "dass_score_stress", "dass_score_anxiety", "dass_score_depression", "resistance", "reactance", "phase_angle", "handgrip", )

data <- data %>%
  arrange(record_id, visit) %>%
  group_by(record_id) %>%
  mutate(across(all_of(vars_to_fill), ~ if_else(
    visit == 2 & is.na(.x),
    .x[visit == 1],
    .x
  ))) %>%
  ungroup()
```

# REDUCE TIBBLE FOR MODELLING

```{r}
data_model <- data_filtered %>% 
    select(
        record_id:sex,
        hypertension:ecap_score,
        abdomen, bmi, mean_bp_mean,
        resistance:evs_score,
        alcohol_dose, 
        carbs_kcal, protein_kcal, fat_kcal,
        labs_crp:labs_alkp,
        labs_cholesterol:labs_quick_index
    )

saveRDS(
    data_model,
    "Data_processed/data_model.rds")

vars_to_keep <- names(data_model)

# Step 2: filter codebook_dvep
codebook_data_model <- codebook_dvep %>%
    filter(variable %in% vars_to_keep) %>% 
    select(
        variable, label_pt, field_type, choices)

saveRDS(
    codebook_data_model,
    "Data_processed/codebook_data_model.rds")
```

# SCALING

$${QUICKI} = \frac{1}{\\log(insulin) + log(glucose)}$$

$$
HOMA-IR = \frac{insulin * glucose}{405}
$$

```{r}
data_model_scaled <- data_model %>%
  mutate(across(
    .cols = c(
      duration_difference, age,
      whoqol_score_overall, dass_score_depression, dass_score_anxiety,
      dass_score_stress, ecap_score, 
      abdomen, bmi, mean_bp_mean,
      resistance, reactance, 
      handgrip, evs_score, alcohol_dose,
      carbs_kcal, protein_kcal, fat_kcal,
      labs_crp, labs_ast, labs_alt, labs_ggt, labs_alkp,
      labs_cholesterol, labs_ldl, labs_hba1c, labs_triglycerides,
      labs_hdl, labs_glucose, labs_insulin, labs_homa_ir, labs_quick_index
    ),
    .fns = scale
  ))


```

# Efeito sobre o ângulo de fase

Filtrando D1 and D3

```{r}
pha_redcap <- data_filtered_davi %>% 
    filter(
        visit %in% c(1, 3)
    ) %>% 
    mutate(
        alcohol_dose = if_else(is.na(alcohol_dose), 0, alcohol_dose)
    )
```

### All variables

```{r}
library(lme4)
library(lmerTest) # Adds p-values to summary()

pha_1 <- lmer(phase_angle ~ (1 | record_id) + visit + allocation_group + completed_intervention + compliance_score_visit + duration_difference + age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + insulin + drugs_w_loss + drugs_w_gain + abdomen + bmi + mean_bp_mean + handgrip + evs_score + alcohol_dose + carbs_kcal + protein_kcal + fat_kcal + labs_crp + labs_alt + labs_ggt + labs_ldl + labs_hba1c + labs_triglycerides + labs_hdl + labs_glucose + labs_insulin + labs_homa_ir + labs_quick_index, data = pha_redcap)

summary(model1)

plot(model1)

res <- resid(model1, type = "pearson")
fitted_vals <- fitted(model1)
plot(fitted_vals, res, 
     xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, col = "gray")
```

```{r}
library(ggplot2)
ggplot(data_filtered, aes(x = visit, y = phase_angle, group = record_id, color = allocation_group)) +
  geom_line(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE)

```

### 2

```{r}
model2 <- lmer(phase_angle ~ visit * allocation_group + (1 | record_id), data = data_filtered)
summary(model2)
```

## PCR

### 1

```{r}
model3 <- lmer(labs_crp ~ visit + allocation_group + (1 | record_id), data = data_filtered)

summary(model3)

plot(model3)  # Residuals vs. fitted

qqnorm(resid(model3)); qqline(resid(model3))  # Normality check
```

.

```{r}
model3_log <- lmer(log1p(labs_crp) ~ visit + allocation_group + (1 | record_id), data = data_filtered)
summary(model3_log)

plot(model3_log)

qqnorm(resid(model3_log)); qqline(resid(model3_log))  # Normality check
```

**log+1 transformation** to the skewed CRP variable, and the results show clear improvement.

| **Term** | **Estimate** | **p-value** | **Interpretation** |
|------------------|------------------|------------------|------------------|
| **Intercept** | 1.82 | \<0.001 | Mean **log(CRP + 1)** at baseline in Grupo A |
| **Visit** | –0.099 | 0.036 | **CRP decreases significantly over time** |
| **Grupo B (vs A)** | +0.139 | 0.405 | No significant difference at baseline |

The **effect of visit became statistically significant** (p = 0.036), whereas it was borderline before (p = 0.072).

**Diagnostic Plots** **Residuals vs. Fitted**

-   More **symmetrical and homoscedastic** than before.

-   No clear fan shape or funnel — much better than untransformed.

**Q-Q Plot**

-   **Much closer to the line**, indicating that residuals are approximately **normally distributed**.

-   A few expected mild deviations at the tails, but very acceptable.

**What does this mean in original CRP scale?**

Let’s back-transform the time effect:

-   Estimate for visit = –0.099

-   Since you’re modeling log1p(CRP), to interpret in original scale:

$$\\text{exp}(-0.099) = 0.9056$$

This means: **each visit is associated with \~9.4% decrease** in CRP over time, **on average**.

**Summary**

| **Point**          | **Result**                                |
|--------------------|-------------------------------------------|
| Residuals          | Look better: less heteroscedasticity      |
| Q-Q plot           | Much closer to normal                     |
| Time effect        | Now statistically significant (p = 0.036) |
| Log transformation | Successfully improved model performance   |

The idea is to explore the antiinflamatory effect of the intervention. Currently, the model assumes parallel time trends for both groups, i.e., it estimates:

-   A main effect of time (CRP changes over time),

-   A main effect of group (baseline difference),

-   But no interaction (i.e., it assumes both groups change equally over time).

*Why this is not enough*

If the intervention is effective, we expect:

-   CRP to decrease faster in the intervention group (Grupo B),

-   Which means there should be a significant interaction between visit and allocation_group.

*Model with interaction:*

-   Adds visit:allocation_groupGrupo B as an interaction term,

-   Tests whether CRP changes differently over time in Grupo B vs Grupo A.

```{r}
model3_log_inter <- lmer(log1p(labs_crp) ~ visit * allocation_group + (1 | record_id), data = data_filtered)

summary(model3_log_inter)

plot(model3_log_inter)

qqnorm(resid(model3_log_inter)); qqline(resid(model3_log_inter))  # Normality check
```

Key Result: No Significant Interaction • The term visit:allocation_groupGrupo B has p = 0.620, meaning: There is no statistical evidence that the intervention led to a greater reduction in CRP over time compared to control. • The trend for CRP decrease over time is similar in both groups.

Interpretation

Despite applying a more appropriate transformation and including the interaction: • Time still shows a mild (non-significant) decreasing trend in CRP. • No baseline difference between groups. • No enhanced effect in the intervention group.

This means that, based on your data, the intervention did not show a measurable anti-inflammatory effect on CRP.

*PLOT* plot shows: • Predicted log(CRP + 1) at each visit for each group. • Makes it easy to compare time trends across intervention and control groups on the same scale used in the model. • Useful for statistical interpretation and checking for meaningful differences.

```{r}
# Create a new data frame for prediction: all combinations of visit × group
new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
)

# Predict fixed effects (marginal means, no random effects)
new_data$pred_log_crp <- predict(model3_log_inter, newdata = new_data, re.form = NA)

# Plot predicted log(CRP + 1)
ggplot(new_data, aes(x = visit, y = pred_log_crp, color = allocation_group, group = allocation_group)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Predicted CRP over Time (log scale)",
    y = "Predicted log(CRP + 1)",
    x = "Visit",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

*Visual Insights*

-   Both groups show a downward trend in CRP over time, suggesting a general anti-inflammatory progression.

-   Grupo B starts at a higher baseline and appears to have a slightly steeper decline in log(CRP), although:

    > 🔸 The interaction term was not statistically significant (p = 0.620).

This means that although Grupo B appears to improve more, this difference in slopes is not statistically supported.

*Grupo B's Higher Baseline*

Baseline imbalance may be a concern, particularly when:

1.  The groups were supposed to be randomized and equivalent at baseline, and

2.  The outcome variable (CRP, in this case) is already higher in one group before the intervention starts.

If Grupo B starts with higher CRP, then:

-   Any greater absolute reduction over time may be due to regression to the mean, not the intervention.

-   It violates the assumption that both groups are comparable at baseline, which undermines causal inference.

*Adjust for baseline differences:*

What this model does:

-   Adjusts for baseline CRP directly, reducing bias from initial imbalance.

-   The coefficient for allocation_groupGrupo B now reflects the difference at follow-up, controlling for baseline.

-   The time effect (visit) still captures change over time.

-   The model tests whether the intervention group had lower CRP over time than expected based on their higher starting levels.

If log1p_baseline_crp is significant, it means initial inflammation strongly predicts future levels — expected in longitudinal biomarkers.

If allocation_groupGrupo B or the visit:group interaction becomes significant after adjustment, that strengthens the case for a true treatment effect.

Let me know if you’d like to: • Visualize adjusted predictions • Back-transform to original CRP scale • Handle this in a subset of visits (e.g. only V1 and V3)

```{r}
# Adjusting for Baseline CRP in the Mixed Model (on log scale)

# Step 1: Create a baseline CRP variable (log-transformed)
# You should ensure that baseline CRP is correctly identified from your data

# Example: assuming visit 1 is baseline
data_filtered <- data_filtered %>%
  group_by(record_id) %>%
  mutate(log1p_baseline_crp = first(log1p(labs_crp[visit == 1]))) %>%
  ungroup()

# Step 2: Fit the adjusted model
model3_log_adj <- lmer(
  log1p(labs_crp) ~ visit + allocation_group + log1p_baseline_crp + (1 | record_id),
  data = data_filtered
)

# Step 3: Summarize the results
summary(model3_log_adj)
```

This model directly controls for **baseline differences in CRP**, correcting the bias introduced by the fact that **Grupo B started with higher inflammation**.

**Fixed Effects Summary**

| **Term** | **Estimate** | **p-value** | **Interpretation** |
|------------------|------------------|------------------|------------------|
| **(Intercept)** | 0.529 | \<0.001 | Estimated log(CRP+1) for Grupo A at baseline when baseline CRP is 0 |
| **visit** | –0.106 | **0.015** | CRP significantly **decreases over time** |
| **Grupo B (vs Grupo A)** | –0.008 | 0.919 | No difference between groups **after adjusting for baseline** |
| **log1p_baseline_crp** | +0.772 | \<0.001 | Strong predictor: higher baseline CRP leads to higher follow-up CRP |

------------------------------------------------------------------------

**Key Takeaways**

-   **Time effect (visit) is now significant (p = 0.015)**:

    > CRP decreases over time **even after accounting for baseline**.

-   **Grupo B effect disappears (p = 0.919)**:

    > Once you adjust for baseline CRP, there’s **no evidence the intervention had a distinct effect** on CRP reduction compared to control.

-   **Baseline CRP is a major driver** of later CRP (β = 0.77, p \< 0.001).

**Interpretation**

The original difference in CRP trends between groups was likely due to **baseline imbalance**, not the intervention itself.

This adjusted model is **more reliable**, and the results suggest:

-   CRP decreases over time for all participants,

-   But the intervention **did not produce a differential anti-inflammatory effect**.

**Dropout Influence**

```{r}
#Step 1: Check the distribution of visits per subject
# Count number of observations per subject
dropout_check <- data_filtered %>%
  group_by(record_id) %>%
  summarize(n_visits = n_distinct(visit)) %>%
  count(n_visits)


#Step 2: Compare dropout by group
## Last visit per subject
last_visit_by_group <- data_filtered %>%
  group_by(record_id, allocation_group) %>%
  summarize(last_visit = max(visit)) %>%
  ungroup()

# Table: proportion reaching visit 3
table(last_visit_by_group$allocation_group, last_visit_by_group$last_visit)
# This checks whether Grupo B had more missing data at later visits than Grupo A — which could confound the CRP trajectory comparison.

#Step 3: Is dropout related to baseline CRP?
# If participants who dropped out had higher baseline CRP, your results may be biased due to non-random missingness (MNAR).

# Use the baseline CRP and check whether it's different in dropouts
baseline_dropout <- data_filtered %>%
  group_by(record_id) %>%
  mutate(last_visit = max(visit)) %>%
  filter(visit == 1) %>%
  mutate(dropped_out = last_visit < 3)

# Compare baseline CRP by dropout status
t.test(log1p(labs_crp) ~ dropped_out, data = baseline_dropout)
```

```         
•   Participants who dropped out had slightly lower CRP at baseline, but the difference is not statistically significant.
•   There’s no evidence that dropout was related to baseline inflammation.
•   Dropout appears to be random with respect to baseline CRP, which supports the Missing at Random (MAR) assumption.
```

Because: • The mixed-effects model (LMM) is valid under MAR, • There’s no significant baseline CRP difference between those who stayed and those who dropped out,

➡️ Your model results are likely unbiased with respect to dropout.

```{r}
# Back-transforming predicted log(CRP + 1) values to CRP (mg/L)

# Step 1: Create a prediction grid for all combinations of visit × group
# Use the median baseline CRP for prediction (in log1p scale)
baseline_crp_median <- median(log1p(baseline_dropout$labs_crp), na.rm = TRUE)

# Create grid of new data
new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
) %>%
  mutate(log1p_baseline_crp = baseline_crp_median)

# Step 2: Predict from the adjusted model (fixed effects only)
new_data$pred_log <- predict(model3_log_adj, newdata = new_data, re.form = NA)

# Step 3: Back-transform
new_data$pred_crp <- exp(new_data$pred_log) - 1

# Step 4: Plot back-transformed predictions
ggplot(new_data, aes(x = visit, y = pred_crp, color = allocation_group, group = allocation_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  labs(
    title = "Predicted CRP Levels Over Time (Back-Transformed)",
    x = "Visit",
    y = "Predicted CRP (mg/L)",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

What this plot shows

```         
•   Predicted CRP levels in mg/L, adjusted for the median baseline CRP.
•   Makes the model output clinically interpretable.
```

You can clearly see: • The overall downward trend in CRP over time. • That Grupo B does not differ from Grupo A in rate of CRP decline after adjusting for baseline.

```{r}
# ✅ Add confidence intervals to predicted CRP plot (back-transformed)

# Load required packages
library(ggplot2)
library(dplyr)
library(merTools)  # for predictInterval

# Step 1: Create new data with baseline CRP held at median
baseline_crp_median <- median(log1p(baseline_dropout$labs_crp), na.rm = TRUE)

new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
) %>%
  mutate(
    log1p_baseline_crp = baseline_crp_median,
    record_id = "dummy"  # 👈 Add a dummy ID to match model's grouping variable
  )

# Step 2: Get prediction intervals on log scale (includes uncertainty)
set.seed(123)  # for reproducibility
pred_int <- predictInterval(
  model3_log_adj,
  newdata = new_data,
  level = 0.95,
  n.sims = 1000,
  stat = "mean",
  type = "linear.prediction",
  include.resid.var = FALSE
)

# Combine with original new_data
new_data <- bind_cols(new_data, pred_int)

# Step 3: Back-transform
new_data <- new_data %>%
  mutate(
    fit = exp(fit) - 1,
    lwr = exp(lwr) - 1,
    upr = exp(upr) - 1
  )

# Step 4: Plot with ribbons (CI)
ggplot(new_data, aes(x = visit, y = fit, color = allocation_group, group = allocation_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = allocation_group), alpha = 0.2, color = NA) +
  labs(
    title = "Predicted CRP Levels with 95% CI (Back-Transformed)",
    y = "Predicted CRP (mg/L)",
    x = "Visit",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
# Optional: Line plot of individual trajectories
ggplot(data_filtered, aes(x = visit, y = labs_crp, group = record_id, color = allocation_group)) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Individual CRP Trajectories (Raw Data)",
    y = "Observed CRP (mg/L)",
    x = "Visit",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

### 2

```{r}
data_filtered_lmm <- data_filtered %>%
  group_by(record_id) %>%
  filter(n() > 1) %>%
  ungroup()

model4_log <- lmer(log1p(labs_crp) ~ visit + bmi + age + sex + dass_score_stress + 
     labs_hba1c + labs_ggt + labs_triglycerides + allocation_group + 
     (1 | record_id), data = data_filtered_lmm)

summary(model4_log)

plot(model3_log)

qqnorm(resid(model3_log)); qqline(resid(model3_log))  # Normality check```
```
