---
title: "Main outcomes"
author: "S.P.L.M., Gustavo"
date: today
format:
  html:
    page-layout: full
    toc: true
    toc-depth: 4
    toc-float:
      collapsed: false
      smooth-scroll: true
    css: styles.css
  pdf:
    toc: true
    toc-depth: 2
    pdf-engine: xelatex
---

# Getting started

## Load data

```{r}
rm(list = ls())
graphics.off()
cat("\014")  # Clear any pending RStudio sessions or temporary files

# Load functions from external script
source("helper_functions.R")

## Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(purrr)
library(here)
library(lme4)
library(lmerTest)
library(skimr)
library(performance)

# Read Files ----
## Codebooks
codebook_dvep <- read_excel(
    "Codebooks/codebook_dvep.xlsx",
    col_names = TRUE,
    col_types = NULL,
    na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
    trim_ws = TRUE,
    skip = 0, # Number of lines to skip before reading data
    n_max = Inf, # Maximum number of lines to read.
    guess_max = 1000
) %>%
    arrange(index)

codebook_structure  <- read_csv(
    "Codebooks/codebook_structure.csv",
    col_names = TRUE)

codebook_ncit  <- read_csv(
    "Codebooks/codebook_ncit.csv",
    col_names = TRUE)

codebook_bia <- read_excel(
    "Codebooks/codebook_bia.xlsx",
    col_names = TRUE,
    col_types = NULL,
    na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
    trim_ws = TRUE,
    skip = 0, # Number of lines to skip before reading data
    n_max = Inf, # Maximum number of lines to read.
    guess_max = 1000
) %>%
    arrange(index)

## Data
data <- readRDS("Data_processed/data.rds")
data_bia <- readRDS("Data_processed/data_bia.rds")
data_bia_D1 <- readRDS("Data_processed/data_bia_D1.rds")
data_bia_D1_mean <- readRDS("Data_processed/data_bia_D1_mean.rds")
data_bia_D1_raw <- readRDS("Data_processed/data_bia_D1_raw.rds")
data_bia_D3 <- readRDS("Data_processed/data_bia_D3.rds")
data_bia_D3_mean <- readRDS("Data_processed/data_bia_D3_mean.rds")
data_bia_D3_raw <- readRDS("Data_processed/data_bia_D3_raw.rds")
data_bia_mean <- readRDS("Data_processed/data_bia_mean.rds")
data_d1_exclusive <- readRDS("Data_processed/data_d1_exclusive.rds")
data_filtered <- readRDS("Data_processed/data_filtered.rds")
data_filtered_seca <- readRDS("Data_processed/data_filtered_seca.rds")
I21_conditions_R <- readRDS("Data_processed/I21_conditions_R.rds")
I22_drugs_R <- readRDS("Data_processed/I22_drugs_R.rds")
I27_labs_R <- readRDS("Data_processed/I27_labs_R.rds")
I29_compliance_new <- readRDS("Data_processed/I29_compliance_new.rds")
I30_events_R <- readRDS("Data_processed/I30_events_R.rds")

## SUPERTIBBLE
data_instruments <- readRDS("Data_instruments/data_instruments.rds")
```

## Variables of interest

-   (1 \| record_id) + visit + allocation_group + age + sex + race + education +
-   Comorbidities: hypertension + hypercholesterolemia + hypertrigliceridemia + insulin + drugs_w_loss + drugs_w_gain
-   Anthro: abdomen + bmi + mean_bp_mean
-   Questionnaires: whoqol_score_overall + ecap_score + evs_score + dass_score_stress + dass_score_anxiety + dass_score_depression + alcohol_significant + smoke_history + carbs_kcal + protein_kcal + fat_kcal + drugs_dose_change_yn +
-   Ades√£o: completed_intervention, intervention_duration, education_years? cp_taking_as_directed_yn, cp_missed_dose_yn, cp_missed_dose_count, cp_discontinued_yn, cp_discontinued_n_days, cp_ran_out_of_drug_yn, cp_medication_confidence_sca

## Select variables

```{r}
data_model <- data_filtered %>% 
    select(
        record_id:sex,
        hypertension:ecap_score,
        abdomen, bmi, mean_bp_mean,
        resistance:evs_score,
        alcohol_dose, 
        carbs_kcal, protein_kcal, fat_kcal, kcal,
        labs_crp:labs_alkp,
        labs_cholesterol:labs_quick_index
    )

saveRDS(
    data_model,
    "Data_processed/data_model.rds")

vars_to_keep <- names(data_model)

# Step 2: filter codebook_dvep
codebook_data_model <- codebook_dvep %>%
    filter(variable %in% vars_to_keep) %>% 
    select(
        variable, label_pt, field_type, choices)

saveRDS(
    codebook_data_model,
    "Data_processed/codebook_data_model.rds")
```

## Filter codebook

```{r}
codebook_filtered <- codebook_dvep %>%
  filter(variable %in% colnames(data_model))
```

## Scaling

$${QUICKI} = \frac{1}{\\log(insulin) + log(glucose)}$$

$$
HOMA-IR = \frac{insulin * glucose}{405}
$$

```{r}
data_model_scaled <- data_model %>%
  mutate(across(
    .cols = c(
        duration_difference, age,
        whoqol_score_overall, dass_score_depression, dass_score_anxiety,
        dass_score_stress, ecap_score, 
        abdomen, bmi, mean_bp_mean,
        resistance, reactance, 
        handgrip, evs_score, alcohol_dose,
        carbs_kcal, protein_kcal, fat_kcal, kcal,
        labs_crp, labs_ast, labs_alt, labs_ggt, labs_alkp,
        labs_cholesterol, labs_ldl, labs_hba1c, labs_triglycerides,
        labs_hdl, labs_glucose, labs_insulin, labs_homa_ir
    ),
    .fns = ~ as.numeric(scale(.))
  )) 

scaling_params <- data_model %>%
  summarise(across(
    .cols = c(
      duration_difference, age,
      whoqol_score_overall, dass_score_depression, dass_score_anxiety,
      dass_score_stress, ecap_score, 
      abdomen, bmi, mean_bp_mean,
      resistance, reactance, 
      handgrip, evs_score, alcohol_dose,
      carbs_kcal, protein_kcal, fat_kcal,
      labs_crp, labs_ast, labs_alt, labs_ggt, labs_alkp,
      labs_cholesterol, labs_ldl, labs_hba1c, labs_triglycerides,
      labs_hdl, labs_glucose, labs_insulin, labs_homa_ir
    ),
    list(mean = ~mean(., na.rm = TRUE), sd = ~sd(., na.rm = TRUE))
  )) %>%
  pivot_longer(everything(),
               names_to = c("variable", ".value"),
               names_sep = "_(?=[^_]+$)",  # üëà this fixes the splitting
               names_transform = list(.value = as.character))
```

```{r, eval=FALSE}
# THEN, FOR NEW DATA
scale_with_params <- function(new_data, params) {
  for (i in seq_len(nrow(params))) {
    var <- params$variable[i]
    mean_val <- params$mean[i]
    sd_val <- params$sd[i]
    if (var %in% names(new_data)) {
      new_data[[var]] <- (new_data[[var]] - mean_val) / sd_val
    }
  }
  return(new_data)
}

new_data_scaled <- scale_with_params(new_data, scaling_params)
```

# Phase angle

Filtrando os dados da primeira e terceira visitas.

```{r}
pha_redcap <- data_model_scaled %>% 
    filter(
        visit %in% c(1, 3)
    ) %>% 
    mutate(
        compliance_score_visit = case_when(
            visit == 3 & completed_intervention == "N√£o" ~ 0,
            TRUE ~ compliance_score_visit
        )
    )
```

## Modelo 1

```{r}
pha_1 <- lmer(phase_angle ~ (1 | record_id) + visit + allocation_group + completed_intervention + duration_difference + age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + drugs_w_loss + drugs_w_gain + mean_bp_mean + handgrip + evs_score + alcohol_dose + kcal + labs_crp + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + labs_hdl + labs_quick_index, data = pha_redcap)

summary(pha_1)
```

A modelagem estat√≠stica foi conduzida por meio de um modelo linear misto, com intercepto aleat√≥rio por participante (record_id), ajustado pelo m√©todo de m√°xima verossimilhan√ßa restrita (REML). O desfecho avaliado foi o √¢ngulo de fase, e todas as vari√°veis cont√≠nuas foram previamente padronizadas (m√©dia = 0; desvio padr√£o = 1), com exce√ß√£o do √≠ndice QUICKI, mantido em sua unidade original para favorecer a interpretabilidade cl√≠nica. A vari√°vel duration_difference representa o desvio absoluto (em dias) da dura√ß√£o planejada da interven√ß√£o (90 dias), sendo ajustada para zero na linha de base e posteriormente padronizada.

O modelo incluiu 24 preditores fixos e apresentou bom ajuste, com crit√©rio REML igual a 267,6 \[um valor inferior ao do modelo anterior (REML = 275)\], indicando melhora na parcim√¥nia e qualidade do ajuste ap√≥s a redu√ß√£o de vari√°veis.

**Efeitos fixos**

Tr√™s vari√°veis demonstraram associa√ß√£o estatisticamente significativa com o desfecho:

-   Press√£o arterial m√©dia (mean_bp_mean): apresentou associa√ß√£o positiva com o √¢ngulo de fase (Œ≤ = 0,19; p = 0,045), sugerindo que n√≠veis mais elevados de press√£o arterial podem estar relacionados a melhor integridade funcional da membrana celular.
-   Dose de √°lcool (alcohol_dose): foi o preditor com maior signific√¢ncia estat√≠stica (Œ≤ = 0,25; p \< 0,001), com associa√ß√£o positiva ao √¢ngulo de fase. Este achado deve ser interpretado com cautela, podendo refletir fatores comportamentais, sociais ou nutricionais n√£o diretamente capturados no modelo.
-   Prote√≠na C reativa (labs_crp): demonstrou associa√ß√£o positiva marginalmente significativa (Œ≤ = 0,13; p = 0,032), o que pode sugerir uma rela√ß√£o complexa entre inflama√ß√£o subcl√≠nica e altera√ß√µes na composi√ß√£o ou integridade celular.

As demais vari√°veis ‚Äî incluindo visit, allocation_group, completed_intervention, duration_difference, al√©m de vari√°veis laboratoriais como labs_ldl, labs_triglycerides e labs_quick_index ‚Äî n√£o apresentaram associa√ß√µes estatisticamente significativas com o desfecho.

**Efeitos aleat√≥rios**

A vari√¢ncia associada ao intercepto aleat√≥rio por participante foi de 0,72, enquanto a vari√¢ncia residual foi de 0,11. Esse achado demonstra que h√° consider√°vel variabilidade entre os indiv√≠duos, refor√ßando a pertin√™ncia da inclus√£o do componente aleat√≥rio no modelo. Em outras palavras, parte substancial da variabilidade total no √¢ngulo de fase √© explicada por diferen√ßas interindividuais, o que justifica o uso de modelos mistos para melhor estimar os efeitos fixos, controlando tais varia√ß√µes basais.

**Considera√ß√µes metodol√≥gicas**

1.  Multicolinearidade: Dada a inclus√£o de 24 preditores em um modelo com 111 observa√ß√µes, recomenda-se avaliar a presen√ßa de colinearidade, especialmente entre vari√°veis cl√≠nicas e laboratoriais potencialmente redundantes. Sugere-se a aplica√ß√£o da fun√ß√£o performance::check_collinearity() para investigar VIFs elevados, que podem inflar erros padr√£o e comprometer a interpreta√ß√£o dos coeficientes.
2.  Redu√ß√£o de preditores: A elevada raz√£o entre o n√∫mero de preditores e o tamanho da amostra (p \> n/4) pode levar a sobreajuste (overfitting) e instabilidade nos coeficientes. Uma abordagem sugerida √© a redu√ß√£o guiada por crit√©rios de informa√ß√£o (AIC) ou penaliza√ß√£o via regress√£o LASSO (glmnet), com o objetivo de selecionar subconjuntos mais est√°veis de vari√°veis.
3.  Avalia√ß√£o da qualidade do ajuste: Recomenda-se utilizar a fun√ß√£o performance::check_model() para verificar a normalidade dos res√≠duos, homocedasticidade e presen√ßa de observa√ß√µes influentes. Al√©m disso, a obten√ß√£o dos valores de R¬≤ marginal e condicional pode auxiliar na compreens√£o da propor√ß√£o da vari√¢ncia explicada pelo modelo fixo e pelo modelo completo (incluindo os efeitos aleat√≥rios).
4.  Tratamento da vari√°vel visit: Embora visit n√£o tenha apresentado signific√¢ncia estat√≠stica no modelo atual, trata-se de uma vari√°vel importante, dado o delineamento longitudinal do estudo. Deve-se avaliar se o uso de visit como vari√°vel cont√≠nua linear √© adequado ou se uma estrutura categ√≥rica com intera√ß√£o (e.g., visit\*allocation_group) ou a inclus√£o de um termo de inclina√ß√£o aleat√≥ria por visita ((visit \| record_id)) poderia capturar melhor as trajet√≥rias individuais ao longo do tempo.

**Avalia√ß√£o da Multicolinearidade**

Dada a inclus√£o de um n√∫mero elevado de preditores no modelo (n = 24), avaliou-se a presen√ßa de multicolinearidade utilizando o Fator de Infla√ß√£o da Vari√¢ncia (VIF) por meio da fun√ß√£o performance::check_collinearity().

```{r}
performance::check_collinearity(pha_1)
# r2(pha_1)  # Marginal and conditional R¬≤
```

Resultados:

Todos os preditores apresentaram VIFs inferiores a 3, indicando aus√™ncia de multicolinearidade preocupante. Os valores variaram entre 1,13 e 2,64, o que representa correla√ß√µes lineares fracas a moderadas entre os preditores, sem risco aparente de distor√ß√µes nas estimativas dos coeficientes.

Abaixo, apresenta-se a interpreta√ß√£o convencional dos valores de VIF:

| **Valor de VIF** | **Interpreta√ß√£o**                                  |
|------------------|----------------------------------------------------|
| 1                | Aus√™ncia de correla√ß√£o com outras vari√°veis        |
| 1‚Äì2              | Correla√ß√£o baixa ‚Äî sem motivo de preocupa√ß√£o       |
| 2‚Äì5              | Correla√ß√£o moderada ‚Äî acompanhar com aten√ß√£o       |
| 5‚Äì10             | Correla√ß√£o elevada ‚Äî risco de instabilidade        |
| \> 10            | Multicolinearidade severa ‚Äî interven√ß√£o necess√°ria |

2.  Redu√ß√£o do Modelo

O modelo atual inclui 24 preditores fixos, o que, diante de uma amostra com 111 observa√ß√µes, pode comprometer o poder estat√≠stico e a interpretabilidade dos resultados devido ao risco de sobreajuste (overfitting).

A escolha da melhor abordagem para simplificar o modelo depende do objetivo central da an√°lise:

a)  Modelos orientados por desempenho (predi√ß√£o)

Caso o foco seja a performance preditiva, o uso de estrat√©gias orientadas por dados √© mais apropriado:

-   Sele√ß√£o stepwise (backward) com base em crit√©rios de informa√ß√£o como AIC ou BIC. O AIC favorece modelos com melhor ajuste (ainda que mais complexos), enquanto o BIC imp√µe maior penalidade √† complexidade, favorecendo modelos mais parcimoniosos.

-   Regress√£o penalizada via LASSO (glmnet), que tende a selecionar subconjuntos est√°veis de vari√°veis ao impor penaliza√ß√µes sobre os coeficientes, sendo especialmente √∫til em situa√ß√µes com colinearidade moderada e alta dimensionalidade de preditores.

b)  Modelos orientados por infer√™ncia e explica√ß√£o

Quando o objetivo principal √© a interpreta√ß√£o causal ou explicativa, como em estudos cl√≠nicos e interven√ß√µes, a estrat√©gia mais robusta √© a redu√ß√£o te√≥rica guiada por plausibilidade cl√≠nica. Essa abordagem inclui:

-   Remo√ß√£o de vari√°veis com baixa signific√¢ncia estat√≠stica e sem fundamento te√≥rico forte;

-   Exclus√£o de vari√°veis redundantes ou fortemente correlacionadas (ex.: manter labs_quick_index e excluir glicemia/insulina);

-   Aten√ß√£o a comportamentos inst√°veis dos coeficientes ‚Äî por exemplo, quando a dire√ß√£o (sinal) de um coeficiente muda com a inclus√£o de outras vari√°veis, indicando colinearidade ou sobreposi√ß√£o de efeitos.

c)  Estrat√©gia h√≠brida recomendada

Uma estrat√©gia combinada, adequada ao contexto de ensaio cl√≠nico com m√∫ltiplas covari√°veis, pode envolver: 1. Fixar um conjunto m√≠nimo de vari√°veis-chave (ex.: idade, sexo, grupo de interven√ß√£o, tempo); 2. Aplicar redu√ß√£o stepwise ou LASSO nas demais covari√°veis; 3. Comparar modelos reduzidos com o modelo completo utilizando ANOVA (anova()), gr√°ficos de res√≠duos e crit√©rios de ajuste (REML, AIC, BIC), assegurando que a simplifica√ß√£o n√£o comprometa o desempenho do modelo.

3.  Avalia√ß√£o do Ajuste do Modelo

A verifica√ß√£o dos pressupostos estat√≠sticos do modelo pha_1 foi realizada com a fun√ß√£o performance::check_model(). Os principais achados foram:

-   Ajuste geral: Os gr√°ficos de verifica√ß√£o preditiva (posterior predictive checks) mostraram boa sobreposi√ß√£o entre os valores observados e os preditos, indicando adequa√ß√£o geral do modelo.

-   Res√≠duos vs. valores ajustados: Foi observado leve desvio da horizontalidade nas faixas mais altas do desfecho, sugerindo poss√≠vel viola√ß√£o da linearidade para valores elevados do √¢ngulo de fase.

-   Homoscedasticidade: Detectou-se aumento da vari√¢ncia dos res√≠duos com o aumento dos valores preditos, caracterizando uma leve viola√ß√£o da homocedasticidade.

-   Normalidade dos res√≠duos: Os res√≠duos apresentaram distribui√ß√£o aproximadamente normal, com pequenas assimetrias nas caudas ‚Äî aceit√°veis em modelos mistos com amostras de tamanho moderado.

-   Influ√™ncia de observa√ß√µes: Algumas observa√ß√µes apresentaram leve influ√™ncia (IDs 10, 69, 70, 75, 109), mas nenhuma ultrapassou os limiares cr√≠ticos para alavancagem ou res√≠duos padronizados extremos.

-   Colinearidade: Todos os VIFs estiveram abaixo de 3, indicando aus√™ncia de multicolinearidade significativa.

-   Efeitos aleat√≥rios: A distribui√ß√£o dos interceptos aleat√≥rios (por record_id) se aproximou da normalidade, refor√ßando a adequa√ß√£o da estrutura hier√°rquica adotada.

5.  Refinamento da Vari√°vel visit

Dado o delineamento longitudinal do estudo, a vari√°vel visit merece aten√ß√£o especial. No modelo atual, visit foi inclu√≠da como efeito fixo com estrutura linear. No entanto, isso pode ser sub√≥timo caso o efeito do tempo varie entre participantes.

Tentativas de incorporar uma inclina√ß√£o aleat√≥ria por visit resultaram em:

```         
lmer(phase_angle ~ visit + (visit | record_id), data = ...)
# Erro: n√∫mero de observa√ß√µes (=111) ‚â§ n√∫mero de efeitos aleat√≥rios (=146)
```

Isso indica que h√° insufici√™ncia de dados para estimar uma estrutura t√£o complexa. A alternativa:

```         
lmer(phase_angle ~ visit + (1 + visit || record_id), data = ...)
# Resultado: ajuste singular (boundary (singular) fit)
```

Esse ajuste singular significa que o modelo n√£o consegue estimar a vari√¢ncia da inclina√ß√£o aleat√≥ria para visit de forma confi√°vel, sugerindo aus√™ncia de varia√ß√£o individual suficiente ou tamanho amostral limitado para suportar tal estrutura.

Conclus√£o:

No momento, manter visit como efeito fixo linear √© estatisticamente mais robusto. Caso haja interesse em investigar mudan√ßas espec√≠ficas ao longo das visitas, uma abordagem alternativa seria tratar visit como vari√°vel categ√≥rica e incluir intera√ß√µes com allocation_group, por exemplo:

```         
phase_angle ~ allocation_group * factor(visit) + ...
```

Essa estrutura permite verificar se a evolu√ß√£o do √¢ngulo de fase ao longo do tempo difere entre os grupos, sem sobrecarregar o modelo com componentes aleat√≥rios inst√°veis.

## Modelo 2

```{r}
pha_2 <- lmer(phase_angle ~ (1 | record_id) + visit + allocation_group + age + sex + bmi + mean_bp_mean + handgrip + evs_score + kcal + labs_crp + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + labs_hdl + labs_quick_index, data = pha_redcap)

summary(pha_2)
```

> AIC(pha_1, pha_2) df AIC pha_1 26 319.5554 pha_2 19 313.6283

> BIC(pha_1, pha_2) df BIC pha_1 26 390.0032 pha_2 19 365.1094

A compara√ß√£o entre os modelos pelo crit√©rio de informa√ß√£o de Akaike (AIC) e o crit√©rio bayesiano de informa√ß√£o (BIC) favoreceu o modelo reduzido (pha_2), que apresentou valores mais baixos de AIC (313,6 vs. 319,6) e BIC (365,1 vs. 390,0) em rela√ß√£o ao modelo completo (pha_1). Isso sugere que a simplifica√ß√£o do modelo resultou em melhor equil√≠brio entre ajuste e complexidade, mesmo com a perda de signific√¢ncia estat√≠stica de algumas covari√°veis previamente relevantes. No entanto, v√°rias vari√°veis de relev√¢ncia cl√≠nica foram eliminadas neste modelo. Por este motivo, um terceiro modelo foi criado, incluindo as vari√°veis de relev√¢ncia cl√≠nica que n√£o foram inclu√≠das no modelo 2.

## Modelo 3

```{r}
pha_3 <- lmer(phase_angle ~ (1 | record_id) + visit + allocation_group + completed_intervention + duration_difference + age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + drugs_w_loss + drugs_w_gain + mean_bp_mean + handgrip + evs_score + alcohol_dose + kcal + labs_crp + labs_ldl + labs_quick_index, data = pha_redcap)

summary(pha_3)

check_collinearity(pha_3)

AIC(pha_1, pha_2, pha_3)
BIC(pha_1, pha_2, pha_3)

r2(pha_3)
```

```{r pha_3_check-model, fig.width=10, fig.height=14}
pha_3_plots <- performance::check_model(pha_3)
print(pha_3_plots)
```

**Compara√ß√£o entre Modelos e Avalia√ß√£o do Ajuste Final**

Tr√™s modelos hier√°rquicos foram comparados utilizando os crit√©rios de informa√ß√£o de Akaike (AIC) e Bayesiano (BIC). O modelo pha_3, contendo 22 preditores fixos e intercepto aleat√≥rio por participante (record_id), apresentou os menores valores de AIC (300,2) e BIC (359,8), superando o modelo completo pha_1 (AIC = 319,6; BIC = 390,0) e o modelo intermedi√°rio pha_2 (AIC = 313,6; BIC = 365,1). Esses resultados indicam que pha_3 representa o melhor equil√≠brio entre qualidade de ajuste e parcim√¥nia, sendo selecionado como modelo final para interpreta√ß√£o dos achados.

A constru√ß√£o do modelo pha_3 foi guiada por crit√©rios estat√≠sticos e cl√≠nicos, priorizando vari√°veis com signific√¢ncia nas vers√µes anteriores, plausibilidade te√≥rica e estabilidade das estimativas. O modelo manteve 22 preditores e apresentou um crit√©rio de m√°xima verossimilhan√ßa restrita (REML) igual a 256,2, inferior ao dos modelos anteriores, refor√ßando a melhoria no ajuste.

Entre os preditores avaliados, tr√™s vari√°veis mantiveram associa√ß√£o estatisticamente significativa com o desfecho:

-   Press√£o arterial m√©dia (mean_bp_mean): Œ≤ = 0,18; p = 0,040

-   Dose de √°lcool (alcohol_dose): Œ≤ = 0,25; p \< 0,001

-   Prote√≠na C reativa (labs_crp): Œ≤ = 0,12; p = 0,035

Essas associa√ß√µes permaneceram robustas mesmo ap√≥s ajuste multivariado, sugerindo que n√≠veis mais elevados de press√£o arterial, maior consumo de √°lcool e n√≠veis mais altos de inflama√ß√£o subcl√≠nica est√£o positivamente relacionados ao √¢ngulo de fase. A vari√°vel visit foi mantida no modelo como controle temporal, apesar de n√£o apresentar signific√¢ncia estat√≠stica (p = 0,432).

A vari√¢ncia do intercepto aleat√≥rio por participante permaneceu elevada (œÉ¬≤ = 0,68), corroborando a presen√ßa de heterogeneidade individual e justificando a estrutura mista do modelo. O R¬≤ marginal foi de 0,250, indicando que 25% da vari√¢ncia total do desfecho √© explicada pelas vari√°veis fixas. J√° o R¬≤ condicional foi de 0,896, refletindo a alta propor√ß√£o da vari√¢ncia explicada ao considerar a estrutura de efeitos aleat√≥rios, em conson√¢ncia com o delineamento longitudinal do estudo.

A an√°lise de multicolinearidade mostrou valores de VIF menor que tr√™s para todos os preditores, descartando problemas relevantes de colinearidade. Os diagn√≥sticos do modelo indicaram distribui√ß√£o adequada dos res√≠duos, aus√™ncia de observa√ß√µes altamente influentes e normalidade satisfat√≥ria dos efeitos aleat√≥rios, corroborando a adequa√ß√£o do modelo ajustado.

**Verifica√ß√£o dos Pressupostos do Modelo Final**

A avalia√ß√£o dos pressupostos do modelo pha_3 foi realizada com aux√≠lio da fun√ß√£o performance::check_model(), cujos gr√°ficos diagn√≥sticos est√£o apresentados na Figura X.

-   Posterior Predictive Check: Houve boa sobreposi√ß√£o entre os dados observados e os valores preditos pelo modelo, sugerindo adequada capacidade preditiva.

-   Linearidade: Os res√≠duos apresentaram tend√™ncia de curvatura em valores mais altos do desfecho, o que pode indicar leve viola√ß√£o do pressuposto de linearidade, mas sem evid√™ncias de distor√ß√£o grave.

-   Homoscedasticidade: Detectou-se discreto aumento da variabilidade dos res√≠duos em faixas mais altas dos valores ajustados, sugerindo leve heterocedasticidade.

-   Normalidade dos res√≠duos: A distribui√ß√£o dos res√≠duos foi aproximadamente normal, com desvios leves nas caudas, aceit√°veis para modelos mistos em amostras moderadas.

-   Observa√ß√µes influentes: Algumas observa√ß√µes foram marcadas com leve alavancagem (IDs 10, 69, 70, 75, 109), mas todas permaneceram dentro dos limites aceit√°veis de influ√™ncia.

-   Multicolinearidade: Todos os preditores apresentaram valores de VIF inferiores a 3, afastando preocupa√ß√µes com colinearidade.

-   Normalidade dos efeitos aleat√≥rios (record_id): A distribui√ß√£o dos interceptos aleat√≥rios foi pr√≥xima da normal, com leve assimetria nas extremidades, validando a escolha do modelo com intercepto aleat√≥rio.

# PCR

## Scaling

```{r}
data_crp <- data_model %>%
  mutate(across(
    .cols = c(
        duration_difference, age,
        whoqol_score_overall, dass_score_depression, dass_score_anxiety, dass_score_stress, ecap_score, 
        abdomen, bmi, mean_bp_mean,
        phase_angle, resistance, reactance, 
        handgrip, evs_score, alcohol_dose,
        carbs_kcal, protein_kcal, fat_kcal, kcal,
        labs_ast, labs_alt, labs_ggt, labs_alkp,
        labs_cholesterol, labs_ldl, labs_hba1c, labs_triglycerides,
        labs_hdl, labs_glucose, labs_insulin, labs_homa_ir
    ),
    .fns = ~ as.numeric(scale(.))
  )) %>% 
    rename(
        crp_raw = labs_crp
    ) %>% 
    mutate(
        crp_log = log1p(crp_raw),
        crp_log_scaled = as.numeric(scale(crp_log))
    ) %>% 
    relocate(
        crp_log, crp_log_scaled, .after = crp_raw
    )
```

```{r}
data_crp <- data_crp %>%
  dplyr::mutate(
    compliance_score_adjusted = dplyr::case_when(
      visit == 1 ~ 1,
      TRUE ~ compliance_score_visit
    )
  ) %>%
  dplyr::relocate(compliance_score_adjusted, .after = compliance_score_visit)
```

## Per protocol

```{r pcr_1_check-model, fig.width=10, fig.height=14}

pcr_1 <- lmer(
  crp_log ~ 
      allocation_group + visit + 
      duration_difference + # compliance_score_adjusted + completed_intervention 
      (1 | record_id) +
      age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + drugs_w_loss + drugs_w_gain + 
      bmi + mean_bp_mean + handgrip + evs_score + # phase angle +
      # whoqol_score_overall + dass_score_depression + dass_score_anxiety + dass_score_stress + ecap_score
      alcohol_dose + kcal + 
      labs_alt + labs_ggt + labs_ldl + labs_triglycerides + labs_hdl + labs_quick_index,
  data = data_crp
)
summary(pcr_1)

check_collinearity(pcr_1)

AIC(pcr_1)
BIC(pcr_1)

r2(pcr_1)
```

```{r}
pcr_1_plots <- performance::check_model(pcr_1)
print(pcr_1_plots)
```

**Full Analysis of the Final Parsimonious Model**

1.  Model Fit

-   **AIC:** 313.95 (lowest among previous tested models)
-   **BIC:** 382.13
-   **Conditional R¬≤:** 0.576 (variance explained by fixed + random effects)
-   **Marginal R¬≤:** 0.293 (variance explained by fixed effects)

This is a well-balanced model with the best AIC/BIC trade-off seen so far, offering high parsimony without sacrificing explanatory power.

2.  Significant Predictors

| Predictor | Estimate | p-value | Interpretation |
|-------------|-------------|-------------|-----------------------------------|
| **Duration difference** | -0.275 | 0.0076 | Each SD increase in deviation from planned duration predicts a \~24% reduction in CRP (exp(-0.275) ‚âà 0.76). This suggests that **poor adherence is strongly associated with lower inflammation reduction**. |
| **EVS score** | 0.168 | 0.0269 | Surprisingly, higher physical activity correlates with **higher CRP**, which may warrant further investigation (possible reverse causality, measurement error, or confounding). |
| **Labs_quick_index** | -7.897 | 0.0205 | A strong inverse association with CRP, reflecting the metabolic-inflammation relationship where better insulin sensitivity predicts lower CRP. |

Borderline - **BMI:** p = 0.061 ‚Äî higher BMI tends to associate with higher CRP, close to significance.

3.  Non-Significant Predictors

-   Allocation group, visit number, age, sex, hypertension, cholesterol, triglycerides, blood pressure, handgrip strength, alcohol, kcal intake, and most lab biomarkers (ALT, GGT, LDL, HDL, triglycerides) are **not significant**.

This reinforces that **adherence (duration difference)** and **metabolic status (quick index)** are primary drivers of CRP changes, while the intervention itself (allocation_group) does not show an effect after accounting for adherence.

4.  Diagnostics

-   Posterior Predictive Check: The model-predicted density aligns well with observed CRP log values, suggesting good distributional fit.
-   Linearity: Residuals are roughly centered but some curvature appears, indicating minor deviations from perfect linearity.
-   Homogeneity of Variance: Slight funneling with higher fitted values showing slightly more variance, but overall acceptable.
-   Influential Observations: A few leverage points (IDs 106, 59, 75, 107) exist but are within acceptable Cook's distance boundaries.
-   Collinearity: All VIFs are low to moderate (max \~3.26 for sex), indicating no problematic collinearity.
-   Normality: Residuals are reasonably normal with some right-side tails, typical for CRP-type biomarkers.
-   Random Effects:The QQ plot of random effects shows a reasonable alignment with normality assumptions.

5.  Interpretation

-   The model confirms that **adherence to the study duration (duration_difference)** is a major determinant of CRP reduction, suggesting that participants who better adhered to the study protocol (in terms of time on the intervention) achieved better inflammatory outcomes.

-   **Insulin sensitivity (labs_quick_index)** remains a key independent predictor of CRP, aligning with well-established metabolic-inflammation links.

The unexpected positive association between **EVS (physical activity)** and CRP could be due to:

-   Reverse causality (participants with higher CRP are advised to exercise more)
-   Measurement limitations of EVS
-   Confounding from unmeasured variables (e.g., acute inflammatory events or infections)

The lack of direct intervention effect (**allocation_group**) suggests the effect operates through **adherence** rather than treatment allocation per se, fitting a **per-protocol-like** model interpretation.

6.  Conclusion

-   The model is statistically solid, with good fit and no major assumption violations.
-   The final model captures the essence of this study: **inflammatory outcomes are driven by adherence and metabolic status rather than random allocation alone**.
-   This model is robust, parsimonious, and clinically interpretable.

7.  Recommendation

-   Report this model as the main per-protocol analysis.
-   Discuss the adherence effect in the context of real-world clinical applicability.
-   Consider a sensitivity analysis exploring the unexpected positive EVS-CRP relationship.

### Heteroscedasticity

Heteroscedasticity is a violation of linear mixed model assumptions, and we‚Äôre already applying a log transformation on the outcome (log1p(crp)) plus standardizing all numeric predictors. When log-transforming the outcome is not fully sufficient, it indicates either residual skewness, heavy tails, or that the Gaussian error assumption doesn‚Äôt capture the data-generating process well.

*Modeling strategies to address this issue:*

**Generalized Linear Mixed Model (GLMM) with Non-Gaussian Distribution**

Given the characteristics of your outcome variable (**CRP**, which is strictly positive, right-skewed, and heteroscedastic), moving from a Gaussian-based LMM to a **Generalized Linear Mixed Model (GLMM)** with an appropriate distribution is both statistically justified and likely to yield better model fit.

1. Theoretical Justification

- **CRP is a continuous, positive, right-skewed variable.**
- Log-transforming CRP partially addresses skewness but doesn't fully solve: Heteroscedasticity (as your diagnostic plots show); The misspecification from assuming normal residuals.
- GLMM allows you to model CRP with a distribution that reflects its natural properties rather than forcing it into Gaussian assumptions.

2. Addressing Heteroscedasticity

- Your residual plots still show **variance increasing with fitted values** ‚Äî a classic signal that a Gaussian model is a poor fit for the scale of your data.
- GLMMs inherently model mean-variance relationships correctly for non-normal distributions.

3. Precedent in Biomedical Literature. Biomarkers like CRP are frequently modeled with:

- **Gamma distribution with log link** (most common for positive, skewed continuous outcomes).
- **Inverse Gaussian** (alternative when the data have very heavy tails).
- This approach is standard in fields like clinical epidemiology, pharmacometrics, and biomarker research.

Practical Advantages. Coefficients remain on the **log scale**, similar to your LMM with log(CRP), but:

- You model CRP in its native distribution rather than relying on transformation.
- **Heteroscedasticity becomes irrelevant**, because Gamma models naturally assume variance increases with the mean.
- Interpretation becomes **multiplicative**, which is often more intuitive for clinicians and health scientists (e.g., "a 20% increase in CRP per unit change in X").

Potential Models to Fit
- `glmer()` from **lme4**
- `glmmTMB()` from **glmmTMB** ‚Äî more flexible and often preferred for Gamma models.

If the log-transformed CRP still shows heteroscedasticity, the Gaussian model may be inherently misspecified. A GLMM can explicitly model the distribution of the outcome with an appropriate family. Candidates:

-   Gamma GLMM: For strictly positive, right-skewed outcomes like CRP.
-   Inverse Gaussian GLMM: Also for skewed continuous data, with heavier tails.
-   Log-normal GLMM: Another valid approach when a log transformation stabilizes variance but doesn‚Äôt fully normalize residuals.

#### GLMM

```{r}
library(glmmTMB)

pcr_glmm <- glmmTMB(
  crp_raw ~ 
      allocation_group + visit + duration_difference + 
      (1 | record_id) + 
      age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia +
      drugs_w_loss + drugs_w_gain + bmi + mean_bp_mean + handgrip + evs_score + 
      alcohol_dose + kcal + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + 
      labs_hdl + labs_quick_index,
  data = data_crp,
  family = Gamma(link = "log")
)

summary(pcr_glmm)

check_collinearity(pcr_glmm)

AIC(pcr_glmm)
BIC(pcr_glmm)

r2(pcr_glmm)

pcr_glmm_plots <- performance::check_model(pcr_1)
print(pcr_glmm_plots)
```

**Full Analysis of the GLMM (Gamma, Log-Link)**

*Model Fit and Diagnostics*

- AIC: 636.7
- BIC: 704.9
- Marginal R¬≤: 0.385 (variance explained by fixed effects)
- Conditional R¬≤: 0.676 (variance explained by fixed + random effects)

*Interpretation:*

- This represents a substantial improvement in explained variance relative to the linear mixed model (marginal R¬≤ ~0.29).
- The higher conditional R¬≤ suggests that between-subject variability (random intercept) remains important.

*Diagnostics:*
- Posterior Predictive Check: Good alignment between model-predicted density and observed data. No major distributional misspecification.
- Linearity: Acceptable. Slight deviations, but no systematic bias.
- Homoscedasticity: Vastly improved relative to the LMM. The variance is well-behaved along the fitted line, which is expected for a Gamma model.
- Normality of Residuals: Strong. No heavy tails or skewness issues.
- Influential Observations: Leverage and residual plots are within safe boundaries. No problematic points.
- Collinearity: VIFs are all below 3.3, no collinearity concerns.

 Key Fixed Effects

| Variable               | Estimate | p-value  | Interpretation                                 |
|------------------------|----------|----------|-------------------------------------------------|
| Intercept          | 4.807    | 0.002    | Baseline CRP level (on log scale)              |
| Duration Difference| -0.420   | 0.0005   | Significant. Each 1 SD longer than planned duration leads to a 34% reduction in CRP (exp(-0.42) ‚âà 0.66) |
| EVS Score          | 0.233    | 0.012    | Significant. Higher physical activity is associated with 26% higher CRP, which is counterintuitive and requires biological scrutiny. May reflect confounding. |
| Labs QUICKI        | -11.246  | 0.012    | Strongly significant. Higher insulin sensitivity leads to >99% reduction in CRP, suggesting a very steep relationship in the data. Likely influenced by scaling. |
| Allocation Group   | 0.174    | 0.407    | Not significant. Consistent with a per-protocol analytical framework. |
| Visit              | 0.037    | 0.687    | Not significant. No residual time effect beyond the modeled variables. |
| BMI                | 0.170    | 0.112    | Borderline. Each SD increase in BMI tends to raise CRP by ~18%, but not significant at p<0.05. |

All other clinical covariates (age, sex, hypertension, lipid markers, liver enzymes) were non-significant, indicating that the major drivers in this dataset are related to treatment adherence (duration), metabolic health (QUICKI), and physical activity (EVS).

 Biological Plausibility

- Duration Difference Negative Effect: Completely plausible. Lower deviation from planned duration (i.e., better adherence) leads to reduced inflammation, as expected.
- QUICKI Negative Effect: Consistent with insulin resistance being a pro-inflammatory state. The very large coefficient likely reflects the scale of QUICKI (small numeric values like ~0.3‚Äì0.4).
- EVS Positive Effect: Counterintuitive. Suggests participants with higher reported physical activity had higher CRP. This could be:
  - A measurement error in EVS (self-reported bias).
  - Confounding by illness severity (e.g., those with higher baseline CRP trying to increase activity).
  - An artifact of the small sample size.
  - Worth sensitivity testing.

 Model Performance

- This GLMM offers superior handling of heteroscedasticity compared to the LMM.
- The residual plots confirm that variance increases with the mean, which the Gamma distribution models correctly.
- The gain in marginal R¬≤ from ~0.29 (LMM) to 0.385 (GLMM) is meaningful.
- Model is stable with no multicollinearity, good residual behavior, and sound random effects distribution.

 Conclusion

- This GLMM is statistically robust and biologically meaningful.
- The key drivers of CRP in this study are:
  - Adherence (duration difference).
  - Insulin sensitivity (QUICKI).
  - Physical activity (EVS), with a result that warrants further scrutiny.

 Recommendation

- Yes, this model should be your primary model for reporting.
- Report exponentiated coefficients for clinical interpretability.
- Consider sensitivity analyses:
  - Check whether removing outliers or modifying EVS affects results.
  - Test a simplified model without EVS to observe stability.
- Prepare Results and Discussion sections reflecting that GLMM offered a better statistical fit than LMM due to the appropriate modeling of the CRP distribution.

 If you want, I can help you draft the precise sentences for the manuscript results and discussion.
 
#### Tweedie

```{r}
# Load required libraries
library(glmmTMB)
library(performance)
library(ggeffects)
library(DHARMa)

# Fit the Tweedie GLMM
pcr_tweedie <- glmmTMB(
  crp_raw ~ 
    allocation_group + visit + duration_difference + 
    (1 | record_id) + 
    age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + 
    drugs_w_loss + drugs_w_gain + bmi + mean_bp_mean + handgrip + evs_score + 
    alcohol_dose + kcal + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + 
    labs_hdl + labs_quick_index,
  data = data_crp,
  family = tweedie(link = "log")
)

# Summary of the model
summary(pcr_tweedie)

# Check collinearity
check_collinearity(pcr_tweedie)

# Model fit indices
AIC(pcr_tweedie)
BIC(pcr_tweedie)

# R-squared
r2(pcr_tweedie)

# Residual diagnostics with DHARMa
simulation_output <- simulateResiduals(fittedModel = pcr_tweedie)
plot(simulation_output)

# Model diagnostics with performance
check_model(pcr_tweedie)

# Plot predicted effects for key variables (example: allocation group)
ggeffects::ggpredict(pcr_tweedie, terms = "allocation_group") %>%
  plot()

# Plot for a continuous variable (example: evs_score)
ggeffects::ggpredict(pcr_tweedie, terms = "evs_score [all]") %>%
  plot()
```

Is the Tweedie better than the simple GLMM?

1. Model Fit Comparison

| Model            | AIC   | BIC   | Conditional R¬≤ | Marginal R¬≤ |
|------------------|-------|-------|----------------|-------------|
| GLMM (Gamma)     | 636.7 | 704.9 | 0.676          | 0.385       |
| GLMM (Tweedie)   | 638.3 | 709.2 | 0.698          | 0.379       |

- The AIC and BIC are slightly better for the Gamma model, but the difference is negligible (<2 points).
- The Tweedie has a slightly higher Conditional R¬≤, meaning it captures slightly more total variance.
- Marginal R¬≤ is essentially the same.

2. Residual Diagnostics

| Diagnostic Aspect      | GLMM (Gamma) | GLMM (Tweedie) |
|------------------------|---------------|-----------------|
| Homogeneity            | Some issue    | Some issue      |
| Normality of residuals | Acceptable    | Slightly better |
| DHARMa tests           | Passed        | Passed          |

- Both models show mild heteroscedasticity.
- Tweedie has slightly better QQ residual behavior.
- Both models pass DHARMa diagnostics.

3. Theoretical Suitability

- Gamma assumes positive continuous data with variance proportional to the mean squared.
- Tweedie is more flexible, with variance proportional to mean^p (p between 1 and 2 for continuous positive skewed data).
- Tweedie generalizes Gamma and is conceptually better for heavily right-skewed biomedical data like CRP.

4. Practical Implications

- The estimates of fixed effects are very similar between models.
- The same predictors are statistically significant in both.

5. Conclusion

- Statistically: Not clearly better. Equivalent fit with negligible differences.
- Conceptually: Tweedie is preferable because it has a more flexible variance structure suitable for this kind of data.
- Recommendation: Tweedie is more defensible for publication. Both models yield consistent conclusions, which reinforces the robustness of the results.

Parameter Estimates Comparison

| Predictor              | Gamma Estimate | Tweedie Estimate | Direction  | Significance |
|------------------------|----------------|------------------|------------|--------------|
| (Intercept)            | 4.807          | 4.564            | Positive   | **           |
| allocation_groupGrupoB | 0.174          | 0.155            | Positive   | ns           |
| visit                  | 0.037          | 0.030            | Positive   | ns           |
| duration_difference    | -0.420         | -0.414           | Negative   | ***          |
| age                    | -0.012         | -0.015           | Negative   | ns           |
| sexMasculino           | -0.510         | -0.504           | Negative   | ns           |
| hypertension1          | -0.002         | -0.008           | Negative   | ns           |
| hypercholesterolemia1  | 0.118          | 0.105            | Positive   | ns           |
| hypertrigliceridemia1  | 0.251          | 0.259            | Positive   | ns           |
| drugs_w_loss1          | 0.284          | 0.283            | Positive   | ns           |
| drugs_w_gain1          | 0.337          | 0.320            | Positive   | ns           |
| bmi                    | 0.170          | 0.169            | Positive   | . (trend)    |
| mean_bp_mean           | -0.103         | -0.096           | Negative   | ns           |
| handgrip               | -0.062         | -0.060           | Negative   | ns           |
| evs_score              | 0.233          | 0.223            | Positive   | *            |
| alcohol_dose           | -0.005         | -0.009           | Negative   | ns           |
| kcal                   | 0.118          | 0.110            | Positive   | ns           |
| labs_alt               | -0.062         | -0.062           | Negative   | ns           |
| labs_ggt               | 0.042          | 0.038            | Positive   | ns           |
| labs_ldl               | 0.167          | 0.166            | Positive   | ns           |
| labs_triglycerides     | -0.144         | -0.134           | Negative   | ns           |
| labs_hdl               | 0.016          | 0.016            | Positive   | ns           |
| labs_quick_index       | -11.246        | -10.450          | Negative   | *            |

- Direction of effect is consistent across both models.
- Significance patterns are identical.

Summary: Tweedie offers slightly better conceptual fit without compromising statistical robustness. Both models are valid and lead to the same scientific conclusions.

#### Other models

1. Linear Mixed Model on ŒîCRP (Change Score). Collapse the data to one row per participant and model the change in CRP from baseline to final visit. This often reduces heteroscedasticity since we‚Äôre modeling change rather than absolute levels.

2. Quantile Mixed Models. Instead of modeling the mean, quantile models can model medians or other quantiles, which are robust to heteroscedasticity and skewness. Example package: lqmm. Models the median instead of the mean ‚Äî inherently robust to heteroscedasticity.

3. Robust Mixed Models. Mixed models with robust estimation of residual variance, less sensitive to heteroscedasticity or outliers. Same formula as LMM, but with robust handling of residual variance.

4. Model the Raw CRP with a Two-Part Model (If Many Zeros). If there are many zeros or very low values, a two-part hurdle model or zero-inflated model may better capture the data structure. This is less common for CRP unless a substantial portion is zero or below detection limit.

Recommendation hierarchy: 1. First choice: ‚Üí Try Gamma GLMM with log link using glmmTMB ‚Äî best suited for continuous, right-skewed, strictly positive outcomes like CRP. 2. If interest is in change rather than absolute levels: ‚Üí Model ŒîCRP (change score) with LMM. 3. If robustness to outliers is crucial: ‚Üí Try robust mixed models or quantile mixed models.

## Modeling compliance

Since the goal is to evaluate whether the intervention (allocation_group) reduces inflammation (log1p(labs_crp)), then how compliance-related variables are handled ‚Äî completed_intervention, compliance_score_adjusted, and duration_difference ‚Äî fundamentally changes what question the model is answering.

**Key Conceptual Framework**

If we adjust for compliance variables, then we are answering the question: Among those who complied (to varying degrees), does the assigned intervention have an effect on inflammation?‚Äù. This estimates the ‚ÄúEffect of Treatment on the Treated‚Äù (ETT) or per-protocol effect, rather than the intention-to-treat (ITT) effect. The interpretation shifts towards whether the efficacy of the treatment holds after accounting for how well participants adhered. If participants in the intervention group did not comply, the model adjusts for that, isolating the treatment effect conditional on compliance. However, if compliance is strongly influenced by the intervention (as is common), adjusting for it may introduce **post-treatment bias (collider bias)**, because we‚Äôre conditioning on a variable that is downstream of the allocation.

If we do not adjust for compliance, then we are estimating the intention-to-treat (ITT) effect: ‚ÄúDoes being assigned to the intervention reduce inflammation, regardless of whether participants fully complied?‚Äù. This reflects the real-world effectiveness including factors like dropout, low adherence, etc. This is the primary approach in most randomized trials because it preserves the randomization balance and avoids bias introduced by post-treatment variables.

In the current model, we are conditioning the effect of allocation_group on adherence. The coefficient for allocation_group in this case answers: ‚ÄúGiven the same level of adherence (completion, dose, duration), is the intervention effective in reducing inflammation?‚Äù In other words, we‚Äôre stripping out the pathway by which poor adherence could dilute the intervention effect. If these variables are strong mediators of the intervention‚Äôs effect, we are blocking part of the effect of allocation_group, and this might explain why allocation_group is not significant.

**Correct Modeling Strategy**

Depends on our goal:

1.  To estimate the pure biological effect of the intervention (conditional on adherence):

    -   Keep compliance_score_adjusted, completed_intervention, and duration_difference in the model.
    -   Interpret the effect of allocation_group as the effect assuming equal adherence across groups.

2.  To estimate the real-world effectiveness (intention-to-treat):

    -   Remove the compliance-related variables from the model.
    -   The coefficient for allocation_group will capture the total effect, including any dilution due to poor adherence.

![](images/DAG:%20Relationship%20between%20Intervention,%20Compliance,%20and%20Inflammation.png)

The DAG (Directed Acyclic Graph) represents the causal relationships between the intervention, adherence, and inflammation. In this structure, Allocation Group has a direct effect on Inflammation (labs_crp) and also influences Compliance, Completed Intervention, and Duration Difference, which are measures of adherence. These adherence-related variables, in turn, affect Inflammation, indicating that part of the intervention‚Äôs effect is mediated through adherence. Additionally, a hypothetical Unmeasured Factors node, representing elements such as motivation, health status, or life circumstances, influences both Compliance and Inflammation. This creates a potential collider if the analysis conditions on adherence-related variables.

The DAG highlights that adjusting for compliance, completion, or duration blocks part of the natural causal pathway through which the intervention affects inflammation. Moreover, conditioning on these variables opens a backdoor path through Unmeasured Factors, introducing potential collider bias.

This structure demonstrates that the choice between intention-to-treat (ITT) and per-protocol (PP) analysis changes the research question. In ITT analysis, the effect of the Allocation Group on inflammation is estimated without conditioning on adherence, capturing the total effect, including both direct and adherence-mediated pathways. This approach preserves the benefits of randomization and estimates the real-world effectiveness of the intervention. In contrast, per-protocol analysis includes adherence-related variables in the model. This blocks the indirect pathways through adherence and estimates the effect of the intervention among participants with comparable adherence. While this approach can answer questions about biological efficacy conditional on adherence, it carries a higher risk of bias due to conditioning on post-randomization variables.

**Suggested Dual Approach (Best Practice in Clinical Research)**

1.  Primary Model (ITT) without compliance variables. This estimates whether the offer of the intervention reduces inflammation.

```         
log1p(labs_crp) \~ allocation_group + visit + (1 \| record_id) + covariates
```

2.  Secondary Model (Per-Protocol Sensitivity Analysis) with compliance variables. This estimates whether the intervention works among those who actually adhered to it, or to account for variability in exposure.

```         
log1p(labs_crp) \~ allocation_group + compliance_score_adjusted + duration_difference + completed_intervention + visit + (1 \| record_id) + covariates
```

**Important Note on Mediation vs. Confounding:**

-   Compliance is not a confounder ‚Äî it occurs after randomization.
-   Conditioning on it changes the causal question.
-   Including post-randomization variables risks collider bias if those variables are influenced by both the intervention and unmeasured factors affecting inflammation.

**Final Recommendation for Writing in Thesis:**

The primary analysis was conducted under the intention-to-treat principle, evaluating the effect of the randomized intervention on inflammation regardless of adherence. A secondary model adjusted for adherence-related variables (completed_intervention, compliance_score_adjusted, and duration_difference) to explore whether the intervention had an effect among those who maintained adequate compliance. These models capture complementary aspects of intervention effectiveness: the former reflects real-world applicability, while the latter reflects efficacy conditional on adequate adherence.

#### Ideal condition

The first model (pcr_1) represents a per-protocol-type model, where the effect of the intervention (allocation_group) is estimated conditional on compliance (through compliance_score_adjusted, completed_intervention, and duration_difference). However, there are other methods that can estimate the effect of the intervention in an ideal condition, where adherence is perfect. These methods go beyond simply conditioning in regression and attempt to more rigorously isolate the causal effect.

**Alternative and Complementary Strategies to Per-Protocol Modeling**

*1. Restricting the Dataset (Complete Compliers Only)*

One simple but crude way to perform a per-protocol analysis is to exclude participants who did not complete the intervention or had poor compliance. This creates a model within a population that fully adhered. The limitations are: reduces sample size and breaks randomization, leading to confounding.

```         
data_pp <- data_model_scaled %>%
  filter(completed_intervention == "Yes", compliance_score_adjusted >= threshold)

pcr_pp <- lmer(log1p(labs_crp) ~ allocation_group + visit + (1 | record_id) + covariates, data = data_pp)
```

```{r}
data_pp <- data_model_scaled %>%
  filter(
    completed_intervention == "Sim" &
      (compliance_score_visit > 0.6 | is.na(compliance_score_visit))
  )
```

#### Restrict dataset

```{r}
pcr_pp <- lmer(log1p(labs_crp) ~ allocation_group + duration_difference + visit + (1 | record_id) + age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + drugs_w_loss + drugs_w_gain + mean_bp_mean + handgrip + evs_score + alcohol_dose + kcal + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + labs_hdl + labs_quick_index, data = data_pp)

summary(pcr_pp)
```

*2. Instrumental Variable (IV) Approach or Complier Average Causal Effect (CACE)*

Use allocation_group as an instrument for treatment receipt/adherence, under the assumption that randomization affects inflammation only via the intervention. This estimates the effect among compliers, without the collider bias introduced by directly conditioning on post-randomization variables. This estimates the effect of actually completing the intervention, using random allocation as an instrument. In R, this can be implemented using `ivreg()` from the {AER} package or {ivtools}. The syntax is: outcome \~ endogenous + exogenous \| instrument + exogenous. However, ivreg does not handle random effects. It assumes independent observations. Since our data has repeated measures (record_id), we should either use only one observation per subject (e.g., endpoint value) or use cluster-robust standard errors to account for within-subject correlation.

Collapsing longitudinal data to one observation per subject for instrumental variable (IV) analysis can be done in multiple ways, each answering a slightly different causal question. The gold standard in biostatistics is the ANCOVA approach, which models the outcome at the final time point while adjusting for the baseline value. This has been shown to be statistically more powerful and less biased than simple change scores when baseline and outcome are correlated. Like in the example:

```         
iv_model <- ivreg(
  log1p(crp_final) ~ completed_intervention + log1p(crp_baseline) + covariates |
  allocation_group + log1p(crp_baseline) + covariates,
  data = data_final
)
```

```
# Extract CRP at baseline
data_baseline <- data_crp %>%
  filter(visit == 1) %>%
  select(record_id, labs_crp) %>%
  rename(crp_baseline = labs_crp)

# Extract CRP at final visit
data_final <- data_model_scaled %>%
  group_by(record_id) %>%
  filter(visit == max(visit)) %>%  # This selects the final visit for each participant
  ungroup() %>%
  select(
    record_id, labs_crp, crp_raw, completed_intervention, compliance_score_adjusted,
    duration_difference, allocation_group, age, sex, hypertension, hypercholesterolemia,
    hypertrigliceridemia, drugs_w_loss, drugs_w_gain, mean_bp_mean, handgrip, evs_score,
    alcohol_dose, kcal, labs_alt, labs_ggt, labs_ldl, labs_triglycerides, labs_hdl, labs_quick_index
  ) %>%
  rename(crp_final = labs_crp)

data_cross_sectional <- data_final %>%
  left_join(data_baseline, by = "record_id")

rm(data_baseline)
rm(data_final)
```

**Primary IV model that estimates the total effect**

The primary IV model that estimates the total effect is designed to evaluate the causal impact of the intervention on inflammation (CRP) as a whole, capturing both the direct effects and any indirect effects mediated by changes in other physiological or metabolic parameters. This model uses random assignment (allocation_group) as an instrument for actual participation or completion of the intervention (completed_intervention), allowing for the estimation of the Complier Average Causal Effect (CACE).

The intent is to answer whether the intervention, when adhered to, leads to a reduction in inflammation, regardless of the biological pathways involved. It reflects the overall therapeutic effect, incorporating all mechanisms through which the intervention may influence CRP. This approach does not adjust for variables that could be affected by the intervention itself (such as blood pressure, lipid levels, or liver enzymes), ensuring that the total causal effect is not inadvertently blocked or biased by post-treatment variables.

#### IV

```
library(AER)

iv_model_total <- ivreg(
  log1p(crp_final) ~ compliance_score_adjusted + log1p(crp_baseline) +
    age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia |
  allocation_group + log1p(crp_baseline) +
    age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia,
  data = data_cross_sectional
)

summary(iv_model_total)
```

*3. G-Computation / G-Formula*

Simulate the outcome under a hypothetical scenario where everyone perfectly adheres to the intervention. This provides an estimate of the expected outcome if all participants had fully complied. R packages: {gfoRmula}, {ltmle}.

*4. Marginal Structural Models (MSMs) with Inverse Probability Weighting (IPW)*

Weight participants based on their probability of adhering, creating a pseudo-population where adherence is independent of confounders. This corrects for time-varying confounding affected by prior treatment. This gives an estimate of the intervention effect had everyone adhered as expected. Basic structure using {ipw}:

#### IPW

Complete case analysis (default approach in IPW):

```
library(ipw)

data_model_ipw <- data_model_scaled %>%
  drop_na(
    completed_intervention,
    age, sex, hypertension, hypercholesterolemia, hypertrigliceridemia,
    drugs_w_loss, drugs_w_gain, mean_bp_mean, handgrip, evs_score,
    alcohol_dose, kcal, labs_alt, labs_ggt, labs_ldl, labs_triglycerides,
    labs_hdl, labs_quick_index
  )

model_weights <- ipwpoint(
  exposure = completed_intervention,
  family = "binomial",
  link = "logit",
  denominator = ~ 
    age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia +
    drugs_w_loss + drugs_w_gain + mean_bp_mean + handgrip + evs_score +
    alcohol_dose + kcal + labs_alt + labs_ggt + labs_ldl + labs_triglycerides +
    labs_hdl + labs_quick_index,
  data = data_model_ipw
)

```

Use simple imputation (if appropriate for wer data). Be cautious: imputation is a valid strategy if missingness is assumed to be Missing At Random (MAR) and the variables used for imputation are adequate.

```
library(mice)
data_model_ipw <- mice::complete(mice(data_model_scaled, m = 1))
```

*5. Bayesian Models with Compliance Modeling*

Build a hierarchical Bayesian model that explicitly includes a latent compliance variable. Allows direct modeling of counterfactual scenarios under perfect adherence. Add prior distributions reflecting assumptions about compliance mechanisms. Packages: {brms}, {rstanarm}.

Example idea:

```{r, eval=FALSE}
brm(log1p(labs_crp) ~ allocation_group + compliance_score_adjusted + visit + (1 | record_id) + covariates,
    data = data_model_scaled,
    family = gaussian())
```

*Ways to Make we Current Model More Sensitive to the Intervention*

-   Focus the population: subset to high compliers or exclude partial compliers.
-   Model interactions: for example, allocation_group \* compliance_score_adjusted to see whether the effect of the intervention depends on levels of compliance.
-   Use longitudinal modeling more fully: include random slopes for visit to capture differential trajectories over time.
-   Explore dose-response: instead of binary completed_intervention, use a continuous adherence measure (compliance_score_adjusted) to model the dose-response effect of adherence.
-   Consider transforming the outcome if distributional assumptions are strained (though log1p() is already a robust choice for skewed variables like CRP).

# PAM

```{r}
pam_1 <- lmer(mean_bp_mean ~ (1 | record_id) + visit + allocation_group + completed_intervention + duration_difference + age + sex + hypertension + hypercholesterolemia + hypertrigliceridemia + drugs_w_loss + drugs_w_gain + mean_bp_mean + handgrip + evs_score + alcohol_dose + kcal + labs_crp + labs_alt + labs_ggt + labs_ldl + labs_triglycerides + labs_hdl + labs_quick_index, data = data_model_scaled)
```
