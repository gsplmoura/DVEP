---
title: "DVEP Data Analysis"
author: "Gustavo Santos Paiva Laender Moura"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document
PID: REDCap 1958
project: Effect of Eclipta prostrata (L.) L. (Asteraceae) on bioelectrical impedance
  phase angle in adults with grade I obesity (DVEP)
---

```{r setup}
knitr::opts_chunk$set(
  results = 'hide',
  message = FALSE,
  warning = FALSE
)

# 1. Getting started with R
## Clear existing data and graphics

rm(list = ls())
graphics.off()
cat("\014")  # Clear any pending RStudio sessions or temporary files

## Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(purrr)
library(here)

# Load functions from external script
source("helper_functions.R")
```

# First Steps
## Read Files
### Codebooks

```{r}
codebook_dvep <- read_excel(
        "Codebooks/codebook_dvep.xlsx",
        col_names = TRUE,
        col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) %>%
    arrange(index)

codebook_structure  <- read_csv(
  "Codebooks/codebook_structure.csv",
  col_names = TRUE)

codebook_ncit  <- read_csv(
  "Codebooks/codebook_ncit.csv",
  col_names = TRUE)

codebook_bia <- read_excel(
    "Codebooks/codebook_bia.xlsx",
    col_names = TRUE,
    col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) %>%
    arrange(index)
```

### Data

```{r}

data  <- read_csv(
  "Data/data_dvep.csv",
  col_names = TRUE,
  col_types = NULL, #column types will be inferred from guess_max
  col_select = NULL,
  id = NULL,
  locale = default_locale(),
  na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
  quote = "\"",
  comment = "",
  trim_ws = TRUE,
  skip = 0, # Number of lines to skip before reading data
  n_max = Inf, # Maximum number of lines to read.
  guess_max = 1000,
  name_repair = "unique",
  num_threads = readr_threads(),
  progress = show_progress(),
  show_col_types = TRUE,
  skip_empty_rows = TRUE,
  lazy = should_read_lazy()
)

data_bia_D3_raw <- read_csv(
    "Data/data_bia_D3.csv",
    col_names = TRUE)

data_bia_D1_raw <- read_csv(
    "Data/data_bia_D1.csv",
    col_names = TRUE)

```

## Remove identifying data from record_id

```{r}
data$record_id <- substr(data$record_id,1,2)
data_bia_D3_raw $File <- substr(data_bia_D3_raw $File,1,2)
data_bia_D1_raw$File <- substr(data_bia_D1_raw$File,1,2)
```

## Renaming variables

```{r}
# DATA
rename_data <- setNames(object = colnames(data), codebook_dvep$variable)
data <- data %>%
    rename(!!!rename_data)
rm(rename_data)

#BIA
rename_bia <- setNames(object = colnames(data_bia_D3_raw ), codebook_bia$variable)

data_bia_D3_raw <- data_bia_D3_raw %>%
    rename(!!!rename_bia)

data_bia_D1_raw <- data_bia_D1_raw %>%
    rename(!!!rename_bia)

rm(rename_bia)
```

## record_id as.integer

```{r}
data$record_id <- as.integer(data$record_id)
data_bia_D3_raw $record_id <- as.integer(data_bia_D3_raw $record_id)
data_bia_D1_raw$record_id <- as.integer(data_bia_D1_raw$record_id)
```

## Assign labels to variables

```{r}
data <- data %>% 
  mutate(across(
    all_of(codebook_dvep$variable),
    ~ {
      attr(., "label") <- codebook_dvep$label_pt[codebook_dvep$variable == cur_column()]
      .
    }
  ))

data_bia_D3_raw <- data_bia_D3_raw %>% 
  mutate(across(
    all_of(codebook_bia$variable),
    ~ {
      attr(., "label") <- codebook_bia$label_pt[codebook_bia$variable == cur_column()]
      .
    }
  ))

```

# DATA WRANGLING
## SECA BIA DATA 

(DIRECT IMPORT FROM BIOIMPEDANCE DEVICE)

This corresponds to the first version of the code. However, it relies on data directly imported from the bioimpedance device, and contains one to three measurements per participant. Therefore, the data needs to be wrangled to obtain the mean of the measurements for each participant.

However, for now (April 09th, 2025), I will depracate this code and analyse the data directly recorded into the REDCap project by the research collaborators. The code below is kept for reference, but will not be used in the analysis as of now. If needed, I will re-implement it in the future.

#### Data from first/third visit

Applies to participants who completed the intervention

```{r}
# Filter by rows with values for phase angles
data_bia_D3 <- data_bia_D3_raw %>% 
    dplyr::filter(!is.na(phaseangle)) %>% 
    dplyr::mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) %>% 
    dplyr::select(all_of(codebook_bia$variable)[codebook_bia$included == 1], date, time) %>% 
    dplyr::relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) %>% 
    dplyr::arrange(record_id, date, time) %>% 
    dplyr::group_by(record_id) %>% 
    dplyr::mutate(
        visit = dplyr::dense_rank(date),
        .after = record_id) %>% 
  dplyr::ungroup()
    

# Mean of multiple measurements from the same day
# Group by record_id and visit

data_bia_D3_mean <- data_bia_D3 %>% 
    dplyr::group_by(record_id, visit) %>%
    dplyr::summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) # %>% This chunk was removed since coding was added to the last call
    #dplyr::group_by(record_id) %>% # Add coding for visit number
    #dplyr::mutate(
    #    visit = case_when(
    #        date == min(date) ~ 1,  # Assign 1 to the earliest date
    #        date == max(date) ~ 3,  # Assign 3 to the latest date
    #        TRUE ~ NA_real_         # Default to NA for unexpected cases
    #    ),
    #    .after = record_id
    #)
```

#### Data from first visit

Applies to participants who did not complete the intervention

```{r}
# Filter by rows with values for phase angles
data_bia_D1 <- data_bia_D1_raw %>% 
    dplyr::filter(!is.na(phaseangle)) %>% 
    dplyr::mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) %>% 
    dplyr::select(all_of(codebook_bia$variable)[codebook_bia$included == 1], date, time) %>% 
    dplyr::relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) %>% 
    dplyr::arrange(record_id, date, time) %>% 
    dplyr::group_by(record_id) %>% 
    dplyr::mutate(
        visit = dplyr::dense_rank(date),
        .after = record_id) %>% 
    dplyr::ungroup()

# Selecting data from D1 not present in D3
data_bia_D1 <- data_bia_D1 %>% 
    dplyr::filter(
     record_id %in% setdiff(1:75, data_bia_D3$record_id)   
    )

# Mean of multiple measurements from the same day
# Group by record_id and visit

data_bia_D1_mean <- data_bia_D1 %>% 
    dplyr::group_by(record_id, visit) %>%
    dplyr::summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) # %>% This chunk was removed since coding was added to the last call
    # dplyr::group_by(record_id) %>% # Add coding for visit number
    # mutate(
    #     visit = case_when(
    #         date == min(date) ~ 1,  # Assign 1 to the earliest date
    #         date == max(date) ~ 3,  # Assign 3 to the latest date
    #         TRUE ~ NA_real_         # Default to NA for unexpected cases
    #     ),
    #     .after = record_id
    # )

```

#### Merging D1/D3 to single tibble

All measurements

```{r}
data_bia <- bind_rows(
    data_bia_D1, data_bia_D3
) %>% 
    dplyr::mutate(
        visit = as.integer(visit)
    ) %>% 
    dplyr::arrange(
        record_id, visit
    ) %>% 
    ungroup()

# label_variables()
data_bia <- label_variables(data_bia, codebook_bia)
```

Mean of measurements

```{r}
data_bia_mean <- bind_rows(
    data_bia_D1_mean, data_bia_D3_mean
) %>% 
    dplyr::mutate(
        visit = as.integer(visit)
    ) %>% 
    dplyr::arrange(
        record_id, visit
    ) %>% 
    ungroup()

### label_variables
data_bia_mean <- label_variables(data_bia, codebook_bia)
```

#### Drop intermediate tibbles

```{r, eval=FALSE}
rm(data_bia_D1_raw)
rm(data_bia_D1)
rm(data_bia_D3_raw)
rm(data_bia_D3)
```


## REDCAP DATA

**LEFT JOIN NCIT LABELS**

Left join NCIT labels to I21_conditions_R and I22_drugs_R and add variable labels

```{r}
I21_conditions_R <- filter_data("eleg", 1, "conditions") %>%
  left_join(
    dplyr::select(codebook_ncit, ncit_code, descriptive),
    join_by(common_comorbidities == ncit_code)
  ) %>%
  dplyr::relocate(descriptive, .after = common_comorbidities)

I21_conditions_R <- label_variables(I21_conditions_R, codebook_dvep)

#### Drugs in regular use
I22_drugs_R  <- filter_data("eleg",1,"drugs")  %>% 
    left_join(
        codebook_ncit %>% dplyr::select(ncit_code, descriptive),
        join_by(drugs_sql == ncit_code)
    ) %>%
    dplyr::relocate(
        descriptive, .after = drugs_sql
    )

I22_drugs_R <- label_variables(I22_drugs_R, codebook_dvep)
```


```{r, eval=FALSE}
# # 1.3 Previous drugs
# I23_old_drugs_R <- filter_data("eleg",1,"old.drugs") %>% 
#     left_join(
#         codebook_ncit %>% dplyr::select(ncit_code, descriptive),
#         join_by(common_previous_medications == ncit_code)
#     )%>%
#     dplyr::relocate(
#         descriptive, .after = common_previous_medications
#     )
# 
# # 1.4 Past medical conditions
# I24_old_conditions_R <- filter_data("eleg",1,"history") %>% 
#     left_join(
#         codebook_ncit %>% dplyr::select(ncit_code, descriptive),
#         join_by(common_medical_history == ncit_code)
#     )%>%
#     dplyr::relocate(
#         descriptive, .after = common_medical_history
#     )


# Most common comorbidities
# I21_conditions_R %>% 
#     group_by(common_comorbidities, descriptive) %>% 
#     count(common_comorbidities, sort = TRUE, name = "frequency") %>% 
#     mutate(percentage = round((frequency/75 * 100),1)) %>% 
#     view()

# NCIT    Condition   
# C3117	Hipertensão	                18	24         *1
# C26696	Ansiedade	                16	21.3        
# C37967	Hipercolesterolemia         16	21.3       *2
# C37971	Hipertrigliceridemia        13	17.3       *2
# C113101	Resistência à insulina      11	14.7       *3
# C26800	Hipotireoidismo             9	12         
# C89715	Enxaqueca	                8	10.7
# C114667	SOP                     	7	9.3
# C26747	DM2                     	7	9.3        *3
 
# Most common drugs
# ```{r, eval = FALSE}
# I22_drugs_R %>% 
#     group_by(drugs_sql, descriptive) %>% 
#     count(drugs_sql, sort = TRUE, name = "frequency") %>% 
#     mutate(percentage = round((frequency/75 * 100),1)) %>% 
#     view()
```

### DEMOGRAPHICS AND INTERVENTION DATA 

To be replicated to d2 and d3

```{r}

eleg_exclusive <- filter_data("eleg",0) %>% 
    dplyr::mutate(
        intervention_duration = as.numeric(conclusion_date - intervention_start_date)
        )%>% 
    dplyr::select(record_id, allocation_group, completed_intervention, intervention_duration, non_completion_reason, age, sex)

visit_1_exclusive <- filter_data("V1",0) %>% 
    dplyr::select(
        record_id,
        race:income_level
    ) %>% 
        # codebook_dvep$choices[codebook_dvep$variable == "race"]
        # [1] "c41260, Asiático | c41261, Branco origem europeia |
        # c128994, Branco origem América do Sul | c16352, Negro | 
        # c17998, desconhecido | c17649, Outro"
    dplyr::mutate(
        race = if_else(race == "c41261", "c128994", race)
    )

data_d1_exclusive <- eleg_exclusive %>% 
    dplyr::left_join(
        visit_1_exclusive,
        by = join_by(record_id)
)

rm(eleg_exclusive)
rm(visit_1_exclusive)
```

### REPEATING INSTRUMENTS
#### Creating relevant binary variables

1. Hypertension
```{r}
### HYPERTENSION
#### Extract record IDs associated with hypertension diagnosis
hypertension_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C3117")) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypertensive drugs
hypertension_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C66869|C29098|C61635|C47640_2|C28836|C29254|C62027|C62027_2"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign hypertension based on conditions or drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypertension = if_else(
        record_id %in% hypertension_conditions, 
        1, 
        if_else(
            record_id %in% hypertension_drugs, 
            1, 
            0
        )
    ))

rm(hypertension_conditions)
rm(hypertension_drugs)
```

2. Hypercolesterolemia
```{r}
# This new version creates two variable: hypercolesterolemia and hypertrigliceridemia

#### Extract record IDs associated with hypercholesterolemia
#### Hipercolesterolemia (LDL ≥ 130 ou não-HDL ≥ 160 ou CT ≥ 190 mg/dl)

# I21_conditions_R %>% distinct(common_comorbidities, descriptive) %>% view()

hypercholesterolemia_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C37967")) %>% 
    # C37967 = Hipercolesterolemia isolada (LDL ≥ 160)
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypercholesterolemia drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C29454", "C66523_2", "C47529", "C61527", "C87471")) %>% distinct(drugs_sql, descriptive)
#>   A tibble: 5 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C87471    Ciprofibrato 100 mg (Comp.) removed
#> 2 C29454    Sinvastatina 20 mg (Comp.) 
#> 3 C66523_2  Rosuvastatina 10 mg (Comp.)
#> 4 C61527    Atorvastatina 40 mg (Comp.)
#> 5 C47529    Ezetimiba 10 mg  

hypercholesterolemia_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C29454|C66523_2|C47529|C61527")
        ) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with abnormal lab results on first lab
hypercolesterolemia_labs <- data %>% 
    dplyr::filter(labs_ldl >= 130 | labs_cholesterol >= 190 | labs_cholesterol - labs_hdl >= 160) %>%
    dplyr::pull(record_id)

#### Assign hypercholesterolemia based on conditions, drugs, or first labs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypercholesterolemia = 
               if_else(record_id %in% hypercholesterolemia_conditions, 1, 
                       if_else(record_id %in% hypercholesterolemia_drugs, 1,
                               if_else(record_id %in% hypercolesterolemia_labs, 1, 0))))

rm(hypercholesterolemia_conditions)
rm(hypercholesterolemia_drugs)
rm(hypercolesterolemia_labs)

```

3. Hypertrigliceridemia

```{r}
#### Extract record IDs associated with hypertrigliceridemia
#### Hipertrigliceridemia (TAG ≥ 150 mg/dl)

# I21_conditions_R %>% distinct(common_comorbidities, descriptive) %>% view()

hypertrigliceridemia_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C37971")) %>% 
    # C37971 = Hipertrigliceridemia (TAG ≥ 150 mg/dl)
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypercholesterolemia drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C29454", "C66523_2", "C47529", "C61527", "C87471")) %>% distinct(drugs_sql, descriptive)
#>   A tibble: 5 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C87471    Ciprofibrato 100 mg (Comp.) removed
#> 2 C29454    Sinvastatina 20 mg (Comp.) 
#> 3 C66523_2  Rosuvastatina 10 mg (Comp.)
#> 4 C61527    Atorvastatina 40 mg (Comp.)
#> 5 C47529    Ezetimiba 10 mg  

hypertrigliceridemia_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C87471")
        ) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with abnormal lab results on first lab
hypertrigliceridemia_labs <- data %>% 
    dplyr::filter(labs_triglycerides >= 150) %>% 
    dplyr::pull(record_id)

#### Assign hypercholesterolemia based on conditions, drugs, or first labs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypertrigliceridemia = 
               if_else(record_id %in% hypertrigliceridemia_conditions, 1, 
                       if_else(record_id %in% hypertrigliceridemia_drugs, 1,
                               if_else(record_id %in% hypertrigliceridemia_labs, 1, 0))))

rm(hypertrigliceridemia_conditions)
rm(hypertrigliceridemia_drugs)
rm(hypertrigliceridemia_labs)

```

4. Insulin resistance

```{r}

#### Extract record IDs associated with insulin resistance

insulin_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C113101|C26747")) %>%
    dplyr::pull(record_id)

#### Extract record IDs associated with anti-hyperglycemic / hypoglycemic drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61612", "C61612_2", "C87618", "C180533")) %>% distinct(drugs_sql, descriptive)
#> # A tibble: 4 × 2
#>   drugs_sql descriptive                         
#>   <chr>     <chr>                               
#> 1 C61612_2  Metformina 850 mg (Comp.) (Glifage) 
#> 2 C61612    Metformina 500 mg (Comp.) (Glifage) 
#> 3 C87618    Gliclazida 30 mg (Comp. de lib. pr.)
#> 4 C180533   Empagliflozin/Linagliptin (GLYXAMBI)

insulin_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61612|C61612_2|C87618|C180533"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign INSULIN RESISTANCE based on conditions or drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(insulin = if_else(
        record_id %in% insulin_conditions, 
        1, 
        if_else(
            record_id %in% insulin_drugs, 
            1, 
            0
        )
    ))

rm(insulin_conditions)
rm(insulin_drugs)
```

5. Drugs that might induce weight loss

```{r}
### 9.3.4 DRUGS THAT MIGHT INDUCE WEIGHT LOSS
#### Extract record IDs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61939", "C62012", "C506_1", "C1278_2", "C1278_1", "C1278_3", "C47764_1", "C47764_2", "C61680")) %>% distinct(drugs_sql, descriptive)

#> # A tibble: 9 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C61939    Sertralina 50 mg (Comp.)   
#> 2 C47764_2  Topiramato 50 mg (Comp.)   
#> 3 C62012    Bupropiona 150 mg (Comp.)  
#> 4 C47764_1  Topiramato 25 mg (Comp.)   
#> 5 C61680    Citalopram 20 mg (Comp.)   
#> 6 C506_1    Fluoxetina 20 mg (Cáps.)   
#> 7 C1278_2   Venlafaxina 75 mg (Caps.)  
#> 8 C1278_1   Venlafaxina 37,5 mg (Caps.)
#> 9 C1278_3   Venlafaxina 150 mg (Cáps.) 

drugs_w_loss <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61939|C62012|C506_1|C1278_2|C1278_1|C1278_3|C47764_1|C47764_2|C61680"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign drugs_w_loss based on drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(drugs_w_loss = if_else(
        record_id %in% drugs_w_loss, 1, 0)
    )

rm(drugs_w_loss)
```

6. Drugs that might induce weight gain

```{r}
### DRUGS THAT MIGHT INDUCE WEIGHT GAIN

#### Extract record IDs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61879", "C62005", "C61917_2", "C29416", "C29536_2")) %>% distinct(drugs_sql, descriptive)
#> # A tibble: 5 × 2
#>   drugs_sql descriptive                   
#>   <chr>     <chr>                         
#> 1 C62005    Amitriptilina 25 mg (Comp.)   
#> 2 C61879    Paroxetina 20 mg (Comp.)      
#> 3 C29536_2  Ácido Valpróico 250 mg (Cáps.)
#> 4 C29416    Risperidona 2 mg (Comp.)      
#> 5 C61917_2  Quetiapina 50 mg (Comp.)    

drugs_w_gain <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61879|C62005|C61917_2|C29416|C29536_2"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign drugs_w_loss based on drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(drugs_w_gain = if_else(
        record_id %in% drugs_w_gain, 1, 0)
    )

rm(drugs_w_gain)

```

**Wrapping up `data_d1_exclusive`**

```{r}
data_d1_exclusive <- label_choices(data_d1_exclusive, codebook_dvep)
data_d1_exclusive <- convert_col_type(data_d1_exclusive, codebook_dvep)
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(
        hypertension = as.factor(hypertension),
        hypercholesterolemia = as.factor(hypercholesterolemia),
        hypertrigliceridemia = as.factor(hypertrigliceridemia),
        insulin = as.factor(insulin),
        drugs_w_loss = as.factor(drugs_w_loss),
        drugs_w_gain = as.factor(drugs_w_gain)
    )
data_d1_exclusive <- label_variables(data_d1_exclusive, codebook_dvep)

```

#### Lab exames

```{r}
I27_labs_R <- filter_data(c("V1","V2","V3"),1,"labs") %>% 
    dplyr::mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )%>% 
    select(-event_name, -repeat_instrument, -repeat_instance, -labs_checked_results_yn)

```

#### Compliance
```{r}
compliance_V2 <- data %>% 
    select(
        record_id, event_name,
        filter_variables("V2",1,"compliance")
        ) %>% 
    filter(event_name == "2visit_arm_1" & cp_compliance_complete == 2) %>% 
    left_join(data %>%
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) %>% 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) %>% 
    left_join(data %>%
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) %>% 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) %>% 
    rename(evaluation_date_2 = evaluation_date)

compliance_V3 <- data %>% 
    select(
        record_id, event_name,
        filter_variables("V3",,"compliance")
        ) %>% 
    filter(event_name == "3visit_arm_1" & cp_compliance_complete == 2) %>% 
    left_join(data %>%
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) %>% 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) %>% 
    left_join(data %>%
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) %>% 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) %>% 
    rename(evaluation_date_2 = evaluation_date)

I29_compliance <- bind_rows(
    compliance_V2,compliance_V3
) %>% 
    mutate(
        record_id = as.integer(record_id)
    ) %>% 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
    ) %>% 
    arrange(record_id,visit) %>% 
    select(record_id, visit, intervention_start_date, evaluation_date_2, conclusion_date, cp_taking_as_directed_yn, cp_schedule, cp_schedule_other, cp_missed_dose_yn, cp_missed_dose_count, cp_discontinued_yn, cp_discontinued_n_days, cp_discontinued_reason_other, cp_ran_out_of_drug_yn, cp_ran_out_reason, cp_perceived_improvement_yn, cp_perceived_improvement, cp_medication_confidence_scale, cp_self_reported_compliance_rate)  %>% 
    convert_col_type()

rm(compliance_V2)
rm(compliance_V3)

I29_compliance <- label_variables(I29_compliance, codebook_dvep)
I29_compliance <- label_choices(I29_compliance, codebook_dvep)

```

#### Adverse events
```{r}
I30_events_R <- filter_data(,1,"events") %>% 
    filter(
        cp_adverse_event_this_cycle_yn == 1
    ) %>%
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )%>% 
    select(-event_name, -repeat_instrument, -cp_additional_adverse_events_yn,  -cp_adverse_event_this_cycle_yn)

I30_events_R <- label_variables(I30_events_R, codebook_dvep)
I30_events_R <- label_choices(I30_events_R, codebook_dvep) 
```

### NON-REPEATING INSTRUMENTS

#### RELEVANT VARIABLES FROM V1 & V3
```{r}
# Non-repeating data common to V1 and V3 (`d1d3`)
# calculate mean of handgrip strenght
# select relevant variables

d1d3 <- filter_data(c("V1","V3"),0) %>% 
    mutate(
        handgrip = if_else(
            is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
            NA_real_,  # Leave blank (NA) if both are missing
            if_else(
                !is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
                handgrip_right_mean,  # Use the right hand value if left is missing
                if_else(
                    is.na(handgrip_right_mean) & !is.na(handgrip_left_mean),
                    handgrip_left_mean,  # Use the left hand value if right is missing
                    rowMeans(cbind(handgrip_right_mean, handgrip_left_mean), na.rm = TRUE)  # Calculate mean if both are present
                    )
                )
            )
        ) %>% 
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "3visit_arm_1"    ~ 3
        )
    ) %>% 
    select(
        record_id, visit,
        whoqol_score_overall, # 4. whoqol
        dass_score_depression:ecap_score, # 5. dass, 6. ecap
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        time_fasted_food, time_fasted_liquid, resistance, reactance, phase_angle, # 10. bia
        handgrip, # 11. handgrip
        # 12. eliminations
        evs_score, # 14. evs
        alcohol_dose, alcohol_significant, # 15. alcohol
        smoke_history, pack_years,  # 16. tobacco
        carbs_kcal, protein_kcal, fat_kcal, # 18. intake
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered, # 31. medical
        # April 19th, 2025: since we are simplifying BIA data and using collected variables on REDCAP:
        # 10. BIA
        phase_angle, resistance, reactance, smoked_24h_yn, exercised_24h_yn, alcohol_24h_yn, light_clothes_yn, time_fasted_food, time_fasted_liquid)
```

#### RELEVANT VARIABLES FROM V2

```{r}
##Non-repeating data from the second visit

d2 <- filter_data("V2",0) %>% 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2
        )
    ) %>% 
    select(
        record_id, visit,
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        # 12. eliminations
        evs_score, # 14. evs
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered # 31. medical
        )
```

### JOINS

#### bind_rows() from `d1d3` and `d2` to create `data_filtered`

```{r}
## 9.6 Bind rows for non-repeating variables from D1/D2/D3
data_filtered <- bind_rows(
    d1d3,d2
) %>% 
    mutate(
        record_id = as.integer(record_id),
        visit = as.integer(visit)
) %>% 
    arrange(
        record_id, visit
    ) %>% 
    convert_col_type()

rm(d1d3)
rm(d2)
```

#### left_join() to `data_filtered`

```{r}

# COMPLIANCE DATA
data_filtered <- data_filtered %>% 
    left_join(
        I29_compliance,
        by = join_by(record_id, visit)
    )

# data_d1_exclusive
data_filtered <- data_d1_exclusive %>% 
    right_join(
        data_filtered,
        by = join_by(record_id)
    ) %>% 
    relocate(
        visit,
        .after = record_id
    )

# LAB EXAMS
data_filtered <- data_filtered %>% 
    left_join(I27_labs_R,
              by = join_by(record_id, visit)
    )

data_filtered <- label_variables(data_filtered, codebook_dvep)
data_filtered <- data_filtered %>% 
    mutate(
        visit = as.integer(visit)
    )
```

#### left_join() **SECA BIA DATA** to `data_filtered_seca`
```{r}
data_filtered_seca <- data_filtered %>% 
    left_join(
        data_bia %>% 
            select(
                record_id, visit,
                phaseangle, raverage, xcaverage, 
                weight, height, waist, pal, bmi, 
                fmi, ffmi, vat,
                w_tbw, w_ecw
            ),
        by = join_by(record_id, visit)
    )

```

## EXPORT TIBBLES

### To RDS
```{r}
output_dir <- "Data_processed"

saveRDS(data,                file.path(output_dir, "data.rds"))
saveRDS(data_bia,            file.path(output_dir, "data_bia.rds"))
saveRDS(data_bia_D1,         file.path(output_dir, "data_bia_D1.rds"))
saveRDS(data_bia_D1_mean,    file.path(output_dir, "data_bia_D1_mean.rds"))
saveRDS(data_bia_D1_raw,     file.path(output_dir, "data_bia_D1_raw.rds"))
saveRDS(data_bia_D3,         file.path(output_dir, "data_bia_D3.rds"))
saveRDS(data_bia_D3_mean,    file.path(output_dir, "data_bia_D3_mean.rds"))
saveRDS(data_bia_D3_raw,     file.path(output_dir, "data_bia_D3_raw.rds"))
saveRDS(data_bia_mean,       file.path(output_dir, "data_bia_mean.rds"))
saveRDS(data_d1_exclusive,   file.path(output_dir, "data_d1_exclusive.rds"))
saveRDS(data_filtered,       file.path(output_dir, "data_filtered.rds"))
saveRDS(data_filtered_seca,  file.path(output_dir, "data_filtered_seca.rds"))

# Repeating instrument exports
saveRDS(I21_conditions_R,    file.path(output_dir, "I21_conditions_R.rds"))
saveRDS(I22_drugs_R,         file.path(output_dir, "I22_drugs_R.rds"))
saveRDS(I27_labs_R,          file.path(output_dir, "I27_labs_R.rds"))
saveRDS(I29_compliance,      file.path(output_dir, "I29_compliance.rds"))
saveRDS(I30_events_R,        file.path(output_dir, "I30_events_R.rds"))
```

### To CSV

```{r}
readr::write_csv(data,                file.path(output_dir, "data.csv"))
readr::write_csv(data_bia,            file.path(output_dir, "data_bia.csv"))
readr::write_csv(data_bia_D1,         file.path(output_dir, "data_bia_D1.csv"))
readr::write_csv(data_bia_D1_mean,    file.path(output_dir, "data_bia_D1_mean.csv"))
readr::write_csv(data_bia_D1_raw,     file.path(output_dir, "data_bia_D1_raw.csv"))
readr::write_csv(data_bia_D3,         file.path(output_dir, "data_bia_D3.csv"))
readr::write_csv(data_bia_D3_mean,    file.path(output_dir, "data_bia_D3_mean.csv"))
readr::write_csv(data_bia_D3_raw,     file.path(output_dir, "data_bia_D3_raw.csv"))
readr::write_csv(data_bia_mean,       file.path(output_dir, "data_bia_mean.csv"))
readr::write_csv(data_d1_exclusive,   file.path(output_dir, "data_d1_exclusive.csv"))
readr::write_csv(data_filtered,       file.path(output_dir, "data_filtered.csv"))
readr::write_csv(data_filtered_seca,  file.path(output_dir, "data_filtered_seca.csv"))

# Repeating instruments
readr::write_csv(I21_conditions_R,    file.path(output_dir, "I21_conditions_R.csv"))
readr::write_csv(I22_drugs_R,         file.path(output_dir, "I22_drugs_R.csv"))
readr::write_csv(I27_labs_R,          file.path(output_dir, "I27_labs_R.csv"))
readr::write_csv(I29_compliance,      file.path(output_dir, "I29_compliance.csv"))
readr::write_csv(I30_events_R,        file.path(output_dir, "I30_events_R.csv"))
```


# SUPERTIBBLE (`data_instruments`)
Creates a supertibble with one tibble for each instrument

```{r}
form_names <- unique(codebook_dvep$form_name_en)
form_names <- form_names[-2]

# Dynamically create the instruments list
instruments <- setNames(
    lapply(form_names, function(form_name) {
        filter_codebook(form_name, 0)$variable
    }),
    paste0("I", sprintf("%02d", seq_along(form_names)), "_", form_names)
)

# Estas variáveis não devem ser consideradas na verificação de dados faltantes (NA) porque sempre contêm informações.
always_present_vars <- c("record_id", "event_name", "repeat_instrument", "repeat_instance")

# Criar uma lista de tibbles separadas para cada instrumento, excluindo linhas que contenham apenas NAs
data_instruments <- lapply(names(instruments), function(instr_name) {
    
    # `instr_name` é o nome atual do instrumento sendo processado, por exemplo, "elegibility".
    
    # Seleciona a lista de variáveis associadas ao instrumento atual
    selected_vars <- instruments[[instr_name]]
    
    # Remove as variáveis da lista que estão em `always_present_vars` (que sempre possuem valores).
    # `setdiff()` retorna apenas as variáveis exclusivas (aquelas que não estão em `always_present_vars`).
    vars_to_check <- setdiff(selected_vars, always_present_vars)
    
    # Filtrar os dados para o instrumento atual
    filtered_tibble <- data  %>% 
        # Seleciona as colunas correspondentes às variáveis do instrumento atual
        select(all_of(selected_vars))  %>% 
        
        # Filtra as linhas onde pelo menos uma das variáveis relevantes (não constantes) não é NA
        filter(
            rowSums(
                !is.na(
                    select(cur_data(), all_of(vars_to_check)) # Seleciona apenas as colunas relevantes para a verificação de NA
                )
            ) > 0 # `rowSums()` conta quantas colunas não são NA por linha. Mantemos linhas onde este total é maior que 0.
        )
    
    # Retorna a tibble filtrada com as variáveis e linhas relevantes para o instrumento atual
    return(filtered_tibble)
})

# Nomeia os elementos da lista `data_instruments` com os nomes correspondentes dos instrumentos.
# Por exemplo, o primeiro elemento da lista será nomeado "redcap", o segundo "elegibility", e assim por diante.
names(data_instruments) <- names(instruments)

rm(always_present_vars)
rm(form_names)
rm(instruments)

# Opcional: Salvar cada tibble no ambiente global como um objeto independente.
# `list2env()` converte cada elemento da lista `data_instruments` em um objeto no ambiente global,
# com o nome correspondente ao instrumento.
#list2env(data_instruments, .GlobalEnv)

```

**EXPORT RDS**
```{r}
saveRDS(data_instruments, "Data_instruments/data_instruments.rds")
```

**EXPORT CSV**

```{r}
output_dir <- 'Data_instruments'

# Iterate over `data_instruments`
for (instr_name in names(data_instruments)) {
    # Create the file path for the current instrument
    file_path <- file.path(output_dir, paste0(instr_name, ".csv"))
    
    # Write the tibble to a CSV file
    write_csv(data_instruments[[instr_name]], file_path)
    
    # Print a message confirming the export
    message("Exported: ", file_path)
}

# Additional tibbles
# write_csv(data_bia, file.path(output_dir, "data_bia.csv"))
write_csv(data_d1_exclusive, file.path(output_dir, "data_d1_exclusive.csv"))
write_csv(data_filtered, file.path(output_dir, "data_filtered.csv"))

rm(output_dir)
rm(file_path)
rm(instr_name)
```

# DATA ANALYSIS

```{r}
library(skimr)
```


```{r, eval=FALSE, echo=FALSE}
## Simplifying Environment
## Optional
codebooks <- tibble(
    name = c("bia", "dvep", "ncit", "structure"),
    data = list(codebook_dvep, codebook_ncit, codebook_structure)
)

# Assign names to the `data` list-column
names(codebooks$data) <- codebooks$name

# Remove the individual tibbles from the environment
rm(codebook_bia, codebook_dvep, codebook_ncit, codebook_structure)

# Pull individual codebooks. You can pull each individual codebook by running:
# codebooks\$data[["bia"]]
# codebooks\$data[["dvep"]]
# codebooks\$data[["ncit"]]
# codebooks\$data[["structure"]]
```

# RESULTS

# Baseline

```{r}
file_path_baseline <- "Output/Baseline/Data_files"
database <- data
```

```{r, eval=FALSE}
# Datas de inclusão e conclusão
summary(data$consent_date)

max(data$consent_date, na.rm = TRUE)

summary(data["conclusion_date"])

# Completaram a intervenção
summary(data_d1_exclusive$completed_intervention)
```

## Abandonos

Dos participantes incluídos, 23 (30.6%) não completaram os três meses de intervenção. A taxa de abandono foi maior nos homens, com 4 abandonos (40% dos homens incluídos), sendo 2 de cada grupo. No sexo feminino, a taxa de abandono foi de 29.2%, sendo oito do grupo placebo e 11 do grupo intervenção.

```{r, eval=FALSE}
# Abandonos
## Taxa de abandono
(23/75)*100 

## Abandono por sexo e grupo de alocação
data_d1_exclusive %>% 
    filter(completed_intervention == "Não") %>% 
    count(sex, allocation_group, name = "Total")

## Taxa de abandono por sexo
(4/10)*100 # Homens
(19/65)*100 # Mulheres

table(data$non_completion_reason)
```

### Contingency table by sex

```{r, eval=FALSE}
# Criar a tabela de contingência
tabela <- table(data_d1_exclusive$sex, data_d1_exclusive$completed_intervention)

# Exibir a tabela
print(tabela)

# Teste do qui-quadrado
teste_qui2 <- chisq.test(tabela)
teste_qui2$expected

# Exibir os resultados do teste do qui-quadrado
print(teste_qui2)
```

### Contingency table by sex, controlling for allocation group

```{r, eval=FALSE}
# Criar a tabela de contingência estratificada por allocation_group
tabela <- table(data_d1_exclusive$sex, 
                data_d1_exclusive$completed_intervention, 
                data_d1_exclusive$allocation_group)

# Exibir a tabela para verificar se está correta
print(tabela)

# Realizar o teste de Mantel-Haenszel
resultado_mh <- mantelhaen.test(tabela)

# Exibir o resultado do teste
print(resultado_mh)

```

### Log reg

```{r, eval=FALSE}
model <- glm(completed_intervention ~ sex * allocation_group, data = data_d1_exclusive, family = binomial)

summary(model)

exp(cbind(OR = coef(model), confint(model)))

```

## Participant's characteristics (data_d1_exclusive)

```{r, eval=FALSE}
# ALL
baseline_num <- summarize_numerical(data_d1_exclusive) # `summarize_numerical()`
baseline_num %>%
  gt() %>%
  tab_header(
    title = "Numerical Variable Summary",
    subtitle = "Overall Summary"
  )

baseline_cat <- summarize_categorical(data_d1_exclusive) # `summarize_categorical()`
baseline_cat %>%
  gt() %>%
  tab_header(
    title = "Categorical Variable Summary",
    subtitle = "Overall Summary"
  )

# BY GROUP
baseline_num_group <- summarize_numerical(data_d1_exclusive, "allocation_group") # `summarize_numerical()`
baseline_num_group %>%
  gt() %>%
  tab_header(
    title = "Numerical Variable Summary",
    subtitle = "Overall Summary"
  )

baseline_cat_group <- summarize_categorical(data_d1_exclusive, "allocation_group") # `summarize_categorical()`
baseline_cat_group %>%
  gt() %>%
  tab_header(
    title = "Categorical Variable Summary",
    subtitle = "Overall Summary"
  )

# COMPARE GROUPS
group_comparison <- compare_groups(data_d1_exclusive) #`compare_groups`
print(group_comparison)
```

Descriptive: Drugs that might induce weight loss

```{r, eval=FALSE}
drugs_w_loss_descriptive <- I22_drugs_R %>% 
    dplyr::filter(stringr::str_detect(drugs_sql, 
        "C61939|C62012|C506_1|C1278_2|C1278_1|C1278_3|C47764_1|C47764_2|C61680"
    )) %>% 
    dplyr::pull(descriptive) %>% 
    stringr::str_extract("^[^0-9]+") %>% 
    stringr::str_trim() %>% 
    base::unique() %>% 
    cat(sep = ", ")

drugs_w_gain <- I22_drugs_R %>% 
    filter(str_detect(drugs_sql, 
        "C61879|C62005|C61917_2|C29416|C29536_2")) %>% 
    dplyr::pull(descriptive) %>% 
    stringr::str_extract("^[^0-9]+") %>% 
    stringr::str_trim() %>% 
    base::unique() %>% 
    cat(sep = ", ")
```

**Clear** Participant's characteristics (data_d1_exclusive)

```{r, eval=FALSE}
# CLEAR
rm(baseline_num)
rm(baseline_cat)
rm(baseline_num_group)
rm(baseline_cat_group)
rm(group_comparison)
rm(drugs_w_loss_descriptive)

```

Comparação da proporção do sexo dos participantes segundo o grupo de alocação Na verdade essa análise foi redundante - já foi feita em `baseline_cat_group`

```{r, eval=FALSE}
group_by_sex <- data_d1_exclusive %>% 
    group_by(sex, allocation_group) %>% 
    count() %>% 
    pivot_wider(names_from = allocation_group, values_from = n, values_fill = 0) %>%
    column_to_rownames(var = "sex") %>% # Converts the 'sex' column into row names
    as.matrix()

group_by_sex_chisq <- chisq.test(group_by_sex)
group_by_sex_chisq
group_by_sex_FET <- fisher.test(group_by_sex)
group_by_sex_FET

rm(group_by_sex)
rm(group_by_sex_chisq)
rm(group_by_sex_FET)
```

## Lab exames

```{r, eval=FALSE}
# filter first visit and relevant variables
labs_baseline <- I27_labs_R %>% 
    filter(
        visit == 1
    ) %>% 
    select(
        -visit, -labs_date, -labs_beta_hcg , -labs_notes
    ) %>% left_join(
        data_d1_exclusive %>% 
            select(record_id, allocation_group),
                   by = "record_id"
                  )

baseline_labs_baseline <- summarize_numerical(labs_baseline) #all
baseline_labs_baseline_groups <- summarize_numerical(labs_baseline,"allocation_group") #groups
baseline_labs_baseline_groups_compare <- compare_groups(labs_baseline) #compare
print(baseline_labs_baseline_groups_compare) #print
```

**Clear** Lab exams

```{r, eval=FALSE}
rm(labs_baseline)
rm(baseline_labs_baseline)
rm(baseline_labs_baseline_groups)
rm(baseline_labs_baseline_groups_compare)
```

**CPR**

```{r, eval=FALSE}

plot(labs_baseline$labs_crp)

cpr_bp <- boxplot(labs_baseline$labs_crp_log)
cpr_bp$out

par(mfrow = c(1, 2)) 
hist(labs_baseline$labs_crp)
hist(labs_baseline$labs_crp_log)

labs_baseline$labs_crp_log <- log(labs_baseline$labs_crp)

summary(labs_baseline$labs_crp_log)

plot(labs_baseline$labs_crp_log, data_filtered$phaseangle[data_filtered$visit == 1])


skim(labs_baseline)


rm(cpr_bp)
rm(labs_baseline$labs_crp_log)
```

## BIA

### Baseline

```{r, eval=FALSE}
bia_baseline <- data_bia %>%
    filter(
        visit == 1
    ) %>% 
    select(
        record_id, phaseangle:w_ecw
        ) %>% 
    dplyr::left_join(
        data_d1_exclusive %>% 
            select(record_id, allocation_group, sex),
                   by = "record_id"
        )
```

### Comparing between males and females

```{r, eval=FALSE}
#by sex
bia_baseline_sex <- summarize_numerical(bia_baseline, "sex") 
bia_baseline_sex_compare <- compare_groups(bia_baseline,"sex") # compare
print(bia_baseline_sex_compare) # print
```

### Males

```{r, eval=FALSE}
# Filter males
BIA_V1_M <- bia_baseline %>% 
    filter(
        sex == "Masculino"
    )

#summarize_numerical()
BIA_V1_M_SN <- summarize_numerical(BIA_V1_M, "allocation_group",use_labels = TRUE)

# compare_groups()
BIA_V1_M_C <- compare_groups(BIA_V1_M, group_col = "allocation_group",use_labels = TRUE, return_df = TRUE) 

# join tables
bia_males <- BIA_V1_M_SN %>%
    left_join(y = BIA_V1_M_C %>% 
                  select(Variable, P_value),
              by = join_by(Variable)
    ) %>%
    mutate(
        P_value = round(P_value,3)
    ) %>% 
    filter(
        Variable != "Nome do arquivo"
    ) %>% 
    rename(
         Parâmetro = Variable,
         `Grupo placebo [média (IC 95%)]` = `Grupo A`,
         `Grupo Eclipta [média (IC 95%)]` = `Grupo B`,
         `Valor p [Teste t]` = P_value
    ) %>% 
    mutate(Parâmetro = recode(Parâmetro, 
                            "Altura" = "Altura (m)", 
                            "Peso" = "Peso (kg)", 
                            "Índice de Massa Corporal" = "Índice de Massa Corporal (kg/m²)", 
                            "Cintura" = "Circunferência Abdominal (m)", 
                            "Nível de Atividade Física" = "Nível de Atividade Física (PAL)", 
                            "Ângulo de Fase" = "Ângulo de Fase (°)", 
                            "Média de Resistência" = "Resistência (Ω)", 
                            "Média de Reatância" = "Reatância (Ω)", 
                            "Massa de Gordura Absoluta" = "Massa gorda Absoluta (kg)", 
                            "Índice de Massa de Gordura" = "Índice de Massa gorda (kg/m²)", 
                            "Massa de Gordura Relativa" = "Massa gorda Relativa (%)", 
                            "Tecido Adiposo Visceral" = "Tecido Adiposo Visceral (kg)", 
                            "Massa Livre de Gordura Absoluta" = "Massa Livre de Gordura Absoluta (kg)", 
                            "Índice de Massa Livre de Gordura" = "Índice de Massa Livre de Gordura (kg/m²)", 
                            "Massa Livre de Gordura Relativa" = "Massa Livre de Gordura Relativa (%)", 
                            "Massa Muscular Esquelética do Corpo" = "MME Corporal Total (kg)", 
                            "Massa Muscular Esquelética do Tronco" = "MME do Tronco (kg)", 
                            "Massa Muscular Esquelética do Braço Direito" = "MME do Braço Direito (kg)", 
                            "Massa Muscular Esquelética do Braço Esquerdo" = "MME do Braço Esquerdo (kg)", 
                            "Massa Muscular Esquelética da Perna Direita" = "MME da Perna Direita (kg)", 
                            "Massa Muscular Esquelética da Perna Esquerda" = "MME da Perna Esquerda (kg)", 
                            "Água Corporal Total" = "Água Corporal Total (L)", 
                            "Água Extracelular" = "Água Extracelular (L)", 
                            "Gasto Energético Total" = "Gasto Energético Total (kcal)", 
                            "Gasto Energético em Repouso" = "Gasto Energético em Repouso (kcal)", 
                            "Energia Armazenada" = "Energia Armazenada (kcal)")
        ) %>%
    mutate(Parâmetro = factor(Parâmetro, levels = c(
    "Altura (m)", "Peso (kg)", "Índice de Massa Corporal (kg/m²)", "Circunferência Abdominal (m)", 
    "Nível de Atividade Física (PAL)", "Ângulo de Fase (°)", "Resistência (Ω)", "Reatância (Ω)", 
    "Massa gorda Absoluta (kg)", "Índice de Massa gorda (kg/m²)", "Massa gorda Relativa (%)", 
    "Tecido Adiposo Visceral (kg)", "Massa Livre de Gordura Absoluta (kg)", 
    "Índice de Massa Livre de Gordura (kg/m²)", "Massa Livre de Gordura Relativa (%)", 
    "MME Corporal Total (kg)", "MME do Tronco (kg)", "MME do Braço Direito (kg)", 
    "MME do Braço Esquerdo (kg)", "MME da Perna Direita (kg)", "MME da Perna Esquerda (kg)", 
    "Água Corporal Total (L)", "Água Extracelular (L)", "Gasto Energético Total (kcal)", 
    "Gasto Energético em Repouso (kcal)", "Energia Armazenada (kcal)"))
    ) %>% 
    arrange(Parâmetro)

write_csv(bia_males, here("Output", "Baseline", "Tables", "bia_males.csv"))
```

### Females

```{r, eval=FALSE}
# Filter males
BIA_V1_F <- bia_baseline %>% 
    filter(
        sex == "Feminino"
    )

#summarize_numerical()
BIA_V1_F_SN <- summarize_numerical(BIA_V1_F, "allocation_group",use_labels = TRUE)

# compare_groups()
BIA_V1_F_C <- compare_groups(BIA_V1_F, group_col = "allocation_group",use_labels = TRUE, return_df = TRUE) 

# join tables
bia_females <- BIA_V1_F_SN %>%
    left_join(y = BIA_V1_F_C %>% 
                  select(Variable, P_value),
              by = join_by(Variable)
    ) %>%
    mutate(
        P_value = round(P_value,3)
    ) %>% 
    filter(
        Variable != "Nome do arquivo"
    ) %>% 
    rename(
         Parâmetro = Variable,
         `Grupo placebo [média (IC 95%)]` = `Grupo A`,
         `Grupo Eclipta [média (IC 95%)]` = `Grupo B`,
         `Valor p [Teste t]` = P_value
    ) %>% 
    mutate(Parâmetro = recode(Parâmetro, 
                            "Altura" = "Altura (m)", 
                            "Peso" = "Peso (kg)", 
                            "Índice de Massa Corporal" = "Índice de Massa Corporal (kg/m²)", 
                            "Cintura" = "Circunferência Abdominal (m)", 
                            "Nível de Atividade Física" = "Nível de Atividade Física (PAL)", 
                            "Ângulo de Fase" = "Ângulo de Fase (°)", 
                            "Média de Resistência" = "Resistência (Ω)", 
                            "Média de Reatância" = "Reatância (Ω)", 
                            "Massa de Gordura Absoluta" = "Massa gorda Absoluta (kg)", 
                            "Índice de Massa de Gordura" = "Índice de Massa gorda (kg/m²)", 
                            "Massa de Gordura Relativa" = "Massa gorda Relativa (%)", 
                            "Tecido Adiposo Visceral" = "Tecido Adiposo Visceral (kg)", 
                            "Massa Livre de Gordura Absoluta" = "Massa Livre de Gordura Absoluta (kg)", 
                            "Índice de Massa Livre de Gordura" = "Índice de Massa Livre de Gordura (kg/m²)", 
                            "Massa Livre de Gordura Relativa" = "Massa Livre de Gordura Relativa (%)", 
                            "Massa Muscular Esquelética do Corpo" = "MME Corporal Total (kg)", 
                            "Massa Muscular Esquelética do Tronco" = "MME do Tronco (kg)", 
                            "Massa Muscular Esquelética do Braço Direito" = "MME do Braço Direito (kg)", 
                            "Massa Muscular Esquelética do Braço Esquerdo" = "MME do Braço Esquerdo (kg)", 
                            "Massa Muscular Esquelética da Perna Direita" = "MME da Perna Direita (kg)", 
                            "Massa Muscular Esquelética da Perna Esquerda" = "MME da Perna Esquerda (kg)", 
                            "Água Corporal Total" = "Água Corporal Total (L)", 
                            "Água Extracelular" = "Água Extracelular (L)", 
                            "Gasto Energético Total" = "Gasto Energético Total (kcal)", 
                            "Gasto Energético em Repouso" = "Gasto Energético em Repouso (kcal)", 
                            "Energia Armazenada" = "Energia Armazenada (kcal)")
        ) %>%
    mutate(Parâmetro = factor(Parâmetro, levels = c(
    "Altura (m)", "Peso (kg)", "Índice de Massa Corporal (kg/m²)", "Circunferência Abdominal (m)", 
    "Nível de Atividade Física (PAL)", "Ângulo de Fase (°)", "Resistência (Ω)", "Reatância (Ω)", 
    "Massa gorda Absoluta (kg)", "Índice de Massa gorda (kg/m²)", "Massa gorda Relativa (%)", 
    "Tecido Adiposo Visceral (kg)", "Massa Livre de Gordura Absoluta (kg)", 
    "Índice de Massa Livre de Gordura (kg/m²)", "Massa Livre de Gordura Relativa (%)", 
    "MME Corporal Total (kg)", "MME do Tronco (kg)", "MME do Braço Direito (kg)", 
    "MME do Braço Esquerdo (kg)", "MME da Perna Direita (kg)", "MME da Perna Esquerda (kg)", 
    "Água Corporal Total (L)", "Água Extracelular (L)", "Gasto Energético Total (kcal)", 
    "Gasto Energético em Repouso (kcal)", "Energia Armazenada (kcal)"))
    ) %>% 
    arrange(Parâmetro)

write_csv(bia_females, here("Output", "Baseline", "Tables", "bia_females.csv"))
```

## Handgrip

```{r, eval=FALSE}
handgrip <- data %>% 
    select(record_id, event_name, handgrip_right_mean, handgrip_left_mean) %>% 
    filter(
        event_name == "1visit_arm_1"
    ) %>% 
    filter(
        !is.na(handgrip_right_mean) | !is.na(handgrip_left_mean)
    ) %>% 
    left_join(
        data_d1_exclusive %>% 
            select(
                record_id, sex, allocation_group
            ),
        by = "record_id"
    ) %>% 
    mutate(
        handgrip = rowMeans(
            across(c(handgrip_left_mean, handgrip_right_mean)),
            na.rm = TRUE
        )
    )
#write_excel_csv(handgrip,paste0(file_path_baseline,"handgrip.csv"))

summarize_numerical(handgrip,"sex")
compare_groups(handgrip,"sex")

# handgrip %>% 
    filter(
        sex == "Masculino"
    ) %>% 
    group_by(
        allocation_group
    ) %>% 
    summarize(
        `Média da mão direita` = mean(handgrip_right_mean, na.rm = TRUE),
        `Média da mão esquerda` = mean(handgrip_left_mean, na.rm = TRUE),
        `Média das mãos` = mean(handgrip, na.rm = TRUE),
    )

# Males
handgrip_man <- handgrip %>% 
    filter(
        sex == "Masculino"
    )
handgrip_man_num <- print(summarize_numerical(handgrip_man, "allocation_group"))
handgrip_man_compare <- print(compare_groups(handgrip_man, "allocation_group"))

# Females
handgrip_fem <- handgrip %>% 
    filter(
        sex == "Feminino"
    )
handgrip_fem_num <- print(summarize_numerical(handgrip_fem, "allocation_group"))
handgrip_fem_compare <- print(compare_groups(handgrip_fem, "allocation_group"))
```

## Questionnaires

```{r, eval=FALSE}
questionnaires <- data_filtered %>% 
    ungroup() %>% 
    filter(
        visit == 1
    ) %>% 
    select(
        record_id, allocation_group, sex, whoqol_score_overall:ecap_score
    )

# write_excel_csv(questionnaires, paste0(file_path_baseline,"questionnaires.csv"))

questionnaires_num <- summarize_numerical(questionnaires)
questionnaires_num_groups <- summarize_numerical(questionnaires,"allocation_group")
questionnaires_num_groups_compare <- compare_groups(questionnaires,"allocation_group")

# By sex
questionnaires_sex <- summarize_numerical(questionnaires,"sex")
questionnaires_sex_compare <- compare_groups(questionnaires,"sex")
print(questionnaires_sex_compare)

# By allocation_group
questionnaires_num <- summarize_numerical(questionnaires,"allocation_group")
questionnaires_num_compare <- compare_groups(questionnaires,"allocation_group")
print(questionnaires_sex_compare)

# ANOVA to search for interaction between sex and allocation
anova_whoqol <- aov(whoqol_score_overall ~ sex * allocation_group, data = questionnaires)
summary(anova_whoqol)
anova_depression <- aov(dass_score_depression ~ sex * allocation_group, data = questionnaires)
summary(anova_depression)
anova_anxiety <- aov(dass_score_anxiety ~ sex * allocation_group, data = questionnaires)
summary(anova_anxiety)
anova_stress <- aov(dass_score_stress ~ sex * allocation_group, data = questionnaires)
summary(anova_stress)
anova_ecap <- aov(ecap_score ~ sex * allocation_group, data = questionnaires)
summary(anova_ecap)

```

## Adverse Events

```{r, eval=FALSE}
adverse_events <- read_csv('/Users/gustavosplmoura/Library/Mobile Documents/com~apple~CloudDocs/Medicina/Biblioteca/Research/Data Science/Data Science/PROJECTS/DVEP/Analysis/adverse_events.csv')

adverse_events$`Nome completo` <- substr(adverse_events$`Nome completo`,1,2)
colnames(adverse_events) <- trimws(colnames(adverse_events))

adverse_events_yes <- adverse_events %>%
    filter(
        `Algum Evento Adverso neste ciclo?` == "Sim"
    ) %>% 
    mutate(
        `Nome completo` = as.integer(`Nome completo`)
    ) %>%
    left_join(
        data_d1_exclusive %>%
            select(record_id, sex, allocation_group),
        by = join_by(`Nome completo` == record_id)
    ) %>% 
    mutate(
        `Event Name` = as.factor(`Event Name`),
        `Evento Adverso Grave?  ` = as.factor(`Evento Adverso Grave?  `),
        Grau = as.factor(Grau),
        Classificação = as.factor(Classificação),
        `Atribuição de causalidade` = as.factor(`Atribuição de causalidade`),
        `Ação Realizada` = as.factor(`Ação Realizada`),
        Seguimento = as.factor(Seguimento),
        `Nome completo` = as.character(`Nome completo`)
    )

#summarize_categorical
adverse_events_cat <- summarize_categorical(adverse_events_yes)
## write_excel_csv(adverse_events_cat, paste0(file_path_baseline, "adverse_events_cat.csv"))

#baseR: summary
summary(adverse_events_yes)
```

**Association between visit (time point) and severity of adverse event** Testing for an association between visit (time point) and severity of adverse events to evaluate whether the likelihood of experiencing severe adverse events changes as the intervention progresses (Chi-squared test of independence)

```{r, eval=FALSE}
# contingency table
table_ae <- table(adverse_events_yes$`Event Name`, adverse_events_yes$Grau)
print(table_ae)

# Chi-square
chisq_test <- chisq.test(table_ae)
print(chisq_test)
chisq_test$expected
## Many cells with expected counts < 5 -> FET would be more appropriate
fisher_test <- fisher.test(table_ae)
print(fisher_test)

adverse_events_yes$allocation_group

```

--\> Running Mantel-Haenszel test to control for the intervention group

```{r, eval=FALSE}
library(gmodels)

# CrossTable to explore the stratified data
CrossTable(
  x = adverse_events_yes$`Event Name`, 
  y = adverse_events_yes$Grau, 
  strata = adverse_events_yes$allocation_group,
  prop.chisq = FALSE, 
  prop.r = FALSE, 
  prop.c = FALSE, 
  prop.t = FALSE
)

# Create a 3D contingency table stratified by allocation group
table_visit_severity_allocation <- table(
    adverse_events_yes$`Event Name`, adverse_events_yes$Grau, adverse_events_yes$allocation_group
    )
print(table_visit_severity_allocation)

# Mantel-Haenszel test
mantel_test <- mantelhaen.test(table_visit_severity_allocation)
print(mantel_test)

```

**By severity**

```{r, eval=FALSE}
table_ae <- table(adverse_events_yes$Classificação, adverse_events_yes$Grau)
print(table_ae)
```

**By causality**

```{r, eval=FALSE}
table_ae <- table(adverse_events_yes$Classificação, adverse_events_yes$`Atribuição de causalidade`)
View(table_ae)
```

**Gastrointestinal**

```{r, eval=FALSE}
ae_gastrointestinal <- adverse_events_yes %>% 
    filter(
        Classificação == "Gastrointestinal"
    )
```

**Grouping events by classification**

```{r, eval=FALSE}

# Group by Classificação and Evento Adverso, count occurrences, and calculate percentages
summary_data <- adverse_events_yes %>%
  group_by(Classificação, `Evento Adverso`) %>%
  summarise(Count = n(), .groups = "drop") %>%
  mutate(Percentage = (Count / sum(Count)) * 100) %>%
  arrange(Classificação, desc(Count))

# Create the formatted output
formatted_output <- summary_data %>%
  group_by(Classificação) %>%
  summarise(
    Events = paste0(`Evento Adverso`, " (", round(Percentage, 1), "%)", collapse = ", "),
    .groups = "drop"
  ) %>%
  mutate(Result = paste0(Classificação, ": ", Events))

# Print the result
cat(paste(formatted_output$Result, collapse = "\n"))

# Save file
write_lines(paste(formatted_output$Result, collapse = "\n"), paste0(file_path_baseline, "eventos_adversos_por_sistema.txt"))


```

**Clear**

```{r, eval=FALSE}
rm(questionnaires)
rm(questionnaires_num)
rm(questionnaires_compare)

```

**Clear**

```{r, eval=FALSE}
rm()
rm()
rm()
rm()
rm()
```

**Clear**

```{r, eval=FALSE}
rm()
rm()
rm()
rm()
rm()
```

**Clear**

```{r, eval=FALSE}
rm()
rm()
rm()
rm()
rm()
```

Os participantes foram recrutados entre 9 de agosto de 2023 e `r max(database$consent_date, na.rm = TRUE)`. O estudo foi concluído em 26 de julho de 2024.

## Desfecho Primário

### Efeito sobre o ângulo de fase

```{r}
filter_codebook(form_name = "bia", included = 1) %>% pull(variable)
filter_data(visit = c("V1","V3"), form_name = "bia")
```

```{r}
data %>% filter(
    !is.na(phase_angle) 
) %>% 
    select(
        filter_codebook(form_name = "bia", included = 1) %>% pull(variable)
    ) %>% 
    skimr::skim()
```

```{r}
typeof(data$smoked_24h_yn)
```

```{r}
library(lme4)
library(lmerTest) # Adds p-values to summary()
# model <- lmer(outcome ~ time + group + (1 | id), data = df)

model1 <- lmer(phase_angle ~ visit + allocation_group + (1 | record_id), data = data_filtered)
model1

summary(model1)

plot(model1)

res <- resid(model1, type = "pearson")
fitted_vals <- fitted(model1)
plot(fitted_vals, res, 
     xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, col = "gray")
```

```{r}
library(ggplot2)
ggplot(data_filtered, aes(x = visit, y = phase_angle, group = record_id, color = allocation_group)) +
  geom_line(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE)

```

```{r}
model2 <- lmer(phase_angle ~ visit * allocation_group + (1 | record_id), data = data_filtered)
summary(model2)
```

```{r}
model3 <- lmer(labs_crp ~ visit + allocation_group + (1 | record_id), data = data_filtered)

summary(model3)

plot(model3)  # Residuals vs. fitted

qqnorm(resid(model3)); qqline(resid(model3))  # Normality check
```

.

```{r}
model3_log <- lmer(log1p(labs_crp) ~ visit + allocation_group + (1 | record_id), data = data_filtered)
summary(model3_log)

plot(model3_log)

qqnorm(resid(model3_log)); qqline(resid(model3_log))  # Normality check
```

**log+1 transformation** to the skewed CRP variable, and the results show clear improvement.

| **Term** | **Estimate** | **p-value** | **Interpretation** |
|----------------|----------------|----------------|--------------------------|
| **Intercept** | 1.82 | \<0.001 | Mean **log(CRP + 1)** at baseline in Grupo A |
| **Visit** | –0.099 | 0.036 | **CRP decreases significantly over time** |
| **Grupo B (vs A)** | +0.139 | 0.405 | No significant difference at baseline |

The **effect of visit became statistically significant** (p = 0.036), whereas it was borderline before (p = 0.072).

**Diagnostic Plots** **Residuals vs. Fitted**

-   More **symmetrical and homoscedastic** than before.

-   No clear fan shape or funnel — much better than untransformed.

**Q-Q Plot**

-   **Much closer to the line**, indicating that residuals are approximately **normally distributed**.

-   A few expected mild deviations at the tails, but very acceptable.

**What does this mean in original CRP scale?**

Let’s back-transform the time effect:

-   Estimate for visit = –0.099

-   Since you’re modeling log1p(CRP), to interpret in original scale:

$$\\text{exp}(-0.099) = 0.9056$$

This means: **each visit is associated with \~9.4% decrease** in CRP over time, **on average**.

**Summary**

| **Point**          | **Result**                                |
|--------------------|-------------------------------------------|
| Residuals          | Look better: less heteroscedasticity      |
| Q-Q plot           | Much closer to normal                     |
| Time effect        | Now statistically significant (p = 0.036) |
| Log transformation | Successfully improved model performance   |

The idea is to explore the antiinflamatory effect of the intervention. Currently, the model assumes parallel time trends for both groups, i.e., it estimates:

-   A main effect of time (CRP changes over time),

-   A main effect of group (baseline difference),

-   But no interaction (i.e., it assumes both groups change equally over time).

*Why this is not enough*

If the intervention is effective, we expect:

-   CRP to decrease faster in the intervention group (Grupo B),

-   Which means there should be a significant interaction between visit and allocation_group.

*Model with interaction:*

-   Adds visit:allocation_groupGrupo B as an interaction term,

-   Tests whether CRP changes differently over time in Grupo B vs Grupo A.

```{r}
model3_log_inter <- lmer(log1p(labs_crp) ~ visit * allocation_group + (1 | record_id), data = data_filtered)

summary(model3_log_inter)

plot(model3_log_inter)

qqnorm(resid(model3_log_inter)); qqline(resid(model3_log_inter))  # Normality check
```

Key Result: No Significant Interaction • The term visit:allocation_groupGrupo B has p = 0.620, meaning: There is no statistical evidence that the intervention led to a greater reduction in CRP over time compared to control. • The trend for CRP decrease over time is similar in both groups.

Interpretation

Despite applying a more appropriate transformation and including the interaction: • Time still shows a mild (non-significant) decreasing trend in CRP. • No baseline difference between groups. • No enhanced effect in the intervention group.

This means that, based on your data, the intervention did not show a measurable anti-inflammatory effect on CRP.

*PLOT* plot shows: • Predicted log(CRP + 1) at each visit for each group. • Makes it easy to compare time trends across intervention and control groups on the same scale used in the model. • Useful for statistical interpretation and checking for meaningful differences.

```{r}
# Create a new data frame for prediction: all combinations of visit × group
new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
)

# Predict fixed effects (marginal means, no random effects)
new_data$pred_log_crp <- predict(model3_log_inter, newdata = new_data, re.form = NA)

# Plot predicted log(CRP + 1)
ggplot(new_data, aes(x = visit, y = pred_log_crp, color = allocation_group, group = allocation_group)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Predicted CRP over Time (log scale)",
    y = "Predicted log(CRP + 1)",
    x = "Visit",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

*Visual Insights*

-   Both groups show a downward trend in CRP over time, suggesting a general anti-inflammatory progression.

-   Grupo B starts at a higher baseline and appears to have a slightly steeper decline in log(CRP), although:

    > 🔸 The interaction term was not statistically significant (p = 0.620).

This means that although Grupo B appears to improve more, this difference in slopes is not statistically supported.

*Grupo B's Higher Baseline*

Baseline imbalance may be a concern, particularly when:

1.  The groups were supposed to be randomized and equivalent at baseline, and

2.  The outcome variable (CRP, in this case) is already higher in one group before the intervention starts.

If Grupo B starts with higher CRP, then:

-   Any greater absolute reduction over time may be due to regression to the mean, not the intervention.

-   It violates the assumption that both groups are comparable at baseline, which undermines causal inference.

*Adjust for baseline differences:*

What this model does:

-   Adjusts for baseline CRP directly, reducing bias from initial imbalance.

-   The coefficient for allocation_groupGrupo B now reflects the difference at follow-up, controlling for baseline.

-   The time effect (visit) still captures change over time.

-   The model tests whether the intervention group had lower CRP over time than expected based on their higher starting levels.

If log1p_baseline_crp is significant, it means initial inflammation strongly predicts future levels — expected in longitudinal biomarkers.

If allocation_groupGrupo B or the visit:group interaction becomes significant after adjustment, that strengthens the case for a true treatment effect.

Let me know if you’d like to: • Visualize adjusted predictions • Back-transform to original CRP scale • Handle this in a subset of visits (e.g. only V1 and V3)

```{r}
# Adjusting for Baseline CRP in the Mixed Model (on log scale)

# Step 1: Create a baseline CRP variable (log-transformed)
# You should ensure that baseline CRP is correctly identified from your data

# Example: assuming visit 1 is baseline
data_filtered <- data_filtered %>%
  group_by(record_id) %>%
  mutate(log1p_baseline_crp = first(log1p(labs_crp[visit == 1]))) %>%
  ungroup()

# Step 2: Fit the adjusted model
model3_log_adj <- lmer(
  log1p(labs_crp) ~ visit + allocation_group + log1p_baseline_crp + (1 | record_id),
  data = data_filtered
)

# Step 3: Summarize the results
summary(model3_log_adj)
```

This model directly controls for **baseline differences in CRP**, correcting the bias introduced by the fact that **Grupo B started with higher inflammation**.

**Fixed Effects Summary**

| **Term** | **Estimate** | **p-value** | **Interpretation** |
|---------------|---------------|---------------|-----------------------------|
| **(Intercept)** | 0.529 | \<0.001 | Estimated log(CRP+1) for Grupo A at baseline when baseline CRP is 0 |
| **visit** | –0.106 | **0.015** | CRP significantly **decreases over time** |
| **Grupo B (vs Grupo A)** | –0.008 | 0.919 | No difference between groups **after adjusting for baseline** |
| **log1p_baseline_crp** | +0.772 | \<0.001 | Strong predictor: higher baseline CRP leads to higher follow-up CRP |

------------------------------------------------------------------------

**Key Takeaways**

-   **Time effect (visit) is now significant (p = 0.015)**:

    > CRP decreases over time **even after accounting for baseline**.

-   **Grupo B effect disappears (p = 0.919)**:

    > Once you adjust for baseline CRP, there’s **no evidence the intervention had a distinct effect** on CRP reduction compared to control.

-   **Baseline CRP is a major driver** of later CRP (β = 0.77, p \< 0.001).

**Interpretation**

The original difference in CRP trends between groups was likely due to **baseline imbalance**, not the intervention itself.

This adjusted model is **more reliable**, and the results suggest:

-   CRP decreases over time for all participants,

-   But the intervention **did not produce a differential anti-inflammatory effect**.

**Dropout Influence**

```{r}
#Step 1: Check the distribution of visits per subject
# Count number of observations per subject
dropout_check <- data_filtered %>%
  group_by(record_id) %>%
  summarize(n_visits = n_distinct(visit)) %>%
  count(n_visits)


#Step 2: Compare dropout by group
## Last visit per subject
last_visit_by_group <- data_filtered %>%
  group_by(record_id, allocation_group) %>%
  summarize(last_visit = max(visit)) %>%
  ungroup()

# Table: proportion reaching visit 3
table(last_visit_by_group$allocation_group, last_visit_by_group$last_visit)
# This checks whether Grupo B had more missing data at later visits than Grupo A — which could confound the CRP trajectory comparison.

#Step 3: Is dropout related to baseline CRP?
# If participants who dropped out had higher baseline CRP, your results may be biased due to non-random missingness (MNAR).

# Use the baseline CRP and check whether it's different in dropouts
baseline_dropout <- data_filtered %>%
  group_by(record_id) %>%
  mutate(last_visit = max(visit)) %>%
  filter(visit == 1) %>%
  mutate(dropped_out = last_visit < 3)

# Compare baseline CRP by dropout status
t.test(log1p(labs_crp) ~ dropped_out, data = baseline_dropout)
```

	•	Participants who dropped out had slightly lower CRP at baseline, but the difference is not statistically significant.
	•	There’s no evidence that dropout was related to baseline inflammation.
	•	Dropout appears to be random with respect to baseline CRP, which supports the Missing at Random (MAR) assumption.
	
Because:
	•	The mixed-effects model (LMM) is valid under MAR,
	•	There’s no significant baseline CRP difference between those who stayed and those who dropped out,

➡️ Your model results are likely unbiased with respect to dropout.

```{r}
# Back-transforming predicted log(CRP + 1) values to CRP (mg/L)

# Step 1: Create a prediction grid for all combinations of visit × group
# Use the median baseline CRP for prediction (in log1p scale)
baseline_crp_median <- median(log1p(baseline_dropout$labs_crp), na.rm = TRUE)

# Create grid of new data
new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
) %>%
  mutate(log1p_baseline_crp = baseline_crp_median)

# Step 2: Predict from the adjusted model (fixed effects only)
new_data$pred_log <- predict(model3_log_adj, newdata = new_data, re.form = NA)

# Step 3: Back-transform
new_data$pred_crp <- exp(new_data$pred_log) - 1

# Step 4: Plot back-transformed predictions
ggplot(new_data, aes(x = visit, y = pred_crp, color = allocation_group, group = allocation_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  labs(
    title = "Predicted CRP Levels Over Time (Back-Transformed)",
    x = "Visit",
    y = "Predicted CRP (mg/L)",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

What this plot shows

	•	Predicted CRP levels in mg/L, adjusted for the median baseline CRP.
	•	Makes the model output clinically interpretable.

You can clearly see:
	•	The overall downward trend in CRP over time.
	•	That Grupo B does not differ from Grupo A in rate of CRP decline after adjusting for baseline.
	
```{r}
# ✅ Add confidence intervals to predicted CRP plot (back-transformed)

# Load required packages
library(ggplot2)
library(dplyr)
library(merTools)  # for predictInterval

# Step 1: Create new data with baseline CRP held at median
baseline_crp_median <- median(log1p(baseline_dropout$labs_crp), na.rm = TRUE)

new_data <- expand.grid(
  visit = unique(data_filtered$visit),
  allocation_group = unique(data_filtered$allocation_group)
) %>%
  mutate(
    log1p_baseline_crp = baseline_crp_median,
    record_id = "dummy"  # 👈 Add a dummy ID to match model's grouping variable
  )

# Step 2: Get prediction intervals on log scale (includes uncertainty)
set.seed(123)  # for reproducibility
pred_int <- predictInterval(
  model3_log_adj,
  newdata = new_data,
  level = 0.95,
  n.sims = 1000,
  stat = "mean",
  type = "linear.prediction",
  include.resid.var = FALSE
)

# Combine with original new_data
new_data <- bind_cols(new_data, pred_int)

# Step 3: Back-transform
new_data <- new_data %>%
  mutate(
    fit = exp(fit) - 1,
    lwr = exp(lwr) - 1,
    upr = exp(upr) - 1
  )

# Step 4: Plot with ribbons (CI)
ggplot(new_data, aes(x = visit, y = fit, color = allocation_group, group = allocation_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = allocation_group), alpha = 0.2, color = NA) +
  labs(
    title = "Predicted CRP Levels with 95% CI (Back-Transformed)",
    y = "Predicted CRP (mg/L)",
    x = "Visit",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
# Optional: Line plot of individual trajectories
ggplot(data_filtered, aes(x = visit, y = labs_crp, group = record_id, color = allocation_group)) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Individual CRP Trajectories (Raw Data)",
    y = "Observed CRP (mg/L)",
    x = "Visit",
    color = "Group"
  ) +
  theme_minimal(base_size = 14)
```

