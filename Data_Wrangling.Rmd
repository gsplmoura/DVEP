---
title: "DVEP Data Analysis"
author: "Gustavo Santos Paiva Laender Moura"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document
PID: REDCap 1958
project: Effect of Eclipta prostrata (L.) L. (Asteraceae) on bioelectrical impedance
  phase angle in adults with grade I obesity (DVEP)
---

```{r setup}
knitr::opts_chunk$set(
  results = 'hide',
  message = FALSE,
  warning = FALSE
)

# 1. Getting started with R
## Clear existing data and graphics

rm(list = ls())
graphics.off()
cat("\014")  # Clear any pending RStudio sessions or temporary files

## Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(purrr)
library(here)

# Load functions from external script
source("helper_functions.R")
```

# First Steps
## Read Files
### Codebooks

```{r}
codebook_dvep <- read_excel(
        "Codebooks/codebook_dvep.xlsx",
        col_names = TRUE,
        col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) %>%
    arrange(index)

codebook_structure  <- read_csv(
  "Codebooks/codebook_structure.csv",
  col_names = TRUE)

codebook_ncit  <- read_csv(
  "Codebooks/codebook_ncit.csv",
  col_names = TRUE)

codebook_bia <- read_excel(
    "Codebooks/codebook_bia.xlsx",
    col_names = TRUE,
    col_types = NULL,
        na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
        trim_ws = TRUE,
        skip = 0, # Number of lines to skip before reading data
        n_max = Inf, # Maximum number of lines to read.
        guess_max = 1000
    ) %>%
    arrange(index)
```

### Data

```{r}

data  <- read_csv(
  "Data/data_dvep.csv",
  col_names = TRUE,
  col_types = NULL, #column types will be inferred from guess_max
  col_select = NULL,
  id = NULL,
  locale = default_locale(),
  na = c("", "NA", "NI", "UNK", "NASK", "ASKU", "INV"),
  quote = "\"",
  comment = "",
  trim_ws = TRUE,
  skip = 0, # Number of lines to skip before reading data
  n_max = Inf, # Maximum number of lines to read.
  guess_max = 1000,
  name_repair = "unique",
  num_threads = readr_threads(),
  progress = show_progress(),
  show_col_types = TRUE,
  skip_empty_rows = TRUE,
  lazy = should_read_lazy()
)

data_bia_D3_raw <- read_csv(
    "Data/data_bia_D3.csv",
    col_names = TRUE)

data_bia_D1_raw <- read_csv(
    "Data/data_bia_D1.csv",
    col_names = TRUE)

```

## Remove identifying data from record_id

```{r}
data$record_id <- substr(data$record_id,1,2)
data_bia_D3_raw $File <- substr(data_bia_D3_raw $File,1,2)
data_bia_D1_raw$File <- substr(data_bia_D1_raw$File,1,2)
```

## Renaming variables

```{r}
# DATA
rename_data <- setNames(object = colnames(data), codebook_dvep$variable)
data <- data %>%
    rename(!!!rename_data)
rm(rename_data)

#BIA
rename_bia <- setNames(object = colnames(data_bia_D3_raw ), codebook_bia$variable)

data_bia_D3_raw <- data_bia_D3_raw %>%
    rename(!!!rename_bia)

data_bia_D1_raw <- data_bia_D1_raw %>%
    rename(!!!rename_bia)

rm(rename_bia)
```

## record_id as.integer

```{r}
data$record_id <- as.integer(data$record_id)
data_bia_D3_raw $record_id <- as.integer(data_bia_D3_raw $record_id)
data_bia_D1_raw$record_id <- as.integer(data_bia_D1_raw$record_id)
```

## Assign labels to variables

```{r}
data <- data %>% 
  mutate(across(
    all_of(codebook_dvep$variable),
    ~ {
      attr(., "label") <- codebook_dvep$label_pt[codebook_dvep$variable == cur_column()]
      .
    }
  ))

data_bia_D3_raw <- data_bia_D3_raw %>% 
  mutate(across(
    all_of(codebook_bia$variable),
    ~ {
      attr(., "label") <- codebook_bia$label_pt[codebook_bia$variable == cur_column()]
      .
    }
  ))

```

# DATA WRANGLING
## SECA BIA DATA 

(DIRECT IMPORT FROM BIOIMPEDANCE DEVICE)

This corresponds to the first version of the code. However, it relies on data directly imported from the bioimpedance device, and contains one to three measurements per participant. Therefore, the data needs to be wrangled to obtain the mean of the measurements for each participant.

However, for now (April 09th, 2025), I will depracate this code and analyse the data directly recorded into the REDCap project by the research collaborators. The code below is kept for reference, but will not be used in the analysis as of now. If needed, I will re-implement it in the future.

#### Data from first/third visit

Applies to participants who completed the intervention

```{r}
# Filter by rows with values for phase angles
data_bia_D3 <- data_bia_D3_raw %>% 
    dplyr::filter(!is.na(phaseangle)) %>% 
    dplyr::mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) %>% 
    dplyr::select(all_of(codebook_bia$variable)[codebook_bia$included == 1], date, time) %>% 
    dplyr::relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) %>% 
    dplyr::arrange(record_id, date, time) %>% 
    dplyr::group_by(record_id) %>% 
    dplyr::mutate(
        visit = dplyr::dense_rank(date),
        .after = record_id) %>% 
  dplyr::ungroup()
    

# Mean of multiple measurements from the same day
# Group by record_id and visit

data_bia_D3_mean <- data_bia_D3 %>% 
    dplyr::group_by(record_id, visit) %>%
    dplyr::summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) # %>% This chunk was removed since coding was added to the last call
    #dplyr::group_by(record_id) %>% # Add coding for visit number
    #dplyr::mutate(
    #    visit = case_when(
    #        date == min(date) ~ 1,  # Assign 1 to the earliest date
    #        date == max(date) ~ 3,  # Assign 3 to the latest date
    #        TRUE ~ NA_real_         # Default to NA for unexpected cases
    #    ),
    #    .after = record_id
    #)
```

#### Data from first visit

Applies to participants who did not complete the intervention

```{r}
# Filter by rows with values for phase angles
data_bia_D1 <- data_bia_D1_raw %>% 
    dplyr::filter(!is.na(phaseangle)) %>% 
    dplyr::mutate(
        date = as.Date(timestamp),           # Extract the date
        time = format(timestamp, "%H:%M:%S") # Extract the time
    ) %>% 
    dplyr::select(all_of(codebook_bia$variable)[codebook_bia$included == 1], date, time) %>% 
    dplyr::relocate(record_id, date, time, phaseangle, raverage, xcaverage, weight:w_ecwbytbw) %>% 
    dplyr::arrange(record_id, date, time) %>% 
    dplyr::group_by(record_id) %>% 
    dplyr::mutate(
        visit = dplyr::dense_rank(date),
        .after = record_id) %>% 
    dplyr::ungroup()

# Selecting data from D1 not present in D3
data_bia_D1 <- data_bia_D1 %>% 
    dplyr::filter(
     record_id %in% setdiff(1:75, data_bia_D3$record_id)   
    )

# Mean of multiple measurements from the same day
# Group by record_id and visit

data_bia_D1_mean <- data_bia_D1 %>% 
    dplyr::group_by(record_id, visit) %>%
    dplyr::summarise(
        across(c(phaseangle:m_tohimaginary), \(x) mean(x, na.rm = TRUE)),
        .groups = "drop"
    ) # %>% This chunk was removed since coding was added to the last call
    # dplyr::group_by(record_id) %>% # Add coding for visit number
    # mutate(
    #     visit = case_when(
    #         date == min(date) ~ 1,  # Assign 1 to the earliest date
    #         date == max(date) ~ 3,  # Assign 3 to the latest date
    #         TRUE ~ NA_real_         # Default to NA for unexpected cases
    #     ),
    #     .after = record_id
    # )

```

#### Merging D1/D3 to single tibble

All measurements

```{r}
data_bia <- bind_rows(
    data_bia_D1, data_bia_D3
) %>% 
    dplyr::mutate(
        visit = as.integer(visit)
    ) %>% 
    dplyr::arrange(
        record_id, visit
    ) %>% 
    ungroup()

# label_variables()
data_bia <- label_variables(data_bia, codebook_bia)
```

Mean of measurements

```{r}
data_bia_mean <- bind_rows(
    data_bia_D1_mean, data_bia_D3_mean
) %>% 
    dplyr::mutate(
        visit = as.integer(visit)
    ) %>% 
    dplyr::arrange(
        record_id, visit
    ) %>% 
    ungroup()

### label_variables
data_bia_mean <- label_variables(data_bia, codebook_bia)
```

#### Drop intermediate tibbles

```{r, eval=FALSE}
rm(data_bia_D1_raw)
rm(data_bia_D1)
rm(data_bia_D3_raw)
rm(data_bia_D3)
```


## REDCAP DATA

**LEFT JOIN NCIT LABELS**

Left join NCIT labels to I21_conditions_R and I22_drugs_R and add variable labels

```{r}
I21_conditions_R <- filter_data("eleg", 1, "conditions") %>%
  left_join(
    dplyr::select(codebook_ncit, ncit_code, descriptive),
    join_by(common_comorbidities == ncit_code)
  ) %>%
  dplyr::relocate(descriptive, .after = common_comorbidities)

I21_conditions_R <- label_variables(I21_conditions_R, codebook_dvep)

#### Drugs in regular use
I22_drugs_R  <- filter_data("eleg",1,"drugs")  %>% 
    left_join(
        codebook_ncit %>% dplyr::select(ncit_code, descriptive),
        join_by(drugs_sql == ncit_code)
    ) %>%
    dplyr::relocate(
        descriptive, .after = drugs_sql
    )

I22_drugs_R <- label_variables(I22_drugs_R, codebook_dvep)
```


```{r, eval=FALSE}
# # 1.3 Previous drugs
# I23_old_drugs_R <- filter_data("eleg",1,"old.drugs") %>% 
#     left_join(
#         codebook_ncit %>% dplyr::select(ncit_code, descriptive),
#         join_by(common_previous_medications == ncit_code)
#     )%>%
#     dplyr::relocate(
#         descriptive, .after = common_previous_medications
#     )
# 
# # 1.4 Past medical conditions
# I24_old_conditions_R <- filter_data("eleg",1,"history") %>% 
#     left_join(
#         codebook_ncit %>% dplyr::select(ncit_code, descriptive),
#         join_by(common_medical_history == ncit_code)
#     )%>%
#     dplyr::relocate(
#         descriptive, .after = common_medical_history
#     )


# Most common comorbidities
# I21_conditions_R %>% 
#     group_by(common_comorbidities, descriptive) %>% 
#     count(common_comorbidities, sort = TRUE, name = "frequency") %>% 
#     mutate(percentage = round((frequency/75 * 100),1)) %>% 
#     view()

# NCIT    Condition   
# C3117	Hipertensão	                18	24         *1
# C26696	Ansiedade	                16	21.3        
# C37967	Hipercolesterolemia         16	21.3       *2
# C37971	Hipertrigliceridemia        13	17.3       *2
# C113101	Resistência à insulina      11	14.7       *3
# C26800	Hipotireoidismo             9	12         
# C89715	Enxaqueca	                8	10.7
# C114667	SOP                     	7	9.3
# C26747	DM2                     	7	9.3        *3
 
# Most common drugs
# ```{r, eval = FALSE}
# I22_drugs_R %>% 
#     group_by(drugs_sql, descriptive) %>% 
#     count(drugs_sql, sort = TRUE, name = "frequency") %>% 
#     mutate(percentage = round((frequency/75 * 100),1)) %>% 
#     view()
```

### DEMOGRAPHICS AND INTERVENTION DATA 

To be replicated to d2 and d3

```{r}

eleg_exclusive <- filter_data("eleg",0) %>% 
    dplyr::mutate(
        intervention_duration = as.numeric(conclusion_date - intervention_start_date)
        )%>% 
    dplyr::select(record_id, allocation_group, completed_intervention, intervention_duration, non_completion_reason, age, sex)

visit_1_exclusive <- filter_data("V1",0) %>% 
    dplyr::select(
        record_id,
        race:income_level
    ) %>% 
        # codebook_dvep$choices[codebook_dvep$variable == "race"]
        # [1] "c41260, Asiático | c41261, Branco origem europeia |
        # c128994, Branco origem América do Sul | c16352, Negro | 
        # c17998, desconhecido | c17649, Outro"
    dplyr::mutate(
        race = if_else(race == "c41261", "c128994", race)
    )

data_d1_exclusive <- eleg_exclusive %>% 
    dplyr::left_join(
        visit_1_exclusive,
        by = join_by(record_id)
)

rm(eleg_exclusive)
rm(visit_1_exclusive)
```

### REPEATING INSTRUMENTS
#### Creating relevant binary variables

1. Hypertension
```{r}
### HYPERTENSION
#### Extract record IDs associated with hypertension diagnosis
hypertension_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C3117")) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypertensive drugs
hypertension_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C66869|C29098|C61635|C47640_2|C28836|C29254|C62027|C62027_2"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign hypertension based on conditions or drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypertension = if_else(
        record_id %in% hypertension_conditions, 
        1, 
        if_else(
            record_id %in% hypertension_drugs, 
            1, 
            0
        )
    ))

rm(hypertension_conditions)
rm(hypertension_drugs)
```

2. Hypercolesterolemia
```{r}
# This new version creates two variable: hypercolesterolemia and hypertrigliceridemia

#### Extract record IDs associated with hypercholesterolemia
#### Hipercolesterolemia (LDL ≥ 130 ou não-HDL ≥ 160 ou CT ≥ 190 mg/dl)

# I21_conditions_R %>% distinct(common_comorbidities, descriptive) %>% view()

hypercholesterolemia_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C37967")) %>% 
    # C37967 = Hipercolesterolemia isolada (LDL ≥ 160)
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypercholesterolemia drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C29454", "C66523_2", "C47529", "C61527", "C87471")) %>% distinct(drugs_sql, descriptive)
#>   A tibble: 5 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C87471    Ciprofibrato 100 mg (Comp.) removed
#> 2 C29454    Sinvastatina 20 mg (Comp.) 
#> 3 C66523_2  Rosuvastatina 10 mg (Comp.)
#> 4 C61527    Atorvastatina 40 mg (Comp.)
#> 5 C47529    Ezetimiba 10 mg  

hypercholesterolemia_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C29454|C66523_2|C47529|C61527")
        ) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with abnormal lab results on first lab
hypercolesterolemia_labs <- data %>% 
    dplyr::filter(labs_ldl >= 130 | labs_cholesterol >= 190 | labs_cholesterol - labs_hdl >= 160) %>%
    dplyr::pull(record_id)

#### Assign hypercholesterolemia based on conditions, drugs, or first labs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypercholesterolemia = 
               if_else(record_id %in% hypercholesterolemia_conditions, 1, 
                       if_else(record_id %in% hypercholesterolemia_drugs, 1,
                               if_else(record_id %in% hypercolesterolemia_labs, 1, 0))))

rm(hypercholesterolemia_conditions)
rm(hypercholesterolemia_drugs)
rm(hypercolesterolemia_labs)

```

3. Hypertrigliceridemia

```{r}
#### Extract record IDs associated with hypertrigliceridemia
#### Hipertrigliceridemia (TAG ≥ 150 mg/dl)

# I21_conditions_R %>% distinct(common_comorbidities, descriptive) %>% view()

hypertrigliceridemia_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C37971")) %>% 
    # C37971 = Hipertrigliceridemia (TAG ≥ 150 mg/dl)
    dplyr::pull(record_id)

#### Extract record IDs associated with antihypercholesterolemia drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C29454", "C66523_2", "C47529", "C61527", "C87471")) %>% distinct(drugs_sql, descriptive)
#>   A tibble: 5 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C87471    Ciprofibrato 100 mg (Comp.) removed
#> 2 C29454    Sinvastatina 20 mg (Comp.) 
#> 3 C66523_2  Rosuvastatina 10 mg (Comp.)
#> 4 C61527    Atorvastatina 40 mg (Comp.)
#> 5 C47529    Ezetimiba 10 mg  

hypertrigliceridemia_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C87471")
        ) %>% 
    dplyr::pull(record_id)

#### Extract record IDs associated with abnormal lab results on first lab
hypertrigliceridemia_labs <- data %>% 
    dplyr::filter(labs_triglycerides >= 150) %>% 
    dplyr::pull(record_id)

#### Assign hypercholesterolemia based on conditions, drugs, or first labs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(hypertrigliceridemia = 
               if_else(record_id %in% hypertrigliceridemia_conditions, 1, 
                       if_else(record_id %in% hypertrigliceridemia_drugs, 1,
                               if_else(record_id %in% hypertrigliceridemia_labs, 1, 0))))

rm(hypertrigliceridemia_conditions)
rm(hypertrigliceridemia_drugs)
rm(hypertrigliceridemia_labs)

```

4. Insulin resistance

```{r}

#### Extract record IDs associated with insulin resistance

insulin_conditions <- I21_conditions_R %>% 
    dplyr::filter(str_detect(common_comorbidities, "C113101|C26747")) %>%
    dplyr::pull(record_id)

#### Extract record IDs associated with anti-hyperglycemic / hypoglycemic drugs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61612", "C61612_2", "C87618", "C180533")) %>% distinct(drugs_sql, descriptive)
#> # A tibble: 4 × 2
#>   drugs_sql descriptive                         
#>   <chr>     <chr>                               
#> 1 C61612_2  Metformina 850 mg (Comp.) (Glifage) 
#> 2 C61612    Metformina 500 mg (Comp.) (Glifage) 
#> 3 C87618    Gliclazida 30 mg (Comp. de lib. pr.)
#> 4 C180533   Empagliflozin/Linagliptin (GLYXAMBI)

insulin_drugs <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61612|C61612_2|C87618|C180533"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign INSULIN RESISTANCE based on conditions or drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(insulin = if_else(
        record_id %in% insulin_conditions, 
        1, 
        if_else(
            record_id %in% insulin_drugs, 
            1, 
            0
        )
    ))

rm(insulin_conditions)
rm(insulin_drugs)
```

5. Drugs that might induce weight loss

```{r}
### 9.3.4 DRUGS THAT MIGHT INDUCE WEIGHT LOSS
#### Extract record IDs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61939", "C62012", "C506_1", "C1278_2", "C1278_1", "C1278_3", "C47764_1", "C47764_2", "C61680")) %>% distinct(drugs_sql, descriptive)

#> # A tibble: 9 × 2
#>   drugs_sql descriptive                
#>   <chr>     <chr>                      
#> 1 C61939    Sertralina 50 mg (Comp.)   
#> 2 C47764_2  Topiramato 50 mg (Comp.)   
#> 3 C62012    Bupropiona 150 mg (Comp.)  
#> 4 C47764_1  Topiramato 25 mg (Comp.)   
#> 5 C61680    Citalopram 20 mg (Comp.)   
#> 6 C506_1    Fluoxetina 20 mg (Cáps.)   
#> 7 C1278_2   Venlafaxina 75 mg (Caps.)  
#> 8 C1278_1   Venlafaxina 37,5 mg (Caps.)
#> 9 C1278_3   Venlafaxina 150 mg (Cáps.) 

drugs_w_loss <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61939|C62012|C506_1|C1278_2|C1278_1|C1278_3|C47764_1|C47764_2|C61680"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign drugs_w_loss based on drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(drugs_w_loss = if_else(
        record_id %in% drugs_w_loss, 1, 0)
    )

rm(drugs_w_loss)
```

6. Drugs that might induce weight gain

```{r}
### DRUGS THAT MIGHT INDUCE WEIGHT GAIN

#### Extract record IDs

# I22_drugs_R %>% filter(drugs_sql %in% c("C61879", "C62005", "C61917_2", "C29416", "C29536_2")) %>% distinct(drugs_sql, descriptive)
#> # A tibble: 5 × 2
#>   drugs_sql descriptive                   
#>   <chr>     <chr>                         
#> 1 C62005    Amitriptilina 25 mg (Comp.)   
#> 2 C61879    Paroxetina 20 mg (Comp.)      
#> 3 C29536_2  Ácido Valpróico 250 mg (Cáps.)
#> 4 C29416    Risperidona 2 mg (Comp.)      
#> 5 C61917_2  Quetiapina 50 mg (Comp.)    

drugs_w_gain <- I22_drugs_R %>% 
    dplyr::filter(str_detect(drugs_sql, 
        "C61879|C62005|C61917_2|C29416|C29536_2"
        )
        ) %>% 
    dplyr::pull(record_id)

#### Assign drugs_w_loss based on drugs
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(drugs_w_gain = if_else(
        record_id %in% drugs_w_gain, 1, 0)
    )

rm(drugs_w_gain)

```

**Wrapping up `data_d1_exclusive`**

```{r}
data_d1_exclusive <- label_choices(data_d1_exclusive, codebook_dvep)
data_d1_exclusive <- convert_col_type(data_d1_exclusive, codebook_dvep)
data_d1_exclusive <- data_d1_exclusive %>% 
    dplyr::mutate(
        hypertension = as.factor(hypertension),
        hypercholesterolemia = as.factor(hypercholesterolemia),
        hypertrigliceridemia = as.factor(hypertrigliceridemia),
        insulin = as.factor(insulin),
        drugs_w_loss = as.factor(drugs_w_loss),
        drugs_w_gain = as.factor(drugs_w_gain)
    )
data_d1_exclusive <- label_variables(data_d1_exclusive, codebook_dvep)

```

#### Lab exames

```{r}
I27_labs_R <- filter_data(c("V1","V2","V3"),1,"labs") %>% 
    dplyr::mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )%>% 
    select(-event_name, -repeat_instrument, -repeat_instance, -labs_checked_results_yn)

```

#### Compliance
```{r}
compliance_V2 <- data %>% 
    select(
        record_id, event_name,
        filter_variables("V2",1,"compliance")
        ) %>% 
    filter(event_name == "2visit_arm_1" & cp_compliance_complete == 2) %>% 
    left_join(data %>%
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) %>% 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) %>% 
    left_join(data %>%
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) %>% 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) %>% 
    rename(evaluation_date_2 = evaluation_date)

compliance_V3 <- data %>% 
    select(
        record_id, event_name,
        filter_variables("V3",,"compliance")
        ) %>% 
    filter(event_name == "3visit_arm_1" & cp_compliance_complete == 2) %>% 
    left_join(data %>%
                  filter(event_name == "eleg_arm_1" & !is.na(intervention_start_date)) %>% 
                  select(record_id,intervention_start_date, conclusion_date),
              by = join_by(record_id)
              ) %>% 
    left_join(data %>%
                  filter(event_name == "2visit_arm_1" & !is.na(evaluation_date)) %>% 
                  select(record_id,evaluation_date),
              by = join_by(record_id)
        ) %>% 
    rename(evaluation_date_2 = evaluation_date)

I29_compliance <- bind_rows(
    compliance_V2,compliance_V3
) %>% 
    mutate(
        record_id = as.integer(record_id)
    ) %>% 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
    ) %>% 
    arrange(record_id,visit) %>% 
    select(record_id, visit, intervention_start_date, evaluation_date_2, conclusion_date, cp_taking_as_directed_yn, cp_schedule, cp_schedule_other, cp_missed_dose_yn, cp_missed_dose_count, cp_discontinued_yn, cp_discontinued_n_days, cp_discontinued_reason_other, cp_ran_out_of_drug_yn, cp_ran_out_reason, cp_perceived_improvement_yn, cp_perceived_improvement, cp_medication_confidence_scale, cp_self_reported_compliance_rate)  %>% 
    convert_col_type()

rm(compliance_V2)
rm(compliance_V3)

I29_compliance <- label_variables(I29_compliance, codebook_dvep)
I29_compliance <- label_choices(I29_compliance, codebook_dvep)

```

#### Adverse events
```{r}
I30_events_R <- filter_data(,1,"events") %>% 
    filter(
        cp_adverse_event_this_cycle_yn == 1
    ) %>%
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "2visit_arm_1"    ~ 2,
            event_name == "3visit_arm_1"    ~ 3
        ),
        .after = record_id
        )%>% 
    select(-event_name, -repeat_instrument, -cp_additional_adverse_events_yn,  -cp_adverse_event_this_cycle_yn)

I30_events_R <- label_variables(I30_events_R, codebook_dvep)
I30_events_R <- label_choices(I30_events_R, codebook_dvep) 
```

### NON-REPEATING INSTRUMENTS

#### RELEVANT VARIABLES FROM V1 & V3
```{r}
# Non-repeating data common to V1 and V3 (`d1d3`)
# calculate mean of handgrip strenght
# select relevant variables

d1d3 <- filter_data(c("V1","V3"),0) %>% 
    mutate(
        handgrip = if_else(
            is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
            NA_real_,  # Leave blank (NA) if both are missing
            if_else(
                !is.na(handgrip_right_mean) & is.na(handgrip_left_mean),
                handgrip_right_mean,  # Use the right hand value if left is missing
                if_else(
                    is.na(handgrip_right_mean) & !is.na(handgrip_left_mean),
                    handgrip_left_mean,  # Use the left hand value if right is missing
                    rowMeans(cbind(handgrip_right_mean, handgrip_left_mean), na.rm = TRUE)  # Calculate mean if both are present
                    )
                )
            )
        ) %>% 
    mutate(
        visit = case_when(
            event_name == "1visit_arm_1"    ~ 1,
            event_name == "3visit_arm_1"    ~ 3
        )
    ) %>% 
    select(
        record_id, visit,
        whoqol_score_overall, # 4. whoqol
        dass_score_depression:ecap_score, # 5. dass, 6. ecap
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        time_fasted_food, time_fasted_liquid, resistance, reactance, phase_angle, # 10. bia
        handgrip, # 11. handgrip
        # 12. eliminations
        evs_score, # 14. evs
        alcohol_dose, alcohol_significant, # 15. alcohol
        smoke_history, pack_years,  # 16. tobacco
        carbs_kcal, protein_kcal, fat_kcal, # 18. intake
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered, # 31. medical
        # April 19th, 2025: since we are simplifying BIA data and using collected variables on REDCAP:
        # 10. BIA
        phase_angle, resistance, reactance, smoked_24h_yn, exercised_24h_yn, alcohol_24h_yn, light_clothes_yn, time_fasted_food, time_fasted_liquid)
```

#### RELEVANT VARIABLES FROM V2

```{r}
##Non-repeating data from the second visit

d2 <- filter_data("V2",0) %>% 
    mutate(
        visit = case_when(
            event_name == "2visit_arm_1"    ~ 2
        )
    ) %>% 
    select(
        record_id, visit,
        height, weight, abdomen, arm, bmi, # 7. measures
        mean_bp_mean, # 9. bp 
        # 12. eliminations
        evs_score, # 14. evs
        drugs_dose_change_yn, drugs_dose_change_notes, # 31. medical
        intervention_prevention_reason_yn, # 31. medical
        specify_intervention_prevention_reasons, # 31. medical
        intervention_delivered_yn, # 31. medical
        explain_intervention_not_delivered # 31. medical
        )
```

### JOINS

#### bind_rows() from `d1d3` and `d2` to create `data_filtered`

```{r}
## 9.6 Bind rows for non-repeating variables from D1/D2/D3
data_filtered <- bind_rows(
    d1d3,d2
) %>% 
    mutate(
        record_id = as.integer(record_id),
        visit = as.integer(visit)
) %>% 
    arrange(
        record_id, visit
    ) %>% 
    convert_col_type()

rm(d1d3)
rm(d2)
```

#### left_join() to `data_filtered`

```{r}

# COMPLIANCE DATA
data_filtered <- data_filtered %>% 
    left_join(
        I29_compliance,
        by = join_by(record_id, visit)
    )

# data_d1_exclusive
data_filtered <- data_d1_exclusive %>% 
    right_join(
        data_filtered,
        by = join_by(record_id)
    ) %>% 
    relocate(
        visit,
        .after = record_id
    )

# LAB EXAMS
data_filtered <- data_filtered %>% 
    left_join(I27_labs_R,
              by = join_by(record_id, visit)
    )

data_filtered <- label_variables(data_filtered, codebook_dvep)
data_filtered <- data_filtered %>% 
    mutate(
        visit = as.integer(visit)
    )
```

#### left_join() **SECA BIA DATA** to `data_filtered_seca`
```{r}
data_filtered_seca <- data_filtered %>% 
    left_join(
        data_bia %>% 
            select(
                record_id, visit,
                phaseangle, raverage, xcaverage, 
                weight, height, waist, pal, bmi, 
                fmi, ffmi, vat,
                w_tbw, w_ecw
            ),
        by = join_by(record_id, visit)
    )

```

## EXPORT TIBBLES

### To RDS
```{r}
output_dir <- "Data_processed"

saveRDS(data,                file.path(output_dir, "data.rds"))
saveRDS(data_bia,            file.path(output_dir, "data_bia.rds"))
saveRDS(data_bia_D1,         file.path(output_dir, "data_bia_D1.rds"))
saveRDS(data_bia_D1_mean,    file.path(output_dir, "data_bia_D1_mean.rds"))
saveRDS(data_bia_D1_raw,     file.path(output_dir, "data_bia_D1_raw.rds"))
saveRDS(data_bia_D3,         file.path(output_dir, "data_bia_D3.rds"))
saveRDS(data_bia_D3_mean,    file.path(output_dir, "data_bia_D3_mean.rds"))
saveRDS(data_bia_D3_raw,     file.path(output_dir, "data_bia_D3_raw.rds"))
saveRDS(data_bia_mean,       file.path(output_dir, "data_bia_mean.rds"))
saveRDS(data_d1_exclusive,   file.path(output_dir, "data_d1_exclusive.rds"))
saveRDS(data_filtered,       file.path(output_dir, "data_filtered.rds"))
saveRDS(data_filtered_seca,  file.path(output_dir, "data_filtered_seca.rds"))

# Repeating instrument exports
saveRDS(I21_conditions_R,    file.path(output_dir, "I21_conditions_R.rds"))
saveRDS(I22_drugs_R,         file.path(output_dir, "I22_drugs_R.rds"))
saveRDS(I27_labs_R,          file.path(output_dir, "I27_labs_R.rds"))
saveRDS(I29_compliance,      file.path(output_dir, "I29_compliance.rds"))
saveRDS(I30_events_R,        file.path(output_dir, "I30_events_R.rds"))
```

### To CSV

```{r}
readr::write_csv(data,                file.path(output_dir, "data.csv"))
readr::write_csv(data_bia,            file.path(output_dir, "data_bia.csv"))
readr::write_csv(data_bia_D1,         file.path(output_dir, "data_bia_D1.csv"))
readr::write_csv(data_bia_D1_mean,    file.path(output_dir, "data_bia_D1_mean.csv"))
readr::write_csv(data_bia_D1_raw,     file.path(output_dir, "data_bia_D1_raw.csv"))
readr::write_csv(data_bia_D3,         file.path(output_dir, "data_bia_D3.csv"))
readr::write_csv(data_bia_D3_mean,    file.path(output_dir, "data_bia_D3_mean.csv"))
readr::write_csv(data_bia_D3_raw,     file.path(output_dir, "data_bia_D3_raw.csv"))
readr::write_csv(data_bia_mean,       file.path(output_dir, "data_bia_mean.csv"))
readr::write_csv(data_d1_exclusive,   file.path(output_dir, "data_d1_exclusive.csv"))
readr::write_csv(data_filtered,       file.path(output_dir, "data_filtered.csv"))
readr::write_csv(data_filtered_seca,  file.path(output_dir, "data_filtered_seca.csv"))

# Repeating instruments
readr::write_csv(I21_conditions_R,    file.path(output_dir, "I21_conditions_R.csv"))
readr::write_csv(I22_drugs_R,         file.path(output_dir, "I22_drugs_R.csv"))
readr::write_csv(I27_labs_R,          file.path(output_dir, "I27_labs_R.csv"))
readr::write_csv(I29_compliance,      file.path(output_dir, "I29_compliance.csv"))
readr::write_csv(I30_events_R,        file.path(output_dir, "I30_events_R.csv"))
```


# SUPERTIBBLE (`data_instruments`)
Creates a supertibble with one tibble for each instrument

```{r}
form_names <- unique(codebook_dvep$form_name_en)
form_names <- form_names[-2]

# Dynamically create the instruments list
instruments <- setNames(
    lapply(form_names, function(form_name) {
        filter_codebook(form_name, 0)$variable
    }),
    paste0("I", sprintf("%02d", seq_along(form_names)), "_", form_names)
)

# Estas variáveis não devem ser consideradas na verificação de dados faltantes (NA) porque sempre contêm informações.
always_present_vars <- c("record_id", "event_name", "repeat_instrument", "repeat_instance")

# Criar uma lista de tibbles separadas para cada instrumento, excluindo linhas que contenham apenas NAs
data_instruments <- lapply(names(instruments), function(instr_name) {
    
    # `instr_name` é o nome atual do instrumento sendo processado, por exemplo, "elegibility".
    
    # Seleciona a lista de variáveis associadas ao instrumento atual
    selected_vars <- instruments[[instr_name]]
    
    # Remove as variáveis da lista que estão em `always_present_vars` (que sempre possuem valores).
    # `setdiff()` retorna apenas as variáveis exclusivas (aquelas que não estão em `always_present_vars`).
    vars_to_check <- setdiff(selected_vars, always_present_vars)
    
    # Filtrar os dados para o instrumento atual
    filtered_tibble <- data  %>% 
        # Seleciona as colunas correspondentes às variáveis do instrumento atual
        select(all_of(selected_vars))  %>% 
        
        # Filtra as linhas onde pelo menos uma das variáveis relevantes (não constantes) não é NA
        filter(
            rowSums(
                !is.na(
                    select(cur_data(), all_of(vars_to_check)) # Seleciona apenas as colunas relevantes para a verificação de NA
                )
            ) > 0 # `rowSums()` conta quantas colunas não são NA por linha. Mantemos linhas onde este total é maior que 0.
        )
    
    # Retorna a tibble filtrada com as variáveis e linhas relevantes para o instrumento atual
    return(filtered_tibble)
})

# Nomeia os elementos da lista `data_instruments` com os nomes correspondentes dos instrumentos.
# Por exemplo, o primeiro elemento da lista será nomeado "redcap", o segundo "elegibility", e assim por diante.
names(data_instruments) <- names(instruments)

rm(always_present_vars)
rm(form_names)
rm(instruments)

# Opcional: Salvar cada tibble no ambiente global como um objeto independente.
# `list2env()` converte cada elemento da lista `data_instruments` em um objeto no ambiente global,
# com o nome correspondente ao instrumento.
#list2env(data_instruments, .GlobalEnv)

```

**EXPORT RDS**
```{r}
saveRDS(data_instruments, "Data_instruments/data_instruments.rds")
```

**EXPORT CSV**

```{r}
output_dir <- 'Data_instruments'

# Iterate over `data_instruments`
for (instr_name in names(data_instruments)) {
    # Create the file path for the current instrument
    file_path <- file.path(output_dir, paste0(instr_name, ".csv"))
    
    # Write the tibble to a CSV file
    write_csv(data_instruments[[instr_name]], file_path)
    
    # Print a message confirming the export
    message("Exported: ", file_path)
}

# Additional tibbles
# write_csv(data_bia, file.path(output_dir, "data_bia.csv"))
write_csv(data_d1_exclusive, file.path(output_dir, "data_d1_exclusive.csv"))
write_csv(data_filtered, file.path(output_dir, "data_filtered.csv"))

rm(output_dir)
rm(file_path)
rm(instr_name)
```

# DATA ANALYSIS

```{r}
library(skimr)
```


```{r, eval=FALSE, echo=FALSE}
## Simplifying Environment
## Optional
codebooks <- tibble(
    name = c("bia", "dvep", "ncit", "structure"),
    data = list(codebook_dvep, codebook_ncit, codebook_structure)
)

# Assign names to the `data` list-column
names(codebooks$data) <- codebooks$name

# Remove the individual tibbles from the environment
rm(codebook_bia, codebook_dvep, codebook_ncit, codebook_structure)

# Pull individual codebooks. You can pull each individual codebook by running:
# codebooks\$data[["bia"]]
# codebooks\$data[["dvep"]]
# codebooks\$data[["ncit"]]
# codebooks\$data[["structure"]]
```